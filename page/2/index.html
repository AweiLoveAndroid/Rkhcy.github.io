<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2" />






<meta name="description" content="Less is more">
<meta property="og:type" content="website">
<meta property="og:title" content="HuYounger&#39;s Note">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="HuYounger&#39;s Note">
<meta property="og:description" content="Less is more">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HuYounger&#39;s Note">
<meta name="twitter:description" content="Less is more">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>HuYounger's Note</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HuYounger's Note</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/05/2017 movie list/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/05/2017 movie list/" itemprop="url">2017 movie list</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-05T00:00:00+08:00">
                2017-05-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/05/2017 movie list/" class="leancloud_visitors" data-flag-title="2017 movie list">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>记忆大师</li>
<li>春娇救志明</li>
<li>看不见的客人</li>
<li>消失的爱人</li>
<li>沉默的羔羊</li>
<li>逃出绝命镇</li>
<li>窃听风暴</li>
<li>美丽人生</li>
<li>恐怖游轮</li>
<li>宿醉1-3</li>
<li>玩命记忆</li>
<li>迷雾</li>
<li>致命ID</li>
<li>空中营救</li>
<li>摔跤吧爸爸</li>
<li>黄海</li>
<li>我是谁：没有绝对安全的系统</li>
<li>非凡任务</li>
<li>汉江怪物</li>
<li>龙之吻</li>
<li>敢死队1-2</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/30/2017 book list/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/30/2017 book list/" itemprop="url">2017 book list</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-30T00:00:00+08:00">
                2017-04-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/04/30/2017 book list/" class="leancloud_visitors" data-flag-title="2017 book list">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>明朝那些事(1-7)(Done)</li>
<li>网络是怎样连接的(Pending)</li>
<li>Android高级进阶(Pending)</li>
<li>Zero To One(Done)</li>
<li>算法图解(Done)</li>
<li>Android源码设计模式解析与实战(Pending)</li>
<li>腾讯传(Done)</li>
<li>追风筝的人(Done)</li>
<li>月亮和六便士(Done)</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/28/Android Activity事件分发机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/28/Android Activity事件分发机制/" itemprop="url">Android Activity事件分发机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-28T00:00:00+08:00">
                2017-04-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/04/28/Android Activity事件分发机制/" class="leancloud_visitors" data-flag-title="Android Activity事件分发机制">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>平时使用的ViewGroup或View等控件都是包含在Activity中，那么它们三者事件分发顺序又是怎样的？</p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>MainActivity.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends AppCompatActivity implements View.OnClickListener,View.OnTouchListener &#123;</div><div class="line"></div><div class="line">    private MyLayout myLayout;</div><div class="line">    private MyView myView;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        myLayout = (MyLayout) findViewById(R.id.my_layout);</div><div class="line">        myView = (MyView) findViewById(R.id.my_view);</div><div class="line"></div><div class="line">        myLayout.setOnClickListener(this);</div><div class="line">        myLayout.setOnTouchListener(this);</div><div class="line"></div><div class="line">        myView.setOnClickListener(this);</div><div class="line">        myView.setOnTouchListener(this);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onClick(View v) &#123;</div><div class="line">        switch (v.getId()) &#123;</div><div class="line">            case R.id.my_layout:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout onClick&quot;);</div><div class="line">                break;</div><div class="line">            case R.id.my_view:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyView onClick&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;Activity dispatchTouchEvent ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;Activity dispatchTouchEvent ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;Activity dispatchTouchEvent ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.dispatchTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onUserInteraction() &#123;</div><div class="line">        Log.d(&quot;hcy&quot;, &quot;Activity onUserInteraction run&quot;);</div><div class="line">        super.onUserInteraction();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouch(View v, MotionEvent event) &#123;</div><div class="line">        switch (v.getId()) &#123;</div><div class="line">            case R.id.my_layout:</div><div class="line">                switch (event.getAction()) &#123;</div><div class="line">                    case MotionEvent.ACTION_DOWN:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyLayout onTouch ACTION_DOWN&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_MOVE:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyLayout onTouch ACTION_MOVE&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_UP:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyLayout onTouch ACTION_UP&quot;);</div><div class="line">                        break;</div><div class="line">                    default:</div><div class="line">                        break;</div><div class="line">                &#125;</div><div class="line">                break;</div><div class="line">            case R.id.my_view:</div><div class="line">                switch (event.getAction()) &#123;</div><div class="line">                    case MotionEvent.ACTION_DOWN:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyView onTouch ACTION_DOWN&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_MOVE:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyView onTouch ACTION_MOVE&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_UP:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyView onTouch ACTION_UP&quot;);</div><div class="line">                        break;</div><div class="line">                    default:</div><div class="line">                        break;</div><div class="line">                &#125;</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MyLayout.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by hcy on 17-4-26.</div><div class="line"> */</div><div class="line"></div><div class="line">public class MyLayout extends LinearLayout &#123;</div><div class="line">    public MyLayout(Context context) &#123;</div><div class="line">        super(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public MyLayout(Context context, AttributeSet attrs) &#123;</div><div class="line">        super(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public MyLayout(Context context, AttributeSet attrs, int defStyleAttr) &#123;</div><div class="line">        super(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onInterceptTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout onInterceptTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout onInterceptTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout onInterceptTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onInterceptTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">        switch (event.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout onTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout onTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout onTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onTouchEvent(event);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout dispatchTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout dispatchTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout dispatchTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.dispatchTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MyView.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by hcy on 17-4-26.</div><div class="line"> */</div><div class="line"></div><div class="line">public class MyView extends TextView &#123;</div><div class="line">    public MyView(Context context) &#123;</div><div class="line">        super(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public MyView(Context context, AttributeSet attrs) &#123;</div><div class="line">        super(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public MyView(Context context, AttributeSet attrs, int defStyleAttr) &#123;</div><div class="line">        super(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">        switch (event.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyView onTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyView onTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyView onTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onTouchEvent(event);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyView dispatchTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyView dispatchTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyView dispatchTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.dispatchTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>activity_main.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;com.example.hcy.activityevent.MyLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:id=&quot;@+id/my_layout&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    tools:context=&quot;com.example.hcy.activityevent.MainActivity&quot;&gt;</div><div class="line"></div><div class="line">    &lt;com.example.hcy.activityevent.MyView</div><div class="line">        android:id=&quot;@+id/my_view&quot;</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;Hello World!&quot; /&gt;</div><div class="line">&lt;/com.example.hcy.activityevent.MyLayout&gt;</div></pre></td></tr></table></figure>
<p>代码很简单，运行点击MyView，log打印如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">03-02 00:18:04.596 15312 15312 D hcy     : Activity dispatchTouchEvent ACTION_DOWN</div><div class="line">03-02 00:18:04.597 15312 15312 D hcy     : Activity onUserInteraction run</div><div class="line">03-02 00:18:04.597 15312 15312 D hcy     : MyLayout dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-02 00:18:04.597 15312 15312 D hcy     : MyLayout onInterceptTouchEvent: ACTION_DOWN</div><div class="line">03-02 00:18:04.597 15312 15312 D hcy     : MyView dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-02 00:18:04.597 15312 15312 D hcy     : MyView onTouch ACTION_DOWN</div><div class="line">03-02 00:18:04.597 15312 15312 D hcy     : MyView onTouchEvent: ACTION_DOWN</div><div class="line">03-02 00:18:04.645 15312 15312 D hcy     : Activity dispatchTouchEvent ACTION_UP</div><div class="line">03-02 00:18:04.645 15312 15312 D hcy     : MyLayout dispatchTouchEvent: ACTION_UP</div><div class="line">03-02 00:18:04.645 15312 15312 D hcy     : MyLayout onInterceptTouchEvent: ACTION_UP</div><div class="line">03-02 00:18:04.645 15312 15312 D hcy     : MyView dispatchTouchEvent: ACTION_UP</div><div class="line">03-02 00:18:04.645 15312 15312 D hcy     : MyView onTouch ACTION_UP</div><div class="line">03-02 00:18:04.645 15312 15312 D hcy     : MyView onTouchEvent: ACTION_UP</div><div class="line">03-02 00:18:04.647 15312 15312 D hcy     : MyView onClick</div></pre></td></tr></table></figure>
<p>发现DOWN事件触发后最先经过Activity的dispatchTouchEvent方法，再由ViewGroup到View派发，ViewGroup到View的那一套流程之前已经分析过了，这里在DOWN的时候还调用了onUserInteraction 方法，而UP的时候并没有调用</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>查看Activity的dispatchTouchEvent 方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Called to process touch screen events.  You can override this to</div><div class="line"> * intercept all touch screen events before they are dispatched to the</div><div class="line"> * window.  Be sure to call this implementation for touch screen events</div><div class="line"> * that should be handled normally.</div><div class="line"> *</div><div class="line"> * @param ev The touch screen event.</div><div class="line"> *</div><div class="line"> * @return boolean Return true if this event was consumed.</div><div class="line"> */</div><div class="line">public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">    if (ev.getAction() == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">        onUserInteraction();</div><div class="line">    &#125;</div><div class="line">    if (getWindow().superDispatchTouchEvent(ev)) &#123;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">    return onTouchEvent(ev);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里看到第一个语句如果是DOWN事件，会执行onUserInteraction()方法，查看onUserInteraction方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Called whenever a key, touch, or trackball event is dispatched to the</div><div class="line"> * activity.  Implement this method if you wish to know that the user has</div><div class="line"> * interacted with the device in some way while your activity is running.</div><div class="line"> * This callback and &#123;@link #onUserLeaveHint&#125; are intended to help</div><div class="line"> * activities manage status bar notifications intelligently; specifically,</div><div class="line"> * for helping activities determine the proper time to cancel a notfication.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;All calls to your activity&apos;s &#123;@link #onUserLeaveHint&#125; callback will</div><div class="line"> * be accompanied by calls to &#123;@link #onUserInteraction&#125;.  This</div><div class="line"> * ensures that your activity will be told of relevant user activity such</div><div class="line"> * as pulling down the notification pane and touching an item there.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Note that this callback will be invoked for the touch down action</div><div class="line"> * that begins a touch gesture, but may not be invoked for the touch-moved</div><div class="line"> * and touch-up actions that follow.</div><div class="line"> *</div><div class="line"> * @see #onUserLeaveHint()</div><div class="line"> */</div><div class="line">public void onUserInteraction() &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法是个空方法，没用过暂时还不清楚是干嘛的，从注释大致介绍该方法可以帮助activity智能管理状态栏上的通知，例如在适当的时候删除通知。</p>
<p>继续回到前面分析，第二个if判断语句判断getWindow().superDispatchTouchEvent(ev)的返回值，若为true则返回true，反正返回activity自身的onTouchEvent(ev)。<br>Activity中的getWindow()方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Retrieve the current &#123;@link android.view.Window&#125; for the activity.</div><div class="line"> * This can be used to directly access parts of the Window API that</div><div class="line"> * are not available through Activity/Screen.</div><div class="line"> *</div><div class="line"> * @return Window The current window, or null if the activity is not</div><div class="line"> *         visual.</div><div class="line"> */</div><div class="line">public Window getWindow() &#123;</div><div class="line">    return mWindow;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的mWindow是Window的一个实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">private Window mWindow;</div></pre></td></tr></table></figure>
<p>而它的实例化是在Activity的attach方法中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">final void attach(Context context, ActivityThread aThread,</div><div class="line">        Instrumentation instr, IBinder token, int ident,</div><div class="line">        Application application, Intent intent, ActivityInfo info,</div><div class="line">        CharSequence title, Activity parent, String id,</div><div class="line">        NonConfigurationInstances lastNonConfigurationInstances,</div><div class="line">        Configuration config, String referrer, IVoiceInteractor voiceInteractor,</div><div class="line">        Window window) &#123;</div><div class="line">    attachBaseContext(context);</div><div class="line"></div><div class="line">    mFragments.attachHost(null /*parent*/);</div><div class="line"></div><div class="line">    mWindow = new PhoneWindow(this, window);</div><div class="line">    mWindow.setWindowControllerCallback(this);</div><div class="line">    mWindow.setCallback(this);</div><div class="line">    mWindow.setOnWindowDismissedCallback(this);</div><div class="line">    mWindow.getLayoutInflater().setPrivateFactory(this);</div><div class="line">    if (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) &#123;</div><div class="line">        mWindow.setSoftInputMode(info.softInputMode);</div><div class="line">    &#125;</div><div class="line">    if (info.uiOptions != 0) &#123;</div><div class="line">        mWindow.setUiOptions(info.uiOptions);</div><div class="line">    &#125;</div><div class="line">    mUiThread = Thread.currentThread();</div><div class="line"></div><div class="line">    mMainThread = aThread;</div><div class="line">    mInstrumentation = instr;</div><div class="line">    mToken = token;</div><div class="line">    mIdent = ident;</div><div class="line">    mApplication = application;</div><div class="line">    mIntent = intent;</div><div class="line">    mReferrer = referrer;</div><div class="line">    mComponent = intent.getComponent();</div><div class="line">    mActivityInfo = info;</div><div class="line">    mTitle = title;</div><div class="line">    mParent = parent;</div><div class="line">    mEmbeddedID = id;</div><div class="line">    mLastNonConfigurationInstances = lastNonConfigurationInstances;</div><div class="line">    if (voiceInteractor != null) &#123;</div><div class="line">        if (lastNonConfigurationInstances != null) &#123;</div><div class="line">            mVoiceInteractor = lastNonConfigurationInstances.voiceInteractor;</div><div class="line">        &#125; else &#123;</div><div class="line">            mVoiceInteractor = new VoiceInteractor(voiceInteractor, this, this,</div><div class="line">                    Looper.myLooper());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mWindow.setWindowManager(</div><div class="line">            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</div><div class="line">            mToken, mComponent.flattenToString(),</div><div class="line">            (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0);</div><div class="line">    if (mParent != null) &#123;</div><div class="line">        mWindow.setContainer(mParent.getWindow());</div><div class="line">    &#125;</div><div class="line">    mWindowManager = mWindow.getWindowManager();</div><div class="line">    mCurrentConfig = config;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Window是个抽象类，通过new PhoneWindow实例化mWindow，因此去PhoneWindow类中查看superDispatchTouchEvent方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public boolean superDispatchTouchEvent(MotionEvent event) &#123;</div><div class="line">    return mDecor.superDispatchTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里把皮球踢给了mDecor，那mDecor又是啥呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">private final class DecorView extends FrameLayout implements RootViewSurfaceTaker</div></pre></td></tr></table></figure>
<p>DecorView是PhoneWindow的一个内部类，并且是FrameLayout的子类，而FrameLayout是ViewGroup的子类，因此DecorView也是个ViewGroup，看下它里面的superDispatchTouchEvent方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public boolean superDispatchTouchEvent(MotionEvent event) &#123;</div><div class="line">    return super.dispatchTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>原来到头来是调用ViewGroup的dispatchTouchEvent方法，接下来就是ViewGroup的那一套流程，上一篇已经分析过了。<br>另外通过SDK下的hierarchyviewer工具可以查看当前进程的UI层级</p>
<p><a href="http://upload-images.jianshu.io/upload_images/989851-eafe6ca9ebbf7131.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-eafe6ca9ebbf7131.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="hierarchyviewer1.png"></a><br><a href="http://upload-images.jianshu.io/upload_images/989851-c8114f19d488bdaf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-c8114f19d488bdaf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="hierarchyviewer2.png"></a><br>可以看到自定义的LinearLayout被放在一个id为content的FrameLayout里。</p>
<p>回过头来继续看下Activity中onTouchEvent方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Called when a touch screen event was not handled by any of the views</div><div class="line"> * under it.  This is most useful to process touch events that happen</div><div class="line"> * outside of your window bounds, where there is no view to receive it.</div><div class="line"> *</div><div class="line"> * @param event The touch screen event being processed.</div><div class="line"> *</div><div class="line"> * @return Return true if you have consumed the event, false if you haven&apos;t.</div><div class="line"> * The default implementation always returns false.</div><div class="line"> */</div><div class="line">public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">    if (mWindow.shouldCloseOnTouch(this, event)) &#123;</div><div class="line">        finish();</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从注解可以大致了解该方法的作用：<br>该方法被调用当一个触摸屏幕的事件未被Activity下任何一个View处理，这对于处理发生在Window边界外的触摸事件是很有用的，因为没有View可以接收到事件，返回true代表消费事件，false表示未消费，默认返回false。<br>看下if判断，在PhoneWindow未中找到shouldCloseOnTouch方法，那就去它爹里面找</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/** @hide */</div><div class="line">public boolean shouldCloseOnTouch(Context context, MotionEvent event) &#123;</div><div class="line">    if (mCloseOnTouchOutside &amp;&amp; event.getAction() == MotionEvent.ACTION_DOWN</div><div class="line">            &amp;&amp; isOutOfBounds(context, event) &amp;&amp; peekDecorView() != null) &#123;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面主要是判断mCloseOnTouchOutside的值，当前的是否是DOWN事件，event的坐标是否在边界内，DecorView是否为null，这些主要是对于处理边界外touch的判断。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>1.触摸屏幕的事件首先会经过Activity的dispatchTouchEvent方法，如果是DOWN，会调用onUserInteraction方法，Activity分发事件本质与ViewGroup相同，因为Activity的root view是一个继承自FrameLayout的ViewGroup，再调用ViewGroup的dispatchTouchEvent方法分发到处理该事件的子View。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/26/Android ViewGroup事件分发机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/26/Android ViewGroup事件分发机制/" itemprop="url">Android ViewGroup事件分发机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-26T00:00:00+08:00">
                2017-04-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/04/26/Android ViewGroup事件分发机制/" class="leancloud_visitors" data-flag-title="Android ViewGroup事件分发机制">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>接上篇继续分析Android中ViewGroup的事件分发机制,在分析之前先看一张官网ViewGroup的介绍图    <img src="http://7xjvg5.com1.z0.glb.clouddn.com/WechatIMG5.png" style="zoom:50%"></p>
<p>可以看到平时常用的那些布局如LinearLayout、FrameLayout等都是ViewGroup的子类,而ViewGroup是View的子类,API中也说了, ViewGroup是个可以包含其他View的特殊View。ViewGroup重写了dispatchTouchEvent,与View相比多了onInterceptTouchEvent方法用来判断是否拦截事件,onTouchEvent方法未重写和View保持一致。</p>
<h2 id="例子1"><a href="#例子1" class="headerlink" title="例子1"></a>例子1</h2><p>MainActiviy.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends AppCompatActivity implements View.OnClickListener,View.OnTouchListener&#123;</div><div class="line">    private SonView sonView;</div><div class="line">    private GrandView grandView;</div><div class="line">    private ParentView parentView;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        sonView = (SonView) findViewById(R.id.son);</div><div class="line">        parentView = (ParentView) findViewById(R.id.parent);</div><div class="line">        grandView = (GrandView) findViewById(R.id.grand);</div><div class="line"></div><div class="line">        sonView.setOnClickListener(this);</div><div class="line">        sonView.setOnTouchListener(this);</div><div class="line"></div><div class="line">        parentView.setOnClickListener(this);</div><div class="line">        parentView.setOnTouchListener(this);</div><div class="line"></div><div class="line">        grandView.setOnClickListener(this);</div><div class="line">        grandView.setOnTouchListener(this);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onClick(View v) &#123;</div><div class="line">        switch (v.getId()) &#123;</div><div class="line">            case R.id.grand:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView onClick&quot;);</div><div class="line">                break;</div><div class="line">            case R.id.parent:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView onClick&quot;);</div><div class="line">                break;</div><div class="line">            case R.id.son:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;SonView onClick&quot;);</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouch(View v, MotionEvent event) &#123;</div><div class="line">        switch (v.getId()) &#123;</div><div class="line">            case R.id.grand:</div><div class="line">                switch (event.getAction()) &#123;</div><div class="line">                    case MotionEvent.ACTION_DOWN:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;GrandView onTouch ACTION_DOWN&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_MOVE:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;GrandView onTouch ACTION_MOVE&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_UP:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;GrandView onTouch ACTION_UP&quot;);</div><div class="line">                        break;</div><div class="line">                    default:</div><div class="line">                        break;</div><div class="line">                &#125;</div><div class="line">                break;</div><div class="line">            case R.id.parent:</div><div class="line">                switch (event.getAction()) &#123;</div><div class="line">                    case MotionEvent.ACTION_DOWN:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;ParentView onTouch ACTION_DOWN&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_MOVE:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;ParentView onTouch ACTION_MOVE&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_UP:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;ParentView onTouch ACTION_UP&quot;);</div><div class="line">                        break;</div><div class="line">                    default:</div><div class="line">                        break;</div><div class="line">                &#125;</div><div class="line">                break;</div><div class="line">            case R.id.son:</div><div class="line">                switch (event.getAction()) &#123;</div><div class="line">                    case MotionEvent.ACTION_DOWN:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;SonView onTouch ACTION_DOWN&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_MOVE:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;SonView onTouch ACTION_MOVE&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_UP:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;SonView onTouch ACTION_UP&quot;);</div><div class="line">                        break;</div><div class="line">                    default:</div><div class="line">                        break;</div><div class="line">                &#125;</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>GrandView.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">public class GrandView extends LinearLayout &#123;</div><div class="line">    public GrandView(Context context) &#123;</div><div class="line">        super(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public GrandView(Context context, AttributeSet attrs) &#123;</div><div class="line">        super(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public GrandView(Context context, AttributeSet attrs, int defStyleAttr) &#123;</div><div class="line">        super(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">        switch (event.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView onTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView onTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView onTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onTouchEvent(event);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onInterceptTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView onInterceptTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView onInterceptTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView onInterceptTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onInterceptTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView dispatchTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView dispatchTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView dispatchTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.dispatchTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ParentView.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">public class ParentView extends LinearLayout &#123;</div><div class="line">    public ParentView(Context context) &#123;</div><div class="line">        super(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public ParentView(Context context, AttributeSet attrs) &#123;</div><div class="line">        super(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public ParentView(Context context, AttributeSet attrs, int defStyleAttr) &#123;</div><div class="line">        super(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onInterceptTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView onInterceptTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView onInterceptTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView onInterceptTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onInterceptTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">        switch (event.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView onTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView onTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView onTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onTouchEvent(event);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView dispatchTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView dispatchTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView dispatchTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.dispatchTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>SonView.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">public class SonView extends View &#123;</div><div class="line"></div><div class="line">    public SonView(Context context) &#123;</div><div class="line">        super(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public SonView(Context context, AttributeSet attrs) &#123;</div><div class="line">        super(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public SonView(Context context, AttributeSet attrs, int defStyleAttr) &#123;</div><div class="line">        super(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">        switch (event.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;SonView onTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;SonView onTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;SonView onTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onTouchEvent(event);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;SonView dispatchTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;SonView dispatchTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;SonView dispatchTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.dispatchTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>activity_main.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;FrameLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:id=&quot;@+id/activity_main&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    tools:context=&quot;com.example.hcy.event.MainActivity&quot;&gt;</div><div class="line">    &lt;com.example.hcy.event.view.GrandView</div><div class="line">        android:id=&quot;@+id/grand&quot;</div><div class="line">        android:background=&quot;@android:color/holo_orange_dark&quot;</div><div class="line">        android:gravity=&quot;center&quot;</div><div class="line">        android:layout_gravity=&quot;center&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot;&gt;</div><div class="line">        &lt;com.example.hcy.event.view.ParentView</div><div class="line">            android:id=&quot;@+id/parent&quot;</div><div class="line">            android:background=&quot;@android:color/holo_purple&quot;</div><div class="line">            android:gravity=&quot;center&quot;</div><div class="line">            android:layout_width=&quot;300dp&quot;</div><div class="line">            android:layout_height=&quot;300dp&quot;&gt;</div><div class="line">            &lt;com.example.hcy.event.view.SonView</div><div class="line">                android:id=&quot;@+id/son&quot;</div><div class="line">                android:layout_width=&quot;200dp&quot;</div><div class="line">                android:layout_height=&quot;200dp&quot;</div><div class="line">                android:background=&quot;@android:color/holo_green_dark&quot;</div><div class="line">                android:gravity=&quot;center&quot;/&gt;</div><div class="line">        &lt;/com.example.hcy.event.view.ParentView&gt;</div><div class="line">    &lt;/com.example.hcy.event.view.GrandView&gt;</div><div class="line"></div><div class="line">&lt;/FrameLayout&gt;</div></pre></td></tr></table></figure>
<p>点击中间的SonView，log打印如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">03-12 17:29:49.680 12809 12809 D hcy     : GrandView dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:29:49.680 12809 12809 D hcy     : GrandView onInterceptTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:29:49.680 12809 12809 D hcy     : ParentView dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:29:49.680 12809 12809 D hcy     : ParentView onInterceptTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:29:49.680 12809 12809 D hcy     : SonView dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:29:49.680 12809 12809 D hcy     : SonView onTouch ACTION_DOWN</div><div class="line">03-12 17:29:49.680 12809 12809 D hcy     : SonView onTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:29:49.709 12809 12809 D hcy     : GrandView dispatchTouchEvent: ACTION_UP</div><div class="line">03-12 17:29:49.709 12809 12809 D hcy     : GrandView onInterceptTouchEvent: ACTION_UP</div><div class="line">03-12 17:29:49.709 12809 12809 D hcy     : ParentView dispatchTouchEvent: ACTION_UP</div><div class="line">03-12 17:29:49.709 12809 12809 D hcy     : ParentView onInterceptTouchEvent: ACTION_UP</div><div class="line">03-12 17:29:49.709 12809 12809 D hcy     : SonView dispatchTouchEvent: ACTION_UP</div><div class="line">03-12 17:29:49.709 12809 12809 D hcy     : SonView onTouch ACTION_UP</div><div class="line">03-12 17:29:49.709 12809 12809 D hcy     : SonView onTouchEvent: ACTION_UP</div><div class="line">03-12 17:29:49.710 12809 12809 D hcy     : SonView onClick</div></pre></td></tr></table></figure>
<p>从上面的log中可以看出事件是先传递到最外层的ViewGroup，再由ViewGroup递归传递到消费事件的具体View。与ViewGroup相比，View中没有onInterceptTouchEvent方法，因此不存在拦截。</p>
<h2 id="例子2"><a href="#例子2" class="headerlink" title="例子2"></a>例子2</h2><p>将SonView的onTouchEvent方法返回值改为false。<br>点击SonView区域打印日志如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : GrandView dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : GrandView onInterceptTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : ParentView dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : ParentView onInterceptTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : SonView dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : SonView onTouch ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : SonView onTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : ParentView onTouch ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : ParentView onTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:43:49.278 12809 12809 D hcy     : GrandView dispatchTouchEvent: ACTION_UP</div><div class="line">03-12 17:43:49.278 12809 12809 D hcy     : GrandView onInterceptTouchEvent: ACTION_UP</div><div class="line">03-12 17:43:49.278 12809 12809 D hcy     : ParentView dispatchTouchEvent: ACTION_UP</div><div class="line">03-12 17:43:49.278 12809 12809 D hcy     : ParentView onTouch ACTION_UP</div><div class="line">03-12 17:43:49.278 12809 12809 D hcy     : ParentView onTouchEvent: ACTION_UP</div><div class="line">03-12 17:43:49.279 12809 12809 D hcy     : ParentView onClick</div></pre></td></tr></table></figure>
<p>对比之前的log，DOWN的时候在SonView执行完onTouchEvent方法后，又执行了ParentView 的onTouch和onTouchEvent 方法，并且在UP的时候ParentView 不再执行onInterceptTouchEvent 方法，后面SonView不再接收UP事件。</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>查看ViewGroup中的dispatchTouchEvent方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">    if (mInputEventConsistencyVerifier != null) &#123;</div><div class="line">        mInputEventConsistencyVerifier.onTouchEvent(ev, 1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // If the event targets the accessibility focused view and this is it, start</div><div class="line">    // normal event dispatch. Maybe a descendant is what will handle the click.</div><div class="line">    if (ev.isTargetAccessibilityFocus() &amp;&amp; isAccessibilityFocusedViewOrHost()) &#123;</div><div class="line">        ev.setTargetAccessibilityFocus(false);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    boolean handled = false;</div><div class="line">    if (onFilterTouchEventForSecurity(ev)) &#123;</div><div class="line">        final int action = ev.getAction();</div><div class="line">        final int actionMasked = action &amp; MotionEvent.ACTION_MASK;</div><div class="line"></div><div class="line">        // Handle an initial down.</div><div class="line">        if (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">            // Throw away all previous state when starting a new touch gesture.</div><div class="line">            // The framework may have dropped the up or cancel event for the previous gesture</div><div class="line">            // due to an app switch, ANR, or some other state change.</div><div class="line">            cancelAndClearTouchTargets(ev);</div><div class="line">            resetTouchState();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Check for interception.</div><div class="line">        final boolean intercepted;</div><div class="line">        if (actionMasked == MotionEvent.ACTION_DOWN</div><div class="line">                || mFirstTouchTarget != null) &#123;</div><div class="line">            final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0;</div><div class="line">            if (!disallowIntercept) &#123;</div><div class="line">                intercepted = onInterceptTouchEvent(ev);</div><div class="line">                ev.setAction(action); // restore action in case it was changed</div><div class="line">            &#125; else &#123;</div><div class="line">                intercepted = false;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            // There are no touch targets and this action is not an initial down</div><div class="line">            // so this view group continues to intercept touches.</div><div class="line">            intercepted = true;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // If intercepted, start normal event dispatch. Also if there is already</div><div class="line">        // a view that is handling the gesture, do normal event dispatch.</div><div class="line">        if (intercepted || mFirstTouchTarget != null) &#123;</div><div class="line">            ev.setTargetAccessibilityFocus(false);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Check for cancelation.</div><div class="line">        final boolean canceled = resetCancelNextUpFlag(this)</div><div class="line">                || actionMasked == MotionEvent.ACTION_CANCEL;</div><div class="line"></div><div class="line">        // Update list of touch targets for pointer down, if needed.</div><div class="line">        final boolean split = (mGroupFlags &amp; FLAG_SPLIT_MOTION_EVENTS) != 0;</div><div class="line">        TouchTarget newTouchTarget = null;</div><div class="line">        boolean alreadyDispatchedToNewTouchTarget = false;</div><div class="line">        if (!canceled &amp;&amp; !intercepted) &#123;</div><div class="line"></div><div class="line">            // If the event is targeting accessiiblity focus we give it to the</div><div class="line">            // view that has accessibility focus and if it does not handle it</div><div class="line">            // we clear the flag and dispatch the event to all children as usual.</div><div class="line">            // We are looking up the accessibility focused host to avoid keeping</div><div class="line">            // state since these events are very rare.</div><div class="line">            View childWithAccessibilityFocus = ev.isTargetAccessibilityFocus()</div><div class="line">                    ? findChildWithAccessibilityFocus() : null;</div><div class="line"></div><div class="line">            if (actionMasked == MotionEvent.ACTION_DOWN</div><div class="line">                    || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN)</div><div class="line">                    || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</div><div class="line">                final int actionIndex = ev.getActionIndex(); // always 0 for down</div><div class="line">                final int idBitsToAssign = split ? 1 &lt;&lt; ev.getPointerId(actionIndex)</div><div class="line">                        : TouchTarget.ALL_POINTER_IDS;</div><div class="line"></div><div class="line">                // Clean up earlier touch targets for this pointer id in case they</div><div class="line">                // have become out of sync.</div><div class="line">                removePointersFromTouchTargets(idBitsToAssign);</div><div class="line"></div><div class="line">                final int childrenCount = mChildrenCount;</div><div class="line">                if (newTouchTarget == null &amp;&amp; childrenCount != 0) &#123;</div><div class="line">                    final float x = ev.getX(actionIndex);</div><div class="line">                    final float y = ev.getY(actionIndex);</div><div class="line">                    // Find a child that can receive the event.</div><div class="line">                    // Scan children from front to back.</div><div class="line">                    final ArrayList&lt;View&gt; preorderedList = buildTouchDispatchChildList();</div><div class="line">                    final boolean customOrder = preorderedList == null</div><div class="line">                            &amp;&amp; isChildrenDrawingOrderEnabled();</div><div class="line">                    final View[] children = mChildren;</div><div class="line">                    for (int i = childrenCount - 1; i &gt;= 0; i--) &#123;</div><div class="line">                        final int childIndex = getAndVerifyPreorderedIndex(</div><div class="line">                                childrenCount, i, customOrder);</div><div class="line">                        final View child = getAndVerifyPreorderedView(</div><div class="line">                                preorderedList, children, childIndex);</div><div class="line"></div><div class="line">                        // If there is a view that has accessibility focus we want it</div><div class="line">                        // to get the event first and if not handled we will perform a</div><div class="line">                        // normal dispatch. We may do a double iteration but this is</div><div class="line">                        // safer given the timeframe.</div><div class="line">                        if (childWithAccessibilityFocus != null) &#123;</div><div class="line">                            if (childWithAccessibilityFocus != child) &#123;</div><div class="line">                                continue;</div><div class="line">                            &#125;</div><div class="line">                            childWithAccessibilityFocus = null;</div><div class="line">                            i = childrenCount - 1;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        if (!canViewReceivePointerEvents(child)</div><div class="line">                                || !isTransformedTouchPointInView(x, y, child, null)) &#123;</div><div class="line">                            ev.setTargetAccessibilityFocus(false);</div><div class="line">                            continue;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        newTouchTarget = getTouchTarget(child);</div><div class="line">                        if (newTouchTarget != null) &#123;</div><div class="line">                            // Child is already receiving touch within its bounds.</div><div class="line">                            // Give it the new pointer in addition to the ones it is handling.</div><div class="line">                            newTouchTarget.pointerIdBits |= idBitsToAssign;</div><div class="line">                            break;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        resetCancelNextUpFlag(child);</div><div class="line">                        if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) &#123;</div><div class="line">                            // Child wants to receive touch within its bounds.</div><div class="line">                            mLastTouchDownTime = ev.getDownTime();</div><div class="line">                            if (preorderedList != null) &#123;</div><div class="line">                                // childIndex points into presorted list, find original index</div><div class="line">                                for (int j = 0; j &lt; childrenCount; j++) &#123;</div><div class="line">                                    if (children[childIndex] == mChildren[j]) &#123;</div><div class="line">                                        mLastTouchDownIndex = j;</div><div class="line">                                        break;</div><div class="line">                                    &#125;</div><div class="line">                                &#125;</div><div class="line">                            &#125; else &#123;</div><div class="line">                                mLastTouchDownIndex = childIndex;</div><div class="line">                            &#125;</div><div class="line">                            mLastTouchDownX = ev.getX();</div><div class="line">                            mLastTouchDownY = ev.getY();</div><div class="line">                            newTouchTarget = addTouchTarget(child, idBitsToAssign);</div><div class="line">                            alreadyDispatchedToNewTouchTarget = true;</div><div class="line">                            break;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        // The accessibility focus didn&apos;t handle the event, so clear</div><div class="line">                        // the flag and do a normal dispatch to all children.</div><div class="line">                        ev.setTargetAccessibilityFocus(false);</div><div class="line">                    &#125;</div><div class="line">                    if (preorderedList != null) preorderedList.clear();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                if (newTouchTarget == null &amp;&amp; mFirstTouchTarget != null) &#123;</div><div class="line">                    // Did not find a child to receive the event.</div><div class="line">                    // Assign the pointer to the least recently added target.</div><div class="line">                    newTouchTarget = mFirstTouchTarget;</div><div class="line">                    while (newTouchTarget.next != null) &#123;</div><div class="line">                        newTouchTarget = newTouchTarget.next;</div><div class="line">                    &#125;</div><div class="line">                    newTouchTarget.pointerIdBits |= idBitsToAssign;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Dispatch to touch targets.</div><div class="line">        if (mFirstTouchTarget == null) &#123;</div><div class="line">            // No touch targets so treat this as an ordinary view.</div><div class="line">            handled = dispatchTransformedTouchEvent(ev, canceled, null,</div><div class="line">                    TouchTarget.ALL_POINTER_IDS);</div><div class="line">        &#125; else &#123;</div><div class="line">            // Dispatch to touch targets, excluding the new touch target if we already</div><div class="line">            // dispatched to it.  Cancel touch targets if necessary.</div><div class="line">            TouchTarget predecessor = null;</div><div class="line">            TouchTarget target = mFirstTouchTarget;</div><div class="line">            while (target != null) &#123;</div><div class="line">                final TouchTarget next = target.next;</div><div class="line">                if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123;</div><div class="line">                    handled = true;</div><div class="line">                &#125; else &#123;</div><div class="line">                    final boolean cancelChild = resetCancelNextUpFlag(target.child)</div><div class="line">                            || intercepted;</div><div class="line">                    if (dispatchTransformedTouchEvent(ev, cancelChild,</div><div class="line">                            target.child, target.pointerIdBits)) &#123;</div><div class="line">                        handled = true;</div><div class="line">                    &#125;</div><div class="line">                    if (cancelChild) &#123;</div><div class="line">                        if (predecessor == null) &#123;</div><div class="line">                            mFirstTouchTarget = next;</div><div class="line">                        &#125; else &#123;</div><div class="line">                            predecessor.next = next;</div><div class="line">                        &#125;</div><div class="line">                        target.recycle();</div><div class="line">                        target = next;</div><div class="line">                        continue;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                predecessor = target;</div><div class="line">                target = next;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Update list of touch targets for pointer up or cancel, if needed.</div><div class="line">        if (canceled</div><div class="line">                || actionMasked == MotionEvent.ACTION_UP</div><div class="line">                || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</div><div class="line">            resetTouchState();</div><div class="line">        &#125; else if (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_UP) &#123;</div><div class="line">            final int actionIndex = ev.getActionIndex();</div><div class="line">            final int idBitsToRemove = 1 &lt;&lt; ev.getPointerId(actionIndex);</div><div class="line">            removePointersFromTouchTargets(idBitsToRemove);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (!handled &amp;&amp; mInputEventConsistencyVerifier != null) &#123;</div><div class="line">        mInputEventConsistencyVerifier.onUnhandledEvent(ev, 1);</div><div class="line">    &#125;</div><div class="line">    return handled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从第13行开始看，定义了boolean的变量handled，该值就是dispatchTouchEvent方法的返回值，14行判断当前ViewGroup是否没被遮挡，获取当前的事件action，19-25行对于事件为DOWN做了特殊处理，调用cancelAndClearTouchTargets清除所有的触摸控件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Cancels and clears all touch targets.</div><div class="line"> */</div><div class="line">private void cancelAndClearTouchTargets(MotionEvent event) &#123;</div><div class="line">    if (mFirstTouchTarget != null) &#123;</div><div class="line">        boolean syntheticEvent = false;</div><div class="line">        if (event == null) &#123;</div><div class="line">            final long now = SystemClock.uptimeMillis();</div><div class="line">            event = MotionEvent.obtain(now, now,</div><div class="line">                    MotionEvent.ACTION_CANCEL, 0.0f, 0.0f, 0);</div><div class="line">            event.setSource(InputDevice.SOURCE_TOUCHSCREEN);</div><div class="line">            syntheticEvent = true;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        for (TouchTarget target = mFirstTouchTarget; target != null; target = target.next) &#123;</div><div class="line">            resetCancelNextUpFlag(target.child);</div><div class="line">            dispatchTransformedTouchEvent(event, true, target.child, target.pointerIdBits);</div><div class="line">        &#125;</div><div class="line">        clearTouchTargets();</div><div class="line"></div><div class="line">        if (syntheticEvent) &#123;</div><div class="line">            event.recycle();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里有个很重要的变量mFirstTouchTarget ，只有该实例不为空的情况下才会执行后续的操作，我们假设这里的DOWN事件是有史以来第一次，那么mFirstTouchTarget 声明后并没有赋值，因此为null，就不存在后面的一系列清除操作，同样resetTouchState方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Resets all touch state in preparation for a new cycle.</div><div class="line"> */</div><div class="line">private void resetTouchState() &#123;</div><div class="line">    clearTouchTargets();</div><div class="line">    resetCancelNextUpFlag(this);</div><div class="line">    mGroupFlags &amp;= ~FLAG_DISALLOW_INTERCEPT;</div><div class="line">    mNestedScrollAxes = SCROLL_AXIS_NONE;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Clears all touch targets.</div><div class="line"> */</div><div class="line">private void clearTouchTargets() &#123;</div><div class="line">    TouchTarget target = mFirstTouchTarget;</div><div class="line">    if (target != null) &#123;</div><div class="line">        do &#123;</div><div class="line">            TouchTarget next = target.next;</div><div class="line">            target.recycle();</div><div class="line">            target = next;</div><div class="line">        &#125; while (target != null);</div><div class="line">        mFirstTouchTarget = null;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>都是因为mFirstTouchTarget为null所以不会执行，可能存在之前发生ANR等导致触摸事件未清除的情况，因此19-25行对于DOWN的操作只是确保了mFirstTouchTarget为null，为后续的操作奠定基础。</p>
<p>28-42行判断是否拦截事件取决于boolean值intercepted，如果事件为DOWN或者mFirstTouchTarget！=null，获取一个boolean的值disallowIntercept，这里的默认值为false，所以intercepted的值由onInterceptTouchEvent(ev)方法的返回值决定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public boolean onInterceptTouchEvent(MotionEvent ev) &#123;</div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到该方法默认返回false，即不拦截，如果是其他事件，并且mFirstTouchTarget为null，那这里的intercepted就为true。这块代码解释了例子1中的执行完dispatchTouchEvent之后马上执行onInterceptTouchEvent的原因，而例子2中UP时不执行onInterceptTouchEvent在这里看来很有可能是mFirstTouchTarget == null引起的，带着问题继续往下看。</p>
<p>51-52行判断是否为cancel<br>55行获取boolean值split默认为true，判断是否分发给子View<br>58行if (!canceled &amp;&amp; !intercepted)判断如果不是cancle事件，且ViewGroup不拦截成立，进入内部<br>68-70行开始对于DOWN事件进行的处理，首先在85行通过buildTouchDispatchChildList方法获取一个子View集合的preorderedList，89行倒序遍历子View，113行通过getTouchTarget方法判断是否找到子View在target链上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Gets the touch target for specified child view.</div><div class="line"> * Returns null if not found.</div><div class="line"> */</div><div class="line">private TouchTarget getTouchTarget(@NonNull View child) &#123;</div><div class="line">    for (TouchTarget target = mFirstTouchTarget; target != null; target = target.next) &#123;</div><div class="line">        if (target.child == child) &#123;</div><div class="line">            return target;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return null;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果匹配，则说明找到接收该事件的子View，执行114-119行代码跳出循环，这里我们仍然假设是有史以来的第一次DOWN事件，mFirstTouchTarget为null，因此不匹配，返回null，执行122行的if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) 判断<br>dispatchTransformedTouchEvent方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"> /**</div><div class="line"> * Transforms a motion event into the coordinate space of a particular child view,</div><div class="line"> * filters out irrelevant pointer ids, and overrides its action if necessary.</div><div class="line"> * If child is null, assumes the MotionEvent will be sent to this ViewGroup instead.</div><div class="line"> */</div><div class="line">private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel,</div><div class="line">        View child, int desiredPointerIdBits) &#123;</div><div class="line">    final boolean handled;</div><div class="line"></div><div class="line">    // Canceling motions is a special case.  We don&apos;t need to perform any transformations</div><div class="line">    // or filtering.  The important part is the action, not the contents.</div><div class="line">    final int oldAction = event.getAction();</div><div class="line">    if (cancel || oldAction == MotionEvent.ACTION_CANCEL) &#123;</div><div class="line">        event.setAction(MotionEvent.ACTION_CANCEL);</div><div class="line">        if (child == null) &#123;</div><div class="line">            handled = super.dispatchTouchEvent(event);</div><div class="line">        &#125; else &#123;</div><div class="line">            handled = child.dispatchTouchEvent(event);</div><div class="line">        &#125;</div><div class="line">        event.setAction(oldAction);</div><div class="line">        return handled;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Calculate the number of pointers to deliver.</div><div class="line">    final int oldPointerIdBits = event.getPointerIdBits();</div><div class="line">    final int newPointerIdBits = oldPointerIdBits &amp; desiredPointerIdBits;</div><div class="line"></div><div class="line">    // If for some reason we ended up in an inconsistent state where it looks like we</div><div class="line">    // might produce a motion event with no pointers in it, then drop the event.</div><div class="line">    if (newPointerIdBits == 0) &#123;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // If the number of pointers is the same and we don&apos;t need to perform any fancy</div><div class="line">    // irreversible transformations, then we can reuse the motion event for this</div><div class="line">    // dispatch as long as we are careful to revert any changes we make.</div><div class="line">    // Otherwise we need to make a copy.</div><div class="line">    final MotionEvent transformedEvent;</div><div class="line">    if (newPointerIdBits == oldPointerIdBits) &#123;</div><div class="line">        if (child == null || child.hasIdentityMatrix()) &#123;</div><div class="line">            if (child == null) &#123;</div><div class="line">                handled = super.dispatchTouchEvent(event);</div><div class="line">            &#125; else &#123;</div><div class="line">                final float offsetX = mScrollX - child.mLeft;</div><div class="line">                final float offsetY = mScrollY - child.mTop;</div><div class="line">                event.offsetLocation(offsetX, offsetY);</div><div class="line"></div><div class="line">                handled = child.dispatchTouchEvent(event);</div><div class="line"></div><div class="line">                event.offsetLocation(-offsetX, -offsetY);</div><div class="line">            &#125;</div><div class="line">            return handled;</div><div class="line">        &#125;</div><div class="line">        transformedEvent = MotionEvent.obtain(event);</div><div class="line">    &#125; else &#123;</div><div class="line">        transformedEvent = event.split(newPointerIdBits);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Perform any necessary transformations and dispatch.</div><div class="line">    if (child == null) &#123;</div><div class="line">        handled = super.dispatchTouchEvent(transformedEvent);</div><div class="line">    &#125; else &#123;</div><div class="line">        final float offsetX = mScrollX - child.mLeft;</div><div class="line">        final float offsetY = mScrollY - child.mTop;</div><div class="line">        transformedEvent.offsetLocation(offsetX, offsetY);</div><div class="line">        if (! child.hasIdentityMatrix()) &#123;</div><div class="line">            transformedEvent.transform(child.getInverseMatrix());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        handled = child.dispatchTouchEvent(transformedEvent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Done.</div><div class="line">    transformedEvent.recycle();</div><div class="line">    return handled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据注解大概分析，如果这里的child为null，事件会交给ViewGroup处理。该方法的第三个参数为空则调用super.dispatchTouchEvent(event)，不为空则调用child.dispatchTouchEvent(event);如果子View是个ViewGroup并且未对Touch事件拦截(onInterceptTouchEvent方法为false)，则递归调用dispatchTouchEvent；如果子View是个View，就调用其onTouchEvent()方法。最后，如果dispatchTransformedTouchEvent返回true，说明子View消费了该事件，122-141行中将addTouchTarget方法的返回值赋给newTouchTarget，将alreadyDispatchedToNewTouchTarget标志位置为true，同时跳出循环，查看addTouchTarget方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">private TouchTarget addTouchTarget(@NonNull View child, int pointerIdBits) &#123;</div><div class="line">    final TouchTarget target = TouchTarget.obtain(child, pointerIdBits);</div><div class="line">    target.next = mFirstTouchTarget;</div><div class="line">    mFirstTouchTarget = target;</div><div class="line">    return target;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>找了一圈终于看到在这里对mFirstTouchTarget 进行赋值了。<br>如果这里的if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign))判断为false，说明子View的未消费该事件，就不会执行addTouchTarget给mFirstTouchTarget 赋值，这就是例子2中UP的时候ParentView的onInterceptTouchEvent方法不执行的原因。</p>
<p>163行判断mFirstTouchTarget 是否为null，<br>如果当前事件为DOWN，在122行判断中返回false，即子View不消费事件，那么mFirstTouchTarget 未赋值为null成立，也就是例子2的情况，调用dispatchTransformedTouchEvent方法，第三个参数传入null，此时对于ParentView而言，会执行super.dispatchTouchEvent(event)，也就是View的dispatchTouchEvent方法，又因为ParentView复写了onTouch和onTouchEvent方法，所以看到log中打出了ParentView这两个方法的打印。之后UP事件过来，前面29-30行的判断都不满足，所以ParentView的onInterceptTouchEvent方法不执行，41行对intercepted赋值为true，即拦截事件，那么从58-160都不满足了，回到163行，同理执行super.dispatchTouchEvent(event)。</p>
<p>如果mFirstTouchTarget不为null，174行有个判断，之前DOWN事件时alreadyDispatchedToNewTouchTarget置为true，并且也给newTouchTarget赋值为target，这里判断成立，handled返回true说明已经处理了DOWN事件。对于MOVE或者UP事件，会走到179-182行中，同样是调用dispatchTransformedTouchEvent，handled值返回true。<br>203行对于UP执行完后调用resetTouchState()方法清除触摸状态，将mFirstTouchTarget 再次置为null，算是收尾工作。</p>
<h2 id="缩减版"><a href="#缩减版" class="headerlink" title="缩减版"></a>缩减版</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">    //如果是DOWN，确保mFirstTouchTarget 为null</div><div class="line">    if (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">        mFirstTouchTarget == null;</div><div class="line">    &#125;</div><div class="line">    //判断是否拦截</div><div class="line">    final boolean intercepted;</div><div class="line">    if (actionMasked == MotionEvent.ACTION_DOWN</div><div class="line">            || mFirstTouchTarget != null) &#123;</div><div class="line">        //Down或者mFirstTouchTarget!=null时将onInterceptTouchEvent值赋给intercepted，默认为false</div><div class="line">        intercepted = onInterceptTouchEvent(ev);</div><div class="line">    &#125; else &#123;</div><div class="line">        //除了Down,如果mFirstTouchTarget为null,则拦截</div><div class="line">        intercepted = true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //不拦截的情况下</div><div class="line">    if(!intercepted)&#123;</div><div class="line">        if(actionMasked == MotionEvent.ACTION_DOWN)&#123;</div><div class="line">            //如果是Down，判断子View是否消费</div><div class="line">            if(dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign))&#123;</div><div class="line">                //如果子Viwe消费,给mFirstTouchTarget赋值</div><div class="line">                mFirstTouchTarget = target</div><div class="line">            &#125;else&#123;</div><div class="line">                //如果子Viwe不消费mFirstTouchTarget未赋值仍为null</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if(mFirstTouchTarget == null)&#123;</div><div class="line">        //子View不消费，调用自身的super.dispatchTouchEvent(event)</div><div class="line">        handled = dispatchTransformedTouchEvent(ev, canceled, null,</div><div class="line">                    TouchTarget.ALL_POINTER_IDS);</div><div class="line">    &#125;else&#123;</div><div class="line">        //子View消费，递归调用child.dispatchTouchEvent(event)分发事件给具体的View</div><div class="line">        handled = dispatchTransformedTouchEvent(ev, cancelChild,target.child,</div><div class="line">                    target.pointerIdBits);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return handled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>1.Android的事件分发是先通过最外层的ViewGroup再传递到内部具体的View<br>2.如果ViewGroup的onInterceptTouchEvent返回false，接收到DOWN事件处理完成，之后的MOVE,UP等事件会继续先传递给该ViewGroup，再传递给目标View的onTouchEvent处理。如果ViewGroup的onInterceptTouchEvent返回true，那么接收到DOWN事件处理完成，之后的MOVE,UP等事件只会传递给该ViewGroup的onTouchEvent()处理，目标View接收不到任何事件；<br>3.如果最终需要处理事件的view的onTouchEvent()返回了false，那么该事件将被传递至其上一层次的view的onTouchEvent()处理；<br>4.如果最终需要处理事件的view 的onTouchEvent()返回了true，那么后续事件将可以继续传递给该view的onTouchEvent()处理。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/20/Android View事件分发机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/20/Android View事件分发机制/" itemprop="url">Android View事件分发机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-20T00:00:00+08:00">
                2017-04-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/04/20/Android View事件分发机制/" class="leancloud_visitors" data-flag-title="Android View事件分发机制">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>事件分发一直是一知半解的状态，最近在复习Launcher的拖拽机制，其中很多地方都涉及到事件分发，索性把事件分发这一块拿出来再学一遍。</p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>MainActivity.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends AppCompatActivity implements View.OnTouchListener,View.OnClickListener&#123;</div><div class="line"></div><div class="line">    private MyTextView myTextView;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">        myTextView = (MyTextView) findViewById(R.id.my_textview);</div><div class="line">        myTextView.setOnClickListener(this);</div><div class="line">        myTextView.setOnTouchListener(this);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onClick(View v) &#123;</div><div class="line">        switch (v.getId()) &#123;</div><div class="line">            case R.id.my_textview:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyTextView onClick&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouch(View v, MotionEvent event) &#123;</div><div class="line">        switch (v.getId()) &#123;</div><div class="line">            case R.id.my_textview:</div><div class="line">                switch (event.getAction()) &#123;</div><div class="line">                    case MotionEvent.ACTION_DOWN:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyTextView onTouch ACTION_DOWN&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_MOVE:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyTextView onTouch ACTION_MOVE&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_UP:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyTextView onTouch ACTION_UP&quot;);</div><div class="line">                        break;</div><div class="line">                    default:</div><div class="line">                        break;</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>activity_main.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:id=&quot;@+id/activity_main&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    tools:context=&quot;com.example.hcy.viewevent.MainActivity&quot;&gt;</div><div class="line"></div><div class="line">    &lt;com.example.hcy.viewevent.MyTextView</div><div class="line">        android:id=&quot;@+id/my_textview&quot;</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;Hello World!&quot; /&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<p>MyTextView.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public class MyTextView extends TextView &#123;</div><div class="line">    public MyTextView(Context context, AttributeSet attrs) &#123;</div><div class="line">        super(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public MyTextView(Context context) &#123;</div><div class="line">        super(context);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码很简单，点击下MyTextView 打印如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">03-01 00:07:19.369 11770 11770 D hcy     : MyTextView onTouch ACTION_DOWN</div><div class="line">03-01 00:07:19.417 11770 11770 D hcy     : MyTextView onTouch ACTION_UP</div><div class="line">03-01 00:07:19.422 11770 11770 D hcy     : MyTextView onClick</div></pre></td></tr></table></figure>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>从上面的日志来看onTouch先于onClick 执行，onTouch方法执行了两次，对应手指的DOWN和UP，之后才执行onClick，onTouch有返回值，默认为false，onClick无返回值。</p>
<p>将onTouch的返回值改为false，点击下MyTextView 打印如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">03-01 00:20:52.987 11770 11770 D hcy     : MyTextView onTouch ACTION_DOWN</div><div class="line">03-01 00:20:53.052 11770 11770 D hcy     : MyTextView onTouch ACTION_UP</div></pre></td></tr></table></figure>
<p>发现当把onTouch的返回值改为true后，onTouch的Down和UP照样执行而onClick方法不会执行。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>1.onTouch方法先于onClick方法执行<br>2.onTouch方法的返回true会阻止事件继续向下传递</p>
<p>View中有dispatchTouchEvent和onTouchEvent方法，所有的触摸事件都是通过dispatchTouchEvent方法来分发的，onTouchEvent对应事件的消费，在MyTextView方法中加上这两个方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public boolean dispatchTouchEvent(MotionEvent event) &#123;</div><div class="line">    switch (event.getAction())&#123;</div><div class="line">        case MotionEvent.ACTION_DOWN:</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;MyTextView dispatchTouchEvent ACTION_DOWN&quot;);</div><div class="line">            break;</div><div class="line">        case MotionEvent.ACTION_MOVE:</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;MyTextView dispatchTouchEvent ACTION_MOVE&quot;);</div><div class="line">            break;</div><div class="line">        case MotionEvent.ACTION_UP:</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;MyTextView dispatchTouchEvent ACTION_UP&quot;);</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">    return super.dispatchTouchEvent(event);</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line">public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">    switch (event.getAction())&#123;</div><div class="line">        case MotionEvent.ACTION_DOWN:</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;MyTextView onTouchEvent: ACTION_DOWN&quot;);</div><div class="line">            break;</div><div class="line">        case MotionEvent.ACTION_MOVE:</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;MyTextView onTouchEvent: ACTION_MOVE&quot;);</div><div class="line">            break;</div><div class="line">        case MotionEvent.ACTION_UP:</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;MyTextView onTouchEvent: ACTION_UP&quot;);</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">    return super.onTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>把MainActivity中onTouch的返回值改回默认的false，运行程序，点击MyTextView，打印如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">03-01 00:27:45.802 12338 12338 D hcy     : MyTextView dispatchTouchEvent ACTION_DOWN</div><div class="line">03-01 00:27:45.803 12338 12338 D hcy     : MyTextView onTouch ACTION_DOWN</div><div class="line">03-01 00:27:45.803 12338 12338 D hcy     : MyTextView onTouchEvent: ACTION_DOWN</div><div class="line">03-01 00:27:45.833 12338 12338 D hcy     : MyTextView dispatchTouchEvent ACTION_UP</div><div class="line">03-01 00:27:45.833 12338 12338 D hcy     : MyTextView onTouch ACTION_UP</div><div class="line">03-01 00:27:45.833 12338 12338 D hcy     : MyTextView onTouchEvent: ACTION_UP</div><div class="line">03-01 00:27:45.838 12338 12338 D hcy     : MyTextView onClick</div></pre></td></tr></table></figure>
<p>发现onClick的地位更低了，前面方法执行了一圈才轮到它。<br>把MainActivity中onTouch的返回值改成true，运行程序，点击MyTextView，打印如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">03-01 00:03:34.836 10473 10473 D hcy     : MyTextView dispatchTouchEvent ACTION_DOWN</div><div class="line">03-01 00:03:34.837 10473 10473 D hcy     : MyTextView onTouch ACTION_DOWN</div><div class="line">03-01 00:03:34.885 10473 10473 D hcy     : MyTextView dispatchTouchEvent ACTION_UP</div><div class="line">03-01 00:03:34.885 10473 10473 D hcy     : MyTextView onTouch ACTION_UP</div></pre></td></tr></table></figure>
<p>发现onTouchEvent和onClick都不执行了</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>既然对View所有的触摸事件都会通过dispatchTouchEvent分发，那就看下这个方法具体做了什么，查看View中该方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"> /**</div><div class="line"> * Pass the touch screen motion event down to the target view, or this</div><div class="line"> * view if it is the target.</div><div class="line"> *</div><div class="line"> * @param event The motion event to be dispatched.</div><div class="line"> * @return True if the event was handled by the view, false otherwise.</div><div class="line"> */</div><div class="line">public boolean dispatchTouchEvent(MotionEvent event) &#123;</div><div class="line">    // If the event should be handled by accessibility focus first.</div><div class="line">    if (event.isTargetAccessibilityFocus()) &#123;</div><div class="line">        // We don&apos;t have focus or no virtual descendant has it, do not handle the event.</div><div class="line">        if (!isAccessibilityFocusedViewOrHost()) &#123;</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line">        // We have focus and got the event, then use normal event dispatch.</div><div class="line">        event.setTargetAccessibilityFocus(false);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    boolean result = false;</div><div class="line"></div><div class="line">    if (mInputEventConsistencyVerifier != null) &#123;</div><div class="line">        mInputEventConsistencyVerifier.onTouchEvent(event, 0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    final int actionMasked = event.getActionMasked();</div><div class="line">    if (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">        // Defensive cleanup for new gesture</div><div class="line">        stopNestedScroll();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (onFilterTouchEventForSecurity(event)) &#123;</div><div class="line">        if ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) &#123;</div><div class="line">            result = true;</div><div class="line">        &#125;</div><div class="line">        //noinspection SimplifiableIfStatement</div><div class="line">        ListenerInfo li = mListenerInfo;</div><div class="line">        if (li != null &amp;&amp; li.mOnTouchListener != null</div><div class="line">                &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</div><div class="line">                &amp;&amp; li.mOnTouchListener.onTouch(this, event)) &#123;</div><div class="line">            result = true;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (!result &amp;&amp; onTouchEvent(event)) &#123;</div><div class="line">            result = true;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (!result &amp;&amp; mInputEventConsistencyVerifier != null) &#123;</div><div class="line">        mInputEventConsistencyVerifier.onUnhandledEvent(event, 0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Clean up after nested scrolls if this is the end of a gesture;</div><div class="line">    // also cancel it if we tried an ACTION_DOWN but we didn&apos;t want the rest</div><div class="line">    // of the gesture.</div><div class="line">    if (actionMasked == MotionEvent.ACTION_UP ||</div><div class="line">            actionMasked == MotionEvent.ACTION_CANCEL ||</div><div class="line">            (actionMasked == MotionEvent.ACTION_DOWN &amp;&amp; !result)) &#123;</div><div class="line">        stopNestedScroll();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注解的意思说明了该方法的作用：将触摸屏幕的事件分发给目标View，如果当前View是目标View就分发给当前View，若目标View处理了该事件则返回True，否则返回false。<br>挑重点看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">if (onFilterTouchEventForSecurity(event)) &#123;</div><div class="line">    if ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) &#123;</div><div class="line">        result = true;</div><div class="line">    &#125;</div><div class="line">    //noinspection SimplifiableIfStatement</div><div class="line">    ListenerInfo li = mListenerInfo;</div><div class="line">    if (li != null &amp;&amp; li.mOnTouchListener != null</div><div class="line">            &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</div><div class="line">            &amp;&amp; li.mOnTouchListener.onTouch(this, event)) &#123;</div><div class="line">        result = true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (!result &amp;&amp; onTouchEvent(event)) &#123;</div><div class="line">        result = true;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先判断onFilterTouchEventForSecurity方法的返回值，查看该方法的注解，主要是判断当前View是否被遮挡，如果事件可以被分发则返回true，接着将mListenerInfo赋给ListenerInfo实例进入if判断语句，这里li不为null成立，li.mOnTouchListener不为null取决于我们是否给View设置了OnTouchListener监听，可以调用View中setOnTouchListener方法设置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public void setOnTouchListener(OnTouchListener l) &#123;</div><div class="line">     getListenerInfo().mOnTouchListener = l;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>前面在MainActivity中调用了setOnTouchListener，因此成立，TextView默认是ENABLED，因此成立，取决于最后一个条件li.mOnTouchListener.onTouch(this, event)的返回值，这里的返回值就是MainActivity中onTouch的返回值，如果返回为true，那么result为true，下面的if判断不满足，因此onTouchEvent也不会执行，反之result值为false，onTouchEvent方法执行，之后再将result值赋为true。这就解释了上面onTouch返回true后onTouchEvent不执行的原因，那么onClick为啥也不执行呢，十有八九跟onTouchEvent有关，查看View中的onTouchEvent方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">  * Implement this method to handle touch screen motion events.</div><div class="line">  * &lt;p&gt;</div><div class="line">  * If this method is used to detect click actions, it is recommended that</div><div class="line">  * the actions be performed by implementing and calling</div><div class="line">  * &#123;@link #performClick()&#125;. This will ensure consistent system behavior,</div><div class="line">  * including:</div><div class="line">  * &lt;ul&gt;</div><div class="line">  * &lt;li&gt;obeying click sound preferences</div><div class="line">  * &lt;li&gt;dispatching OnClickListener calls</div><div class="line">  * &lt;li&gt;handling &#123;@link AccessibilityNodeInfo#ACTION_CLICK ACTION_CLICK&#125; when</div><div class="line">  * accessibility features are enabled</div><div class="line">  * &lt;/ul&gt;</div><div class="line">  *</div><div class="line">  * @param event The motion event.</div><div class="line">  * @return True if the event was handled, false otherwise.</div><div class="line">  */</div><div class="line"> public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">     final float x = event.getX();</div><div class="line">     final float y = event.getY();</div><div class="line">     final int viewFlags = mViewFlags;</div><div class="line">     final int action = event.getAction();</div><div class="line"></div><div class="line">     if ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</div><div class="line">         if (action == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != 0) &#123;</div><div class="line">             setPressed(false);</div><div class="line">         &#125;</div><div class="line">         // A disabled view that is clickable still consumes the touch</div><div class="line">         // events, it just doesn&apos;t respond to them.</div><div class="line">         return (((viewFlags &amp; CLICKABLE) == CLICKABLE</div><div class="line">                 || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)</div><div class="line">                 || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE);</div><div class="line">     &#125;</div><div class="line">     if (mTouchDelegate != null) &#123;</div><div class="line">         if (mTouchDelegate.onTouchEvent(event)) &#123;</div><div class="line">             return true;</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     if (((viewFlags &amp; CLICKABLE) == CLICKABLE ||</div><div class="line">             (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) ||</div><div class="line">             (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE) &#123;</div><div class="line">         switch (action) &#123;</div><div class="line">             case MotionEvent.ACTION_UP:</div><div class="line">                 boolean prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != 0;</div><div class="line">                 if ((mPrivateFlags &amp; PFLAG_PRESSED) != 0 || prepressed) &#123;</div><div class="line">                     // take focus if we don&apos;t have it already and we should in</div><div class="line">                     // touch mode.</div><div class="line">                     boolean focusTaken = false;</div><div class="line">                     if (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) &#123;</div><div class="line">                         focusTaken = requestFocus();</div><div class="line">                     &#125;</div><div class="line"></div><div class="line">                     if (prepressed) &#123;</div><div class="line">                         // The button is being released before we actually</div><div class="line">                         // showed it as pressed.  Make it show the pressed</div><div class="line">                         // state now (before scheduling the click) to ensure</div><div class="line">                         // the user sees it.</div><div class="line">                         setPressed(true, x, y);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                     if (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) &#123;</div><div class="line">                         // This is a tap, so remove the longpress check</div><div class="line">                         removeLongPressCallback();</div><div class="line"></div><div class="line">                         // Only perform take click actions if we were in the pressed state</div><div class="line">                         if (!focusTaken) &#123;</div><div class="line">                             // Use a Runnable and post this rather than calling</div><div class="line">                             // performClick directly. This lets other visual state</div><div class="line">                             // of the view update before click actions start.</div><div class="line">                             if (mPerformClick == null) &#123;</div><div class="line">                                 mPerformClick = new PerformClick();</div><div class="line">                             &#125;</div><div class="line">                             if (!post(mPerformClick)) &#123;</div><div class="line">                                 performClick();</div><div class="line">                             &#125;</div><div class="line">                         &#125;</div><div class="line">                     &#125;</div><div class="line"></div><div class="line">                     if (mUnsetPressedState == null) &#123;</div><div class="line">                         mUnsetPressedState = new UnsetPressedState();</div><div class="line">                     &#125;</div><div class="line"></div><div class="line">                     if (prepressed) &#123;</div><div class="line">                         postDelayed(mUnsetPressedState,</div><div class="line">                                 ViewConfiguration.getPressedStateDuration());</div><div class="line">                     &#125; else if (!post(mUnsetPressedState)) &#123;</div><div class="line">                         // If the post failed, unpress right now</div><div class="line">                         mUnsetPressedState.run();</div><div class="line">                     &#125;</div><div class="line"></div><div class="line">                     removeTapCallback();</div><div class="line">                 &#125;</div><div class="line">                 mIgnoreNextUpEvent = false;</div><div class="line">                 break;</div><div class="line"></div><div class="line">             case MotionEvent.ACTION_DOWN:</div><div class="line">                 mHasPerformedLongPress = false;</div><div class="line"></div><div class="line">                 if (performButtonActionOnTouchDown(event)) &#123;</div><div class="line">                     break;</div><div class="line">                 &#125;</div><div class="line"></div><div class="line">                 // Walk up the hierarchy to determine if we&apos;re inside a scrolling container.</div><div class="line">                 boolean isInScrollingContainer = isInScrollingContainer();</div><div class="line"></div><div class="line">                 // For views inside a scrolling container, delay the pressed feedback for</div><div class="line">                 // a short period in case this is a scroll.</div><div class="line">                 if (isInScrollingContainer) &#123;</div><div class="line">                     mPrivateFlags |= PFLAG_PREPRESSED;</div><div class="line">                     if (mPendingCheckForTap == null) &#123;</div><div class="line">                         mPendingCheckForTap = new CheckForTap();</div><div class="line">                     &#125;</div><div class="line">                     mPendingCheckForTap.x = event.getX();</div><div class="line">                     mPendingCheckForTap.y = event.getY();</div><div class="line">                     postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout());</div><div class="line">                 &#125; else &#123;</div><div class="line">                     // Not inside a scrolling container, so show the feedback right away</div><div class="line">                     setPressed(true, x, y);</div><div class="line">                     checkForLongClick(0, x, y);</div><div class="line">                 &#125;</div><div class="line">                 break;</div><div class="line"></div><div class="line">             case MotionEvent.ACTION_CANCEL:</div><div class="line">                 setPressed(false);</div><div class="line">                 removeTapCallback();</div><div class="line">                 removeLongPressCallback();</div><div class="line">                 mInContextButtonPress = false;</div><div class="line">                 mHasPerformedLongPress = false;</div><div class="line">                 mIgnoreNextUpEvent = false;</div><div class="line">                 break;</div><div class="line"></div><div class="line">             case MotionEvent.ACTION_MOVE:</div><div class="line">                 drawableHotspotChanged(x, y);</div><div class="line"></div><div class="line">                 // Be lenient about moving outside of buttons</div><div class="line">                 if (!pointInView(x, y, mTouchSlop)) &#123;</div><div class="line">                     // Outside button</div><div class="line">                     removeTapCallback();</div><div class="line">                     if ((mPrivateFlags &amp; PFLAG_PRESSED) != 0) &#123;</div><div class="line">                         // Remove any future long press/tap checks</div><div class="line">                         removeLongPressCallback();</div><div class="line"></div><div class="line">                         setPressed(false);</div><div class="line">                     &#125;</div><div class="line">                 &#125;</div><div class="line">                 break;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         return true;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     return false;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>代码有点长，先看注解，大概意思就是说可以实现这个方法去处理触摸事件，消费了事件返回true，否则返回false。并且如果要监测点击事件最好实现performClick方法，分析该方法。这里分为几种情况，首先判断viewFlags：<br>1.如果该控件是DISABLED且是CLICKABLE或者LONG_CLICKABLE中的一种，则返回true，同样消费掉该事件；<br>2.如果该控件是DISABLED且不是CLICKABLE或者LONG_CLICKABLE中的一种，那啥也别说了，下面一大段代码都跟它没关系，直接返回最后那个大大的false，不消费事件。<br>3.如果该控件是ENABLED且满足CLICKABLE或者LONG_CLICKABLE中的一种，就走下面的switch判断，也就是我们例子的情况，如果是这个情况，最后会return true，所以如果子类中默认调用super.onTouchEvent方法也是返回true。<br>事件都是从DOWN开始，MotionEvent.ACTION_DOWN中主要判断当前控件是否在可滚动的区域内，如果不在就设置点击为true，同时检查是否是长按，主要根据这里X，Y坐标轴判断。再看MotionEvent.ACTION_UP，在这里会判断是否之前是否按下过并且获取焦点，再创建一个mPerformClick的Runnable，通过post在UI线程中执行performClick()方法，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">private final class PerformClick implements Runnable &#123;</div><div class="line">    @Override</div><div class="line">    public void run() &#123;</div><div class="line">        performClick();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>查看performClick()方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public boolean performClick() &#123;</div><div class="line">    final boolean result;</div><div class="line">    final ListenerInfo li = mListenerInfo;</div><div class="line">    if (li != null &amp;&amp; li.mOnClickListener != null) &#123;</div><div class="line">        playSoundEffect(SoundEffectConstants.CLICK);</div><div class="line">        li.mOnClickListener.onClick(this);</div><div class="line">        result = true;</div><div class="line">    &#125; else &#123;</div><div class="line">        result = false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED);</div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法的返回值取决于中间那个if判断，首先li经过mListenerInfo赋值所以不为null成立，li.mOnClickListener != null取决于我们是否为控件设置了OnClickListener 监听，View提供了方法setOnClickListener</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public void setOnClickListener(@Nullable OnClickListener l) &#123;</div><div class="line">    if (!isClickable()) &#123;</div><div class="line">        setClickable(true);</div><div class="line">    &#125;</div><div class="line">    getListenerInfo().mOnClickListener = l;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们在MainActivity中设置了监听，因此成立，所以会调用li.mOnClickListener.onClick(this)，即我们在MainActivity中实现的onClick方法。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>onTouch方法先于onClick方法执行，onClick方法是在onTouchEvent的UP事件触发的。</li>
<li>View的触摸事件会先调用dispatchTouchEvent方法分发事件，dispatchTouchEvent首先调用onTouch方法，如果onTouch返回true，onTouchEvent不执行，dispatchTouchEvent直接返回true；如果onTouch返回false，onTouchEvent执行，onClick方法执行，dispatchTouchEvent的返回值与onTouchEvent一致。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/30/Launcher3 M屏幕适配/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/30/Launcher3 M屏幕适配/" itemprop="url">Launcher3 M屏幕适配</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-30T00:00:00+08:00">
                2017-03-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/03/30/Launcher3 M屏幕适配/" class="leancloud_visitors" data-flag-title="Launcher3 M屏幕适配">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>安卓的碎片化非常严重，如果适配工作没做好的话，经常会出现这种情况，你写的APP在大屏的手机上显示正常，在小屏的手机上显示就不那么尽如人意了。Launcher3作为手机的门面，我们发现在不同屏幕大小的设备上，适配工作都做的挺好的，该文就探究下它是如何实现的。</p>
<h3 id="猜想"><a href="#猜想" class="headerlink" title="猜想"></a>猜想</h3><p>要适配不同大小的屏幕，屏幕的大小当然是设备自己最清楚了，因此设备把自身的屏幕宽高告诉给launcher，然后launcher再根据宽高再选择怎样的显示？</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>查看Launcher3的onCreate()方法，省略掉部分代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        ......</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line"></div><div class="line">        LauncherAppState.setApplicationContext(getApplicationContext());</div><div class="line">        LauncherAppState app = LauncherAppState.getInstance();</div><div class="line"></div><div class="line">        // Load configuration-specific DeviceProfile</div><div class="line">        mDeviceProfile = getResources().getConfiguration().orientation</div><div class="line">                == Configuration.ORIENTATION_LANDSCAPE ?</div><div class="line">                        app.getInvariantDeviceProfile().landscapeProfile</div><div class="line">                            : app.getInvariantDeviceProfile().portraitProfile;</div><div class="line">        ......</div><div class="line">        setContentView(R.layout.launcher);</div><div class="line"></div><div class="line">        setupViews();</div><div class="line">        mDeviceProfile.layout(this);</div><div class="line">        ......</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里看到在初始化的时候会判断当前屏幕是水平显示还是竖直显示，获得一个DeviceProfile实例，从名字看，这个就是我们寻觅已久的设备配置，先看下它是怎么实例化的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">代码路径：/packages/apps/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.java</div><div class="line">    InvariantDeviceProfile(Context context) &#123;</div><div class="line">        ......</div><div class="line">        landscapeProfile = new DeviceProfile(context, this, smallestSize, largestSize,</div><div class="line">                largeSide, smallSide, true /* isLandscape */);</div><div class="line">        portraitProfile = new DeviceProfile(context, this, smallestSize, largestSize,</div><div class="line">                smallSide, largeSide, false /* isLandscape */);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>DeviceProfile的初始化是在InvariantDeviceProfile的构造函数中，这里注意第二个参数，传进去的就是InvariantDeviceProfile本身，继续查看DeviceProfile的构造函数我们可以发现配置里的很多值都是从InvariantDeviceProfile获取的，如图标大小，字体大小等，所以我们来看下这个InvariantDeviceProfile是个什么东东。</p>
<h3 id="InvariantDeviceProfile"><a href="#InvariantDeviceProfile" class="headerlink" title="InvariantDeviceProfile"></a>InvariantDeviceProfile</h3><p>从字面翻译上看，它表示不变的设备配置。啥意思？先看下它是怎样初始化的。在Launcher的onCreate中获取LauncherAppState 的时候做了一些初始化工作，其中就包括初始化InvariantDeviceProfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">代码路径：packages/apps/Launcher3/src/com/android/launcher3/LauncherAppState.java</div><div class="line">    private LauncherAppState() &#123;</div><div class="line">        .......</div><div class="line">        mInvariantDeviceProfile = new InvariantDeviceProfile(sContext);</div><div class="line">        .......</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>再看下InvariantDeviceProfile的构造函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">InvariantDeviceProfile(Context context) &#123;</div><div class="line">    mContext = context;</div><div class="line">    WindowManager wm = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);</div><div class="line">    //获取设备默认的屏幕</div><div class="line">    Display display = wm.getDefaultDisplay();</div><div class="line">    DisplayMetrics dm = new DisplayMetrics();</div><div class="line">    display.getMetrics(dm);</div><div class="line"></div><div class="line">    Point smallestSize = new Point();</div><div class="line">    Point largestSize = new Point();</div><div class="line">    //确定屏幕的范围</div><div class="line">    display.getCurrentSizeRange(smallestSize, largestSize);</div><div class="line"></div><div class="line">    // This guarantees that width &lt; height</div><div class="line">    //获取最小的屏幕宽高值</div><div class="line">    minWidthDps = Utilities.dpiFromPx(Math.min(smallestSize.x, smallestSize.y), dm);</div><div class="line">    minHeightDps = Utilities.dpiFromPx(Math.min(largestSize.x, largestSize.y), dm);</div><div class="line"></div><div class="line">    //得到最接近的设置配置表集合</div><div class="line">    ArrayList&lt;InvariantDeviceProfile&gt; closestProfiles =</div><div class="line">            findClosestDeviceProfiles(minWidthDps, minHeightDps, getPredefinedDeviceProfiles());</div><div class="line">    InvariantDeviceProfile interpolatedDeviceProfileOut =</div><div class="line">            invDistWeightedInterpolate(minWidthDps,  minHeightDps, closestProfiles);</div><div class="line">    //获取设备列表集合中第一张表并对参数赋值</div><div class="line">    InvariantDeviceProfile closestProfile = closestProfiles.get(0);</div><div class="line">    numRows = closestProfile.numRows;</div><div class="line">    numColumns = closestProfile.numColumns;</div><div class="line">    numHotseatIcons = closestProfile.numHotseatIcons;</div><div class="line">    hotseatAllAppsRank = (int) (numHotseatIcons / 2);</div><div class="line">    defaultLayoutId = closestProfile.defaultLayoutId;</div><div class="line">    numFolderRows = closestProfile.numFolderRows;</div><div class="line">    numFolderColumns = closestProfile.numFolderColumns;</div><div class="line">    minAllAppsPredictionColumns = closestProfile.minAllAppsPredictionColumns;</div><div class="line"></div><div class="line">    iconSize = interpolatedDeviceProfileOut.iconSize;</div><div class="line">    iconBitmapSize = Utilities.pxFromDp(iconSize, dm);</div><div class="line">    iconTextSize = interpolatedDeviceProfileOut.iconTextSize;</div><div class="line"></div><div class="line">    fillResIconDpi = getLauncherIconDensity(iconBitmapSize);</div><div class="line"></div><div class="line">    // If the partner customization apk contains any grid overrides, apply them</div><div class="line">    // Supported overrides: numRows, numColumns, iconSize</div><div class="line">    applyPartnerDeviceProfileOverrides(context, dm);</div><div class="line"></div><div class="line">    Point realSize = new Point();</div><div class="line">    display.getRealSize(realSize);</div><div class="line">    // The real size never changes. smallSide and largeSide will remain the</div><div class="line">    // same in any orientation.</div><div class="line">    int smallSide = Math.min(realSize.x, realSize.y);</div><div class="line">    int largeSide = Math.max(realSize.x, realSize.y);</div><div class="line"></div><div class="line">    landscapeProfile = new DeviceProfile(context, this, smallestSize, largestSize,</div><div class="line">            largeSide, smallSide, true /* isLandscape */);</div><div class="line">    portraitProfile = new DeviceProfile(context, this, smallestSize, largestSize,</div><div class="line">            smallSide, largeSide, false /* isLandscape */);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码中首先获取WindowManger服务，根据该服务获取最小屏幕宽高值，然后通过findClosestDeviceProfiles方法返回最接近的设备配置集合。findClosestDeviceProfiles()方法的第三个参数getPredefinedDeviceProfiles()如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">ArrayList&lt;InvariantDeviceProfile&gt; getPredefinedDeviceProfiles() &#123;</div><div class="line">    ArrayList&lt;InvariantDeviceProfile&gt; predefinedDeviceProfiles = new ArrayList&lt;&gt;();</div><div class="line">    // width, height, #rows, #columns, #folder rows, #folder columns,</div><div class="line">    // iconSize, iconTextSize, #hotseat, #hotseatIconSize, defaultLayoutId.</div><div class="line">    int fourByFourDefaultLayout = R.xml.default_workspace_4x4;</div><div class="line">    if (mContext.getResources().getBoolean(</div><div class="line">            R.bool.config_launcher_customWorkspace))&#123;</div><div class="line">        fourByFourDefaultLayout = R.xml.custom_workspace_4x4;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Super Short Stubby&quot;,</div><div class="line">            255, 300, 2, 3, 2, 3, 3, 48, 13, 3, 48, fourByFourDefaultLayout));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Shorter Stubby&quot;,</div><div class="line">            255, 400, 3, 3, 3, 3, 3, 48, 13, 3, 48, fourByFourDefaultLayout));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Short Stubby&quot;,</div><div class="line">            275, 420, 3, 4, 3, 4, 4, 48, 13, 5, 48, fourByFourDefaultLayout));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Stubby&quot;,</div><div class="line">            255, 450, 3, 4, 3, 4, 4, 48, 13, 5, 48, fourByFourDefaultLayout));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Nexus S&quot;,</div><div class="line">            296, 491.33f, 4, 4, 4, 4, 4, 48, 13, 5, 48, fourByFourDefaultLayout));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Nexus 4&quot;,</div><div class="line">            335, 567, 4, 4, 4, 4, 4, DEFAULT_ICON_SIZE_DP, 13, 5, 56, fourByFourDefaultLayout));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Nexus 5&quot;,</div><div class="line">            359, 567, 4, 4, 4, 4, 4, DEFAULT_ICON_SIZE_DP, 13, 5, 56, fourByFourDefaultLayout));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Large Phone&quot;,</div><div class="line">            406, 694, 5, 5, 4, 4, 4, 64, 14.4f,  5, 56, R.xml.default_workspace_5x5));</div><div class="line">    // The tablet profile is odd in that the landscape orientation</div><div class="line">    // also includes the nav bar on the side</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Nexus 7&quot;,</div><div class="line">            575, 904, 5, 6, 4, 5, 4, 72, 14.4f,  7, 60, R.xml.default_workspace_5x6));</div><div class="line">    // Larger tablet profiles always have system bars on the top &amp; bottom</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Nexus 10&quot;,</div><div class="line">            727, 1207, 5, 6, 4, 5, 4, 76, 14.4f,  7, 64, R.xml.default_workspace_5x6));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;20-inch Tablet&quot;,</div><div class="line">            1527, 2527,7, 7, 6, 6, 4, 100, 20,  7, 72, fourByFourDefaultLayout));</div><div class="line"></div><div class="line">    return predefinedDeviceProfiles;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>市面上屏幕那么多，不可能雨露均沾，Google在这里预制一些主流的屏幕所对应的的launcher配置信息，以Nexus 5为例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InvariantDeviceProfile(&quot;Nexus 5&quot;,</div><div class="line">                359, 567, 4, 4, 4, 4, 4, DEFAULT_ICON_SIZE_DP, 13, 5, 56, fourByFourDefaultLayout));</div></pre></td></tr></table></figure>
<p>参数依次代表的含义为：最小宽359，高567，桌面布局显示为4<em>4，文件夹中图标布局显示为4</em>4，桌面图标大小为DEFAULT_ICON_SIZE_DP(默认为60)，图标下的标题文本大小为13，dock栏图标数量为5，dock栏图标大小为56，默认加载的布局文件为fourByFourDefaultLayout。<br>findClosestDeviceProfiles()就是根据传的最小宽高值从launcher保存的这么多块屏幕中选择最接近的一块屏幕显示,代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Returns the closest device profiles ordered by closeness to the specified width and height</div><div class="line"> */</div><div class="line">// Package private visibility for testing.</div><div class="line">ArrayList&lt;InvariantDeviceProfile&gt; findClosestDeviceProfiles(</div><div class="line">        final float width, final float height, ArrayList&lt;InvariantDeviceProfile&gt; points) &#123;</div><div class="line"></div><div class="line">    // Sort the profiles by their closeness to the dimensions</div><div class="line">    ArrayList&lt;InvariantDeviceProfile&gt; pointsByNearness = points;</div><div class="line">    Collections.sort(pointsByNearness, new Comparator&lt;InvariantDeviceProfile&gt;() &#123;</div><div class="line">        public int compare(InvariantDeviceProfile a, InvariantDeviceProfile b) &#123;</div><div class="line">            return (int) (dist(width, height, a.minWidthDps, a.minHeightDps)</div><div class="line">                    - dist(width, height, b.minWidthDps, b.minHeightDps));</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    return pointsByNearness;</div><div class="line">&#125;</div><div class="line">@Thunk float dist(float x0, float y0, float x1, float y1) &#123;</div><div class="line">    return (float) Math.hypot(x1 - x0, y1 - y0);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>把最小宽高值和预制的那些屏幕的最小宽高值做平方差计算，再把计算结果从小到大排序。<br>之后获取表中的第一张屏幕，然后就把该屏幕的配置赋值给当前的设备。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">InvariantDeviceProfile closestProfile = closestProfiles.get(0);</div><div class="line">numRows = closestProfile.numRows;</div><div class="line">numColumns = closestProfile.numColumns;</div><div class="line">numHotseatIcons = closestProfile.numHotseatIcons;</div><div class="line">hotseatAllAppsRank = (int) (numHotseatIcons / 2);</div><div class="line">defaultLayoutId = closestProfile.defaultLayoutId;</div><div class="line">numFolderRows = closestProfile.numFolderRows;</div><div class="line">numFolderColumns = closestProfile.numFolderColumns;</div></pre></td></tr></table></figure>
<p>但是桌面的图标大小和标题大小以及dock栏的图标大小却是通过interpolatedDeviceProfileOut来获取的，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">iconSize = interpolatedDeviceProfileOut.iconSize;</div><div class="line">iconBitmapSize = Utilities.pxFromDp(iconSize, dm);</div><div class="line">iconTextSize = interpolatedDeviceProfileOut.iconTextSize;</div><div class="line">hotseatIconSize = interpolatedDeviceProfileOut.hotseatIconSize;</div></pre></td></tr></table></figure>
<p>interpolatedDeviceProfileOut的获取如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InvariantDeviceProfile interpolatedDeviceProfileOut =</div><div class="line">                invDistWeightedInterpolate(minWidthDps,  minHeightDps, closestProfiles);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">// Package private visibility for testing.</div><div class="line"> InvariantDeviceProfile invDistWeightedInterpolate(float width, float height,</div><div class="line">             ArrayList&lt;InvariantDeviceProfile&gt; points) &#123;</div><div class="line">     float weights = 0;</div><div class="line"></div><div class="line">     InvariantDeviceProfile p = points.get(0);</div><div class="line">     if (dist(width, height, p.minWidthDps, p.minHeightDps) == 0) &#123;</div><div class="line">         return p;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     InvariantDeviceProfile out = new InvariantDeviceProfile();</div><div class="line">     for (int i = 0; i &lt; points.size() &amp;&amp; i &lt; KNEARESTNEIGHBOR; ++i) &#123;</div><div class="line">         p = new InvariantDeviceProfile(points.get(i));</div><div class="line">         float w = weight(width, height, p.minWidthDps, p.minHeightDps, WEIGHT_POWER);</div><div class="line">         weights += w;</div><div class="line">         out.add(p.multiply(w));</div><div class="line">     &#125;</div><div class="line">     return out.multiply(1.0f/weights);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>如果设置配置集合中的第一张表刚刚好，dist(width, height, p.minWidthDps, p.minHeightDps) == 0；那就说明正好是我们找的那块屏幕，如果不是，launcher会遍历最接近的三块(KNEARESTNEIGHBOR)配置,做加权运算，之后取平均值，目的也是为了达到最佳的显示效果。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>launcher适配不同屏幕的思路就是先保存市面上常见的屏幕尺寸，并指定了这些屏幕显示的方式，几行几列，图标文本大小等，再根据当前设备的宽高选择最合适的一块屏幕。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/29/Java单例模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/29/Java单例模式/" itemprop="url">Java单例模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-29T00:00:00+08:00">
                2017-03-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/03/29/Java单例模式/" class="leancloud_visitors" data-flag-title="Java单例模式">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>一个类只有一个实例，自行实例化并提供给整个系统。</p>
<h3 id="基本思路"><a href="#基本思路" class="headerlink" title="基本思路"></a>基本思路</h3><p>将该类构造函数私有化，并通过静态方法获取一个唯一实例，获取过程保证线程安全。</p>
<h3 id="懒汉式线程不安全写法"><a href="#懒汉式线程不安全写法" class="headerlink" title="懒汉式线程不安全写法"></a>懒汉式线程不安全写法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public class Singleton &#123;</div><div class="line">    private static Singleton instance;</div><div class="line">    private Singleton ()&#123;&#125;</div><div class="line"></div><div class="line">    public static Singleton getInstance() &#123;</div><div class="line">     if (instance == null) &#123; //分水岭</div><div class="line">         instance = new Singleton();</div><div class="line">     &#125;</div><div class="line">     return instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>假设有A、B线程同时调用getInstance方法，在分水岭同时执行完判断后，由于CPU时间片切换，假设A线程得到执行权，继续向下执行，实例化了对象，此时instance不为空，而B线程又做了实例化工作，就会导致实例不唯一。</p>
<h3 id="懒汉式线程安全"><a href="#懒汉式线程安全" class="headerlink" title="懒汉式线程安全"></a>懒汉式线程安全</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public class Singleton &#123;</div><div class="line">    private static Singleton instance;</div><div class="line">    private Singleton ()&#123;&#125;</div><div class="line"></div><div class="line">   public static synchronized Singleton getInstance() &#123;</div><div class="line">    if (instance == null) &#123;</div><div class="line">        instance = new Singleton();</div><div class="line">    &#125;</div><div class="line">    return instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在getInstance()方法前加上synchronized，使整个方法同步，就可以保证线程安全，避免多实例的问题，但是这样并不高效，因为在第一次调用过getInstance()方法后，instance不为空，之后再调用该方法都要走同步，这样会消耗不必要的资源。</p>
<h3 id="Double-Check-Lock-双重检验锁"><a href="#Double-Check-Lock-双重检验锁" class="headerlink" title="Double Check Lock(双重检验锁)"></a>Double Check Lock(双重检验锁)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public class Singleton &#123;</div><div class="line">    private static Singleton instance;</div><div class="line">    private Singleton ()&#123;&#125;</div><div class="line"></div><div class="line">public static Singleton getSingleton() &#123;</div><div class="line">    if (instance == null) &#123;                         //Single Checked</div><div class="line">        synchronized (Singleton.class) &#123;</div><div class="line">            if (instance == null) &#123;                 //Double Checked</div><div class="line">                instance = new Singleton();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return instance ;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里为啥要做两次检验呢？我们先来看下，如果去掉第一层检验会怎样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public static Singleton getSingleton() &#123;</div><div class="line">    synchronized (Singleton.class) &#123;</div><div class="line">            if (instance == null) &#123;                 </div><div class="line">                instance = new Singleton();</div><div class="line">            &#125;</div><div class="line">    return instance ;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>当有两个线程同时调用getSingleton()方法时，由于同步机制的存在，假设此时A线程得到CPU的执行权，走到同步块中执行，执行了instance = new Singleton()后，退出同步语句块，此时instance已经不为null了，这时候B线程获得CPU执行权也进入同步块，就会被instance == null的判断挡在外面了。<br>所以就算不要第一层检验也是可以实现多线程安全的单例，那为毛还要写？原来这里涉及到性能问题，上面懒汉式线程安全的写法也是安全的，但是每次调用都要走同步会影响性能，这里也一样。我们希望这里的new Singleton()只执行一次，如果少了第一层的判断，每次有线程进入 getInstance()时，均会执行锁定操作来实现线程同步，这是非常耗费性能的，而多了第一层检验，只有第一次instance == null会执行锁定操作，之后的调用直接return instance就行。<br>再看如果少了第二层检验，其实这就跟第一种懒汉式线程不安全写法一样，在多线程并发的情况下不能达到保持单例的效果。<br>那么双重检验机制是否就能完美解决问题？其实不然，其原因在于instance = new Singleton();这句并非是个原子操作，当JVM运行到这一句是，分别作了如下操作<br>1.在堆中为 instance 分配内存<br>2.调用 Singleton的构造函数初始化成员变量<br>3.将instance对象指向分配的内存空间（执行完这步 instance 就为非 null 了）<br>如果上面的操作按1-2-3顺序执行，那就没啥问题，但是由于JVM的即时编译器中存在指令重排序的优化，上面的操作有可能是1-3-2。这会出现啥情况？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public static Singleton getSingleton() &#123;</div><div class="line">    if (instance == null) &#123;        //p2                 </div><div class="line">        synchronized (Singleton.class) &#123;</div><div class="line">            if (instance == null) &#123;                </div><div class="line">                instance = new Singleton(); //p1</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return instance ;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>假设线程A此时走到p1处，JVM按照1-3-2的顺序实例化instance,才执行完1-3，来不及执行2，线程B获得了CPU执行权也调用了getInstance()方法，并走到p2处，此时instance不为null,线程B就屁颠屁颠拿着得到的实例回去干活了，但是里头的成员变量还没初始化，这就尴尬了，报错也就理所当然了。</p>
<p>要解决这问题只要把instance设置成volatile，禁止重排序优化，以上面的例子，不管是1-2-3还是1-3-2，读取必须在操作完全执行完后才能进行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public class Singleton &#123;</div><div class="line">    private volatile static Singleton instance;</div><div class="line">    private Singleton ()&#123;&#125;</div><div class="line"></div><div class="line">public static Singleton getSingleton() &#123;</div><div class="line">    if (instance == null) &#123;                         //Single Checked</div><div class="line">        synchronized (Singleton.class) &#123;</div><div class="line">            if (instance == null) &#123;                 //Double Checked</div><div class="line">                instance = new Singleton();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return instance ;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然而在Java5以前的版本使用volatile还是有问题，也不能完全避免重排序。</p>
<h3 id="恶汉式"><a href="#恶汉式" class="headerlink" title="恶汉式"></a>恶汉式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class Singleton&#123;</div><div class="line">    private static final Singleton instance = new Singleton();</div><div class="line">    private Singleton()&#123;&#125;</div><div class="line"></div><div class="line">    public static Singleton getInstance()&#123;</div><div class="line">        return instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于instance被static和final修饰，在该类第一次被加载到内存中时就会对instance实例化，这样保证了单例。缺点是就算其他地方没有调用getInstance()方法，也会创建实例。</p>
<h3 id="静态内部类"><a href="#静态内部类" class="headerlink" title="静态内部类"></a>静态内部类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public class Singleton &#123;  </div><div class="line">    private static class SingletonHolder &#123;  </div><div class="line">        private static final Singleton INSTANCE = new Singleton();  </div><div class="line">    &#125;  </div><div class="line">    private Singleton ()&#123;&#125;  </div><div class="line">    public static final Singleton getInstance() &#123;  </div><div class="line">        return SingletonHolder.INSTANCE; </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>静态内部类就比较好的弥补了恶汉式单例不足，也是比较推崇的写法。</p>
<h3 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public enum EnumSingleton&#123;</div><div class="line">    INSTANCE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建枚举默认就是线程安全的，所以不需要担心线程同步，而且还能防止反序列化导致重新创建新的对象。通过EnumSingleton.INSTANCE来访问实例，只是平时很少看到代码中有人这么写。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/19/git冲突解决/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/19/git冲突解决/" itemprop="url">git冲突解决</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-19T00:00:00+08:00">
                2017-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/02/19/git冲突解决/" class="leancloud_visitors" data-flag-title="git冲突解决">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在Android系统定制工作中经常会遇上Codebase升级，冲突是经常发生的事情，一般项目组长会把那些冲突的提交生成一个个patch，分到对应模块的负责人，检查提交的代码并合入。</p>
<p>在合入patch的时候没有成功:<br>$ git am -k 0001-XXX.patch</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">patch未成功合入，错误信息</div><div class="line">...</div><div class="line">When you have resolved this problem run &quot;git am --resolved&quot;.</div><div class="line">If you would prefer to skip this patch, instead run &quot;git am --skip&quot;.</div><div class="line">To restore the original branch and stop patching run &quot;git am --abort&quot;.</div></pre></td></tr></table></figure>
<p>解决：</p>
<ul>
<li>$ git apply - -reject 0001-XXX.patch先合入没有冲突的部分，根据同目录下的*.rej文件找出冲突地方，解决这些冲突</li>
<li>$ git add <em>*</em> 将本次改动添加到缓存区</li>
<li>$ git am - -resolved 接受修改，完善patch</li>
<li>$ git push</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/14/Android Monitor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/14/Android Monitor/" itemprop="url">Android Monitor</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-14T00:00:00+08:00">
                2017-02-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/02/14/Android Monitor/" class="leancloud_visitors" data-flag-title="Android Monitor">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Android Studio 内置了四种性能监测工具Memory Monitor、Network Monitor、CPU Monitor、GPU Monitor，我们可以使用这些工具监测APP的状态，该文简单介绍下这些工具的使用</p>
<h2 id="Memory-Monitor"><a href="#Memory-Monitor" class="headerlink" title="Memory Monitor"></a>Memory Monitor</h2><p>Memory Monitor工具主要是用来监测APP的内存分配情况，判断是否存在内存泄漏。连接设备，选择好要监测的APP，如图所示：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/memory1.png" style="zoom:50%"></p>
<p>A：手动触发GC操作<br>B：获取当前的堆栈信息，生成.hprof文件<br>C：内存分配追踪工具，生成.alloc文件<br>D：已使用内存<br>E：剩余可用内存<br>通过与应用交互并在Memory Monitor中观察它是如何影响内存的使用，图表可以为你展示一些潜在的问题:<br>1.频繁的垃圾收集活动使应用运行缓慢。<br>2.应用耗尽内存导致app崩溃.<br>3.潜在的内存泄漏<br>正常情况下，上图中的D区域会随着时间的走势慢慢上升(就算你与APP没有任何交互)，直到E区域被用完，则会触发GC操作，释放内存，周而复始。如果你发现你的应用是静态的，但是E区域的内存很快就被用完了，即频繁的触发GC操作，这时你就应该引起重视，说不定你的代码中就存在着引起内存泄漏的隐患。</p>
<h3 id="Dump-Java-Heap"><a href="#Dump-Java-Heap" class="headerlink" title="Dump Java Heap"></a>Dump Java Heap</h3><p>使用场景：定位内存泄漏<br>点击上图中的B按钮开始检测APP，此时APP会变得很卡，容易发生ANR，一段时间过后会生成.hprof文件，如下图所示</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/memory2.png" style="zoom:50%"></p>
<p>这里的截图是我故意生成的一个能引起内存泄漏的例子，点击上图右上方的Analyzer Tasks按钮，若代码中存在内存泄漏隐患，在其下方会列出可能引起内存泄漏的Activity，如上图右下方的Leaked Activities，之后我们便可以结合左下方Reference Tree中指出的问题分析，如果你有源码的话还可以索引源码(右键-&gt;Jump to source)。实例代码如下：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/memory3.png" style="zoom:50%"></p>
<p>多次旋转屏幕，使得内存不断增加就容易引起内存泄漏。<br>上面的例子比较简单，可以直接通过Memory Monitor工具就能直接看出，在平常的开发中内存泄漏的问题往往没有这么简单，我们可以借助MAT工具分析。</p>
<h3 id="MAT"><a href="#MAT" class="headerlink" title="MAT"></a>MAT</h3><p><a href="https://eclipse.org/mat/downloads.php" target="_blank" rel="external">MAT(Memory Analyzer Tool)</a>，一个基于Eclipse的内存分析工具，是一个快速、功能丰富的JAVA heap分析工具，它可以帮助我们查找内存泄漏和减少内存消耗。使用内存分析工具从众多的对象中进行分析，快速的计算出在内存中对象的占用大小，看看是谁阻止了垃圾收集器的回收工作，并可以通过报表直观的查看到可能造成这种结果的对象。<br>在使用MAT工具前，我们需要将.hprof文件转换成标准的.hprof文件才能被识别，在Android Studio中可以通过以下操作转换</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/memory4.png" style="zoom:50%"></p>
<p>之后用MAT打开，显示如下</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/memory5.png" style="zoom:50%"></p>
<p>点击Histogram按钮</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/memory6.png" style="zoom:50%"></p>
<p>如图所示，该图会列出内存中所有的对象的个数即其占用的内存大小，其次，我们可以输入指定的Activity名称来缩小定位范围</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/memory7.png" style="zoom:50%"></p>
<p>如图所示，这里列出了MainActivity和其内部类MyThread的对象个数即占用的内存大小，接下来我们选择一个条目右键—&gt;Merge Shortest Paths to GC Roots(查看一个对象到GC Roots是否存在引用链相连接)-&gt;Merge Shortest Paths to GC Roots(排除虚引用/弱引用/软引用等等)，</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/memory8.png" style="zoom:50%"></p>
<p>如上图所示，就是可能存在内存泄漏的地方，具体还是要结合代码分析。</p>
<h3 id="GC-Roots"><a href="#GC-Roots" class="headerlink" title="GC Roots"></a>GC Roots</h3><p>对象存活的判定:<br>当一个对象不会再被使用的时候，我们会说这对象已经死亡。对象何时死亡，写程序的人应当是最清楚的。如果计算机也要弄清楚这件事情，就需要使用一些方法来进行对象存活判定，常见的方法有<strong>引用计数（Reference Counting）</strong>和<strong>有可达性分析（Reachability Analysis）</strong>两种。</p>
<p><strong>引用计数算法</strong>的大致思想是给对象中添加一个引用计数器，每当有一个地方引用它时，计数器值就加1；当引用失效时，计数器值就减1；任何时刻计数器为0的对象就是不可能再被使用的。<br>Java语言里面没有选用引用计数算法来管理内存，其中最主要原因是它没有一个优雅的方案解决对象之间相互循环引用的问题：<br>当两个对象互相引用，即使它们都无法被外界使用时，它们的引用计数器也不会为0。</p>
<p><strong>可达性算法</strong>的基本思路就是通过一系列的称为GC根节点（GC Roots）的对象作为起始点，从这些节点开始进行向下搜索，搜索所走过的路径成为引用链（Reference Chain），当一个对象到GC Roots没有任何引用链相连（用图论的话来说就是从GC Roots到这个对象不可达）时，则证明此对象是不可用的。</p>
<p>如上图，对象object 5、object 6、object 7虽然互相有关联，它们的引用并不为0，但是它们到GC Roots是不可达的，因此它们将会被判定为是可回收的对象。</p>
<h3 id="Allocation-Tracker"><a href="#Allocation-Tracker" class="headerlink" title="Allocation Tracker"></a>Allocation Tracker</h3><p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/memory1.png" style="zoom:50%"></p>
<p>在内存图中点击C，启动追踪，再次点击停止追踪，随后自动生成一个alloc结尾的文件，这个文件就记录了这次追踪到的所有数据。</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/memory10.png" style="zoom:50%"></p>
<p>如上图，我们可以看出这次操作中应用里的各个组件的分配次数与占用大小，若发现这两个数据有异常(分配过多，占用过大)，同样可以索引源码优化(前提是你有)，最下方的视图是以另一种较酷炫的方式呈现，感兴趣的可以具体结合文件操作。</p>
<h2 id="Network-Monitor"><a href="#Network-Monitor" class="headerlink" title="Network Monitor"></a>Network Monitor</h2><p><strong>Network Monitor</strong>是用于显示app网络请求的状态，频繁的网络请求是耗电的重要原因</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/network_monitor.png" style="zoom:50%"></p>
<p>如上图所示，Tx与Rx分别表示上下行的速度。</p>
<h2 id="GPU-Monitor"><a href="#GPU-Monitor" class="headerlink" title="GPU Monitor"></a>GPU Monitor</h2><p>GPU Monitor工具可以将进行UI渲染工作所花的时间表现出来，它记录下渲染线程准备以及进行描绘的时间。<br>Android系统每隔16ms发出VSYNC信号，触发对UI进行渲染，如果每次渲染都成功，这样就能够达到流畅的画面所需要的60fps，为了能够实现60fps，这意味着程序的大多数操作都必须在16ms内完成。</p>
<h3 id="Why-60fps"><a href="#Why-60fps" class="headerlink" title="Why 60fps?"></a>Why 60fps?</h3><p>我们通常都会提到60fps与16ms，可是知道为何会是以程序是否达到60fps来作为App性能的衡量标准吗？这是因为人眼与大脑之间的协作无法感知超过60fps的画面更新。</p>
<p>12fps大概类似手动快速翻动书籍的帧率，这明显是可以感知到不够顺滑的。24fps使得人眼感知的是连续线性的运动，这其实是归功于运动模糊的效果。24fps是电影胶圈通常使用的帧率，因为这个帧率已经足够支撑大部分电影画面需要表达的内容，同时能够最大的减少费用支出。但是低于30fps是无法顺畅表现绚丽的画面内容的，此时就需要用到60fps来达到想要的效果，当然超过60fps是没有必要的。</p>
<p>开发app的性能目标就是保持60fps，这意味着每一帧你只有16ms=1000/60的时间来处理所有的任务。</p>
<h3 id="Get-GPU-Trace"><a href="#Get-GPU-Trace" class="headerlink" title="Get GPU Trace"></a>Get GPU Trace</h3><p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/GPU_monitor.png" style="zoom:50%"></p>
<p>如上图所示，就是GPU Monitor的样子，点击上图获取gfxtrace按钮后，出现弹出框让你选择要监测的指定线程</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/gpumonitor1.png" style="zoom:50%"></p>
<p>选定后点击Trace</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/gpumonitor2.png" style="zoom:50%"></p>
<p>过程中会加载指定的lib,同时手机会弹出Dialog</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/gpumonitor3.png" style="zoom:50%"></p>
<p>环境需满足条件(手机root，安装GPU Debugging tools以及相关lib)，若不满足会提示：“Failed to connect to the graphics debugger”，假设这里已满足条件</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/gpumonitor4.png" style="zoom:50%"></p>
<p>判断是否在获取trace的依据是随着你的操作，上图的值不断增长，点击stop获得这个过程中生成的gfxtrace。</p>
<h2 id="GPU-Debugger"><a href="#GPU-Debugger" class="headerlink" title="GPU Debugger"></a>GPU Debugger</h2><p><strong>GPU Debuger</strong>是检查OpenGL ES 2.0或3.1渲染app图形的情况，打开之前生成的gfxtrace</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/gpudebugger1.png" style="zoom:50%"></p>
<p>渲染上下文:<br>渲染上下文是执行OpenGL ES命令所需的。它用来收集渲染一张图片所需的状态，包括相关的缓存区、阴影、纹理等。许多游戏应用程序只有一个上下文。更高级的应用程序可以使用超过一个上下文。<br>如果你选择了一个上下文，在GPU Commands 面板中的调用方法将按照调用顺序排列。</p>
<p>渲染时间线:<br>渲染时间线中的缩略图和GPU Commands 面板下的Frame一一对应，GPU Commands 面板显示了 OpenGL ES 生成每一帧的调用层级。</p>
<p>支持双buffer的apps渲染一帧的结尾函数是eglSwapBuffers()方法。</p>
<h3 id="Framebuffer-Pane"><a href="#Framebuffer-Pane" class="headerlink" title="Framebuffer Pane"></a>Framebuffer Pane</h3><p>在GPU Commands面板中选择一帧(生成这一个由多个Draw函数完成，在Draw函数中又有多个openGL ES方法)，Framebuffer 面板显示的内容取决于最后一个方法。</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/framebuffer1.png" style="zoom:50%"></p>
<p>对于上图红框中各项工具的具体作用可以查看<a href="https://developer.android.com/studio/debug/am-gpu-debugger-analysis.html" target="_blank" rel="external">官网</a>的描述，本地测试的时候作用不够明显。</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/framebuffer2.png" style="zoom:50%"></p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/framebuffer3.png" style="zoom:50%"></p>
<h3 id="Textures-Pane"><a href="#Textures-Pane" class="headerlink" title="Textures Pane"></a>Textures Pane</h3><p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/Textures%C2%A0Pane1.png" style="zoom:50%"></p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/Textures%C2%A0Pane2.png" style="zoom:50%"></p>
<h3 id="Geometry-pane"><a href="#Geometry-pane" class="headerlink" title="Geometry pane"></a>Geometry pane</h3><p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/Geometry%C2%A0pane1.png" style="zoom:50%"></p>
<p>几何面板的介绍同样本地的操作不够直观，可以直接查看<a href="https://developer.android.com/studio/debug/am-gpu-debugger-analysis.html" target="_blank" rel="external">官网</a>介绍</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/geometry2.png" style="zoom:50%"></p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/geomery3.png" style="zoom:50%"></p>
<h3 id="GPU-state-pane"><a href="#GPU-state-pane" class="headerlink" title="GPU state pane"></a>GPU state pane</h3><p>查看当前GPU的状态</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/gpustatepane.png" style="zoom:50%"></p>
<h3 id="Memory-pane"><a href="#Memory-pane" class="headerlink" title="Memory pane"></a>Memory pane</h3><p>查看所选方法的值在内存中的保存情况</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/memorypane.png" style="zoom:50%"></p>
<h2 id="CPU-Monitor"><a href="#CPU-Monitor" class="headerlink" title="CPU Monitor"></a>CPU Monitor</h2><p><strong>CPU Monitor</strong>可以对代码中的方法进行检测，同样可以生成一个Trace文件</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/cpumonitor1.png" style="zoom:50%"></p>
<p>生成的Trace文件如下图</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/cpumonitor2.png" style="zoom:50%"></p>
<p>通过方法的调用次数和所花时间来查看，通常判断方法是：<br>1.如果方法调用次数不多，但每次调用却需要花费很长的时间的函数，可能会有问题。<br>2.如果自身占用时间不长，但调用却非常频繁的函数也可能会有问题。</p>
<h2 id="Caputures"><a href="#Caputures" class="headerlink" title="Caputures"></a>Caputures</h2><p>Android Monitor捕获到的文件都在该路径下</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/captures1.png" style="zoom:50%"></p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/captures2.png" style="zoom:50%"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/01/14/Launcher Package变化监听机制(二)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/01/14/Launcher Package变化监听机制(二)/" itemprop="url">Launcher Package变化监听机制(二)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-01-14T00:00:00+08:00">
                2016-01-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2016/01/14/Launcher Package变化监听机制(二)/" class="leancloud_visitors" data-flag-title="Launcher Package变化监听机制(二)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇介绍了当安装应用的时候在桌面和菜单中生成图标的流程,但还是没有找到源头.那么就在源码中继续寻找答案.<br>LauncherModel实现了LauncherAppsCompat.OnAppsChangedCallbackCompat</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">code path: android/packages/apps/Launcher3/src/com/android/launcher3/compat/LauncherAppsCompat.java</div><div class="line"></div><div class="line">    public interface OnAppsChangedCallbackCompat &#123;</div><div class="line">        void onPackageRemoved(String packageName, UserHandleCompat user);</div><div class="line">        void onPackageAdded(String packageName, UserHandleCompat user);</div><div class="line">        void onPackageChanged(String packageName, UserHandleCompat user);</div><div class="line">        void onPackagesAvailable(String[] packageNames, UserHandleCompat user, boolean replacing);</div><div class="line">        void onPackagesUnavailable(String[] packageNames, UserHandleCompat user, boolean replacing);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>该接口声明了对package变化的一系列操作,LauncherModler是其具体实现。查看LauncherAppsCompat.OnAppsChangedCallbackCompat的调用，发现在LauncherAppsCompatVL的静态内部类WrappedCallback中有使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">code path: android/packages/apps/Launcher3/src/com/android/launcher3/compat/LauncherAppsCompatVL.java</div><div class="line"></div><div class="line">private static class WrappedCallback extends LauncherApps.Callback &#123;</div><div class="line">        private LauncherAppsCompat.OnAppsChangedCallbackCompat mCallback;</div><div class="line"></div><div class="line">        public WrappedCallback(LauncherAppsCompat.OnAppsChangedCallbackCompat callback) &#123;</div><div class="line">            mCallback = callback;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public void onPackageRemoved(String packageName, UserHandle user) &#123;</div><div class="line">            mCallback.onPackageRemoved(packageName, UserHandleCompat.fromUser(user));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public void onPackageAdded(String packageName, UserHandle user) &#123;</div><div class="line">            mCallback.onPackageAdded(packageName, UserHandleCompat.fromUser(user));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public void onPackageChanged(String packageName, UserHandle user) &#123;</div><div class="line">            mCallback.onPackageChanged(packageName, UserHandleCompat.fromUser(user));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public void onPackagesAvailable(String[] packageNames, UserHandle user, boolean replacing) &#123;</div><div class="line">            mCallback.onPackagesAvailable(packageNames, UserHandleCompat.fromUser(user), replacing);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public void onPackagesUnavailable(String[] packageNames, UserHandle user,</div><div class="line">                boolean replacing) &#123;</div><div class="line">            mCallback.onPackagesUnavailable(packageNames, UserHandleCompat.fromUser(user),</div><div class="line">                    replacing);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在这里又看到了熟悉的方法,从方法名上可以知道也是对于package变化的一系列调用.层层回调…看到这里依然没有找到源头,继续追踪,WrappedCallback在LauncherAppsCompatVL.java的addOnAppsChangedCallback中有使用到:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public void addOnAppsChangedCallback(LauncherAppsCompat.OnAppsChangedCallbackCompat callback) &#123;</div><div class="line">        WrappedCallback wrappedCallback = new WrappedCallback(callback);</div><div class="line">        synchronized (mCallbacks) &#123;</div><div class="line">            mCallbacks.put(callback, wrappedCallback);</div><div class="line">        &#125;</div><div class="line">        mLauncherApps.registerCallback(wrappedCallback);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>该方法中接收的callback就是LauncherModel,代码在LauncherAppState.java的构造函数中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LauncherAppsCompat.getInstance(sContext).addOnAppsChangedCallback(mModel);</div></pre></td></tr></table></figure>
<p>看到这里出现了一句比较重要的的代码,mLauncherApps.registerCallback(wrappedCallback);<br>这里的mLauncherApps是什么鬼?它在这里注册了监听回调；在LauncherAppsCompatVL.java的构造函数中对mLauncherApps进行了初始化，代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">LauncherAppsCompatVL(Context context) &#123;</div><div class="line">        super();</div><div class="line">        mLauncherApps = (LauncherApps) context.getSystemService(&quot;launcherapps&quot;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>mLauncherApps貌似是个系统服务,继续查看源头:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">code path:frameworks/base/core/java/android/content/pm</div><div class="line">public void registerCallback(Callback callback, Handler handler) &#123;</div><div class="line">        synchronized (this) &#123;</div><div class="line">            if (callback != null &amp;&amp; findCallbackLocked(callback) &lt; 0) &#123;</div><div class="line">                boolean addedFirstCallback = mCallbacks.size() == 0;</div><div class="line">                addCallbackLocked(callback, handler);</div><div class="line">                if (addedFirstCallback) &#123;</div><div class="line">                    try &#123;</div><div class="line">                        mService.addOnAppsChangedListener(mAppsChangedListener);</div><div class="line">                    &#125; catch (RemoteException re) &#123;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>通过一个mService添加了一个Listener,之后就是传递到Launcher的层层回调。那这里的mService又是什么呢?在LauncherApps.java的构造函数中进行了初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public LauncherApps(Context context, ILauncherApps service) &#123;</div><div class="line">        mContext = context;</div><div class="line">        mService = service;</div><div class="line">        mPm = context.getPackageManager();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里的service是ILauncherApps</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">code path: frameworks/base/core/java/android/content/pm/ILauncherApps.aidl</div><div class="line">interface ILauncherApps &#123;</div><div class="line">    void addOnAppsChangedListener(in IOnAppsChangedListener listener);</div><div class="line">    void removeOnAppsChangedListener(in IOnAppsChangedListener listener);</div><div class="line">    List&lt;ResolveInfo&gt; getLauncherActivities(String packageName, in UserHandle user);</div><div class="line">    ResolveInfo resolveActivity(in Intent intent, in UserHandle user);</div><div class="line">    void startActivityAsUser(in ComponentName component, in Rect sourceBounds,</div><div class="line">            in Bundle opts, in UserHandle user);</div><div class="line">    void showAppDetailsAsUser(in ComponentName component, in Rect sourceBounds,</div><div class="line">            in Bundle opts, in UserHandle user);</div><div class="line">    boolean isPackageEnabled(String packageName, in UserHandle user);</div><div class="line">    boolean isActivityEnabled(in ComponentName component, in UserHandle user);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看到有addOnAppsChangedListener,removeOnAppsChangedListener(其他暂不关注)，通过名字可以知道这两个方法就是package监听器，ILauncherApps.aidl的具体实现是在LauncherAppsService.java的内部类LauncherAppsImpl</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">code path:frameworks/base/services/core/java/com/android/server/pm/LauncherAppsService.java</div><div class="line">public void addOnAppsChangedListener(IOnAppsChangedListener listener) throws RemoteException &#123;</div><div class="line">            synchronized (mListeners) &#123;</div><div class="line">                if (DEBUG) &#123;</div><div class="line">                    Log.d(TAG, &quot;Adding listener from &quot; + Binder.getCallingUserHandle());</div><div class="line">                &#125;</div><div class="line">                if (mListeners.getRegisteredCallbackCount() == 0) &#123;</div><div class="line">                    if (DEBUG) &#123;</div><div class="line">                        Log.d(TAG, &quot;Starting package monitoring&quot;);</div><div class="line">                    &#125;</div><div class="line">                    startWatchingPackageBroadcasts();</div><div class="line">                &#125;</div><div class="line">                mListeners.unregister(listener);</div><div class="line">                mListeners.register(listener, Binder.getCallingUserHandle());</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>判断当前的callback==0时就会调用startWatchingPackageBroadcasts(),从方法上看像启动广播监听</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">private void startWatchingPackageBroadcasts() &#123;</div><div class="line">            mPackageMonitor.register(mContext, null, UserHandle.ALL, true);</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>mPackageMonitor是LauncherAppsImpl的内部类，继承PackageMonitor，PackageMonitor又继承BroadcastReceiver，所以这鬼东西是个广播，mPackageMonitor调用父类的register方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">code path: frameworks/base/core/java/com/android/internal/content/PackageMonitor.java</div><div class="line">static &#123;</div><div class="line">        sPackageFilt.addAction(Intent.ACTION_PACKAGE_ADDED);</div><div class="line">        sPackageFilt.addAction(Intent.ACTION_PACKAGE_REMOVED);</div><div class="line">        sPackageFilt.addAction(Intent.ACTION_PACKAGE_CHANGED);</div><div class="line">        sPackageFilt.addAction(Intent.ACTION_QUERY_PACKAGE_RESTART);</div><div class="line">        sPackageFilt.addAction(Intent.ACTION_PACKAGE_RESTARTED);</div><div class="line">        sPackageFilt.addDataScheme(&quot;package&quot;);</div><div class="line">        sNonDataFilt.addAction(Intent.ACTION_UID_REMOVED);</div><div class="line">        sNonDataFilt.addAction(Intent.ACTION_USER_STOPPED);</div><div class="line">        sExternalFilt.addAction(Intent.ACTION_EXTERNAL_APPLICATIONS_AVAILABLE);</div><div class="line">        sExternalFilt.addAction(Intent.ACTION_EXTERNAL_APPLICATIONS_UNAVAILABLE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">public void register(Context context, Looper thread, UserHandle user,</div><div class="line">            boolean externalStorage) &#123;</div><div class="line">        if (mRegisteredContext != null) &#123;</div><div class="line">            throw new IllegalStateException(&quot;Already registered&quot;);</div><div class="line">        &#125;</div><div class="line">        mRegisteredContext = context;</div><div class="line">        if (thread == null) &#123;</div><div class="line">            mRegisteredHandler = BackgroundThread.getHandler();</div><div class="line">        &#125; else &#123;</div><div class="line">            mRegisteredHandler = new Handler(thread);</div><div class="line">        &#125;</div><div class="line">        if (user != null) &#123;</div><div class="line">            context.registerReceiverAsUser(this, user, sPackageFilt, null, mRegisteredHandler);</div><div class="line">            context.registerReceiverAsUser(this, user, sNonDataFilt, null, mRegisteredHandler);</div><div class="line">            if (externalStorage) &#123;</div><div class="line">                context.registerReceiverAsUser(this, user, sExternalFilt, null,</div><div class="line">                        mRegisteredHandler);</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            context.registerReceiver(this, sPackageFilt, null, mRegisteredHandler);</div><div class="line">            context.registerReceiver(this, sNonDataFilt, null, mRegisteredHandler);</div><div class="line">            if (externalStorage) &#123;</div><div class="line">                context.registerReceiver(this, sExternalFilt, null, mRegisteredHandler);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>看到这里就水落石出了，这里定义了广播过滤器，并且监听不同的用户。<br>监听到广播后肯定要有对应的处理，我们回到LauncherAppsImpl的addOnAppsChangedListener方法，这里传入了一个IOnAppsChangedListener的listener,参数也是个AIDL的接口，代码路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">code path: frameworks/base/core/java/android/content/pm/IOnAppsChangedListener.aidl</div><div class="line">oneway interface IOnAppsChangedListener &#123;</div><div class="line">    void onPackageRemoved(in UserHandle user, String packageName);</div><div class="line">    void onPackageAdded(in UserHandle user, String packageName);</div><div class="line">    void onPackageChanged(in UserHandle user, String packageName);</div><div class="line">    void onPackagesAvailable(in UserHandle user, in String[] packageNames, boolean replacing);</div><div class="line">    void onPackagesUnavailable(in UserHandle user, in String[] packageNames, boolean replacing);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用oneway关键字定义的接口，这就表明它的所有方法都采用非阻塞式方式。该接口的具体实现是在LauncherApps.java中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">private IOnAppsChangedListener.Stub mAppsChangedListener = new IOnAppsChangedListener.Stub() &#123;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void onPackageRemoved(UserHandle user, String packageName)</div><div class="line">                throws RemoteException &#123;</div><div class="line">            if (DEBUG) &#123;</div><div class="line">                Log.d(TAG, &quot;onPackageRemoved &quot; + user.getIdentifier() + &quot;,&quot; + packageName);</div><div class="line">            &#125;</div><div class="line">            synchronized (LauncherApps.this) &#123;</div><div class="line">                for (CallbackMessageHandler callback : mCallbacks) &#123;</div><div class="line">                    callback.postOnPackageRemoved(packageName, user);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void onPackageChanged(UserHandle user, String packageName) throws RemoteException &#123;</div><div class="line">            if (DEBUG) &#123;</div><div class="line">                Log.d(TAG, &quot;onPackageChanged &quot; + user.getIdentifier() + &quot;,&quot; + packageName);</div><div class="line">            &#125;</div><div class="line">            synchronized (LauncherApps.this) &#123;</div><div class="line">                for (CallbackMessageHandler callback : mCallbacks) &#123;</div><div class="line">                    callback.postOnPackageChanged(packageName, user);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void onPackageAdded(UserHandle user, String packageName) throws RemoteException &#123;</div><div class="line">            if (DEBUG) &#123;</div><div class="line">                Log.d(TAG, &quot;onPackageAdded &quot; + user.getIdentifier() + &quot;,&quot; + packageName);</div><div class="line">            &#125;</div><div class="line">            synchronized (LauncherApps.this) &#123;</div><div class="line">                for (CallbackMessageHandler callback : mCallbacks) &#123;</div><div class="line">                    callback.postOnPackageAdded(packageName, user);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void onPackagesAvailable(UserHandle user, String[] packageNames, boolean replacing)</div><div class="line">                throws RemoteException &#123;</div><div class="line">            if (DEBUG) &#123;</div><div class="line">                Log.d(TAG, &quot;onPackagesAvailable &quot; + user.getIdentifier() + &quot;,&quot; + packageNames);</div><div class="line">            &#125;</div><div class="line">            synchronized (LauncherApps.this) &#123;</div><div class="line">                for (CallbackMessageHandler callback : mCallbacks) &#123;</div><div class="line">                    callback.postOnPackagesAvailable(packageNames, user, replacing);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void onPackagesUnavailable(UserHandle user, String[] packageNames, boolean replacing)</div><div class="line">                throws RemoteException &#123;</div><div class="line">            if (DEBUG) &#123;</div><div class="line">                Log.d(TAG, &quot;onPackagesUnavailable &quot; + user.getIdentifier() + &quot;,&quot; + packageNames);</div><div class="line">            &#125;</div><div class="line">            synchronized (LauncherApps.this) &#123;</div><div class="line">                for (CallbackMessageHandler callback : mCallbacks) &#123;</div><div class="line">                    callback.postOnPackagesUnavailable(packageNames, user, replacing);</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<p>这里就以接收到新增应用的广播,调用到onPackageAdded方法,可以看到循环遍历callback之后调用callback的postOnPackageAdded方法处理,callback是CallbackMessageHandler,继承Handler</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line">private static class CallbackMessageHandler extends Handler &#123;</div><div class="line">        private static final int MSG_ADDED = 1;</div><div class="line">        private static final int MSG_REMOVED = 2;</div><div class="line">        private static final int MSG_CHANGED = 3;</div><div class="line">        private static final int MSG_AVAILABLE = 4;</div><div class="line">        private static final int MSG_UNAVAILABLE = 5;</div><div class="line"></div><div class="line">        private LauncherApps.Callback mCallback;</div><div class="line"></div><div class="line">        private static class CallbackInfo &#123;</div><div class="line">            String[] packageNames;</div><div class="line">            String packageName;</div><div class="line">            boolean replacing;</div><div class="line">            UserHandle user;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public CallbackMessageHandler(Looper looper, LauncherApps.Callback callback) &#123;</div><div class="line">            super(looper, null, true);</div><div class="line">            mCallback = callback;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void handleMessage(Message msg) &#123;</div><div class="line">            if (mCallback == null || !(msg.obj instanceof CallbackInfo)) &#123;</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">            CallbackInfo info = (CallbackInfo) msg.obj;</div><div class="line">            switch (msg.what) &#123;</div><div class="line">                case MSG_ADDED:</div><div class="line">                    Log.d(&quot;hu&quot;, &quot;LauncherApps handleMessage: onPackageAdded run&quot;);</div><div class="line">                    mCallback.onPackageAdded(info.packageName, info.user);</div><div class="line">                    break;</div><div class="line">                case MSG_REMOVED:</div><div class="line">                    mCallback.onPackageRemoved(info.packageName, info.user);</div><div class="line">                    break;</div><div class="line">                case MSG_CHANGED:</div><div class="line">                    mCallback.onPackageChanged(info.packageName, info.user);</div><div class="line">                    break;</div><div class="line">                case MSG_AVAILABLE:</div><div class="line">                    mCallback.onPackagesAvailable(info.packageNames, info.user, info.replacing);</div><div class="line">                    break;</div><div class="line">                case MSG_UNAVAILABLE:</div><div class="line">                    mCallback.onPackagesUnavailable(info.packageNames, info.user, info.replacing);</div><div class="line">                    break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public void postOnPackageAdded(String packageName, UserHandle user) &#123;</div><div class="line">            CallbackInfo info = new CallbackInfo();</div><div class="line">            info.packageName = packageName;</div><div class="line">            info.user = user;</div><div class="line">            obtainMessage(MSG_ADDED, info).sendToTarget();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public void postOnPackageRemoved(String packageName, UserHandle user) &#123;</div><div class="line">            CallbackInfo info = new CallbackInfo();</div><div class="line">            info.packageName = packageName;</div><div class="line">            info.user = user;</div><div class="line">            obtainMessage(MSG_REMOVED, info).sendToTarget();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public void postOnPackageChanged(String packageName, UserHandle user) &#123;</div><div class="line">            CallbackInfo info = new CallbackInfo();</div><div class="line">            info.packageName = packageName;</div><div class="line">            info.user = user;</div><div class="line">            obtainMessage(MSG_CHANGED, info).sendToTarget();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public void postOnPackagesAvailable(String[] packageNames, UserHandle user,</div><div class="line">                boolean replacing) &#123;</div><div class="line">            CallbackInfo info = new CallbackInfo();</div><div class="line">            info.packageNames = packageNames;</div><div class="line">            info.replacing = replacing;</div><div class="line">            info.user = user;</div><div class="line">            obtainMessage(MSG_AVAILABLE, info).sendToTarget();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public void postOnPackagesUnavailable(String[] packageNames, UserHandle user,</div><div class="line">                boolean replacing) &#123;</div><div class="line">            CallbackInfo info = new CallbackInfo();</div><div class="line">            info.packageNames = packageNames;</div><div class="line">            info.replacing = replacing;</div><div class="line">            info.user = user;</div><div class="line">            obtainMessage(MSG_UNAVAILABLE, info).sendToTarget();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这就是处理具体操作的根源。查看哪里又调用了CallbackMessageHandler</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">private void addCallbackLocked(Callback callback, Handler handler) &#123;</div><div class="line">        // Remove if already present.</div><div class="line">        removeCallbackLocked(callback);</div><div class="line">        if (handler == null) &#123;</div><div class="line">            handler = new Handler();</div><div class="line">        &#125;</div><div class="line">        CallbackMessageHandler toAdd = new CallbackMessageHandler(handler.getLooper(), callback);</div><div class="line">        mCallbacks.add(toAdd);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>registerCallback又调用了addCallbackLocked</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public void registerCallback(Callback callback, Handler handler) &#123;</div><div class="line">        synchronized (this) &#123;</div><div class="line">            if (callback != null &amp;&amp; findCallbackLocked(callback) &lt; 0) &#123;</div><div class="line">                boolean addedFirstCallback = mCallbacks.size() == 0;</div><div class="line">                addCallbackLocked(callback, handler);</div><div class="line">                if (addedFirstCallback) &#123;</div><div class="line">                    try &#123;</div><div class="line">                        mService.addOnAppsChangedListener(mAppsChangedListener);</div><div class="line">                    &#125; catch (RemoteException re) &#123;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>之后Launcher中LauncherAppsCompatVL又通过addOnAppsChangedCallback调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public void addOnAppsChangedCallback(LauncherAppsCompat.OnAppsChangedCallbackCompat callback) &#123;</div><div class="line">        WrappedCallback wrappedCallback = new WrappedCallback(callback);</div><div class="line">        synchronized (mCallbacks) &#123;</div><div class="line">            mCallbacks.put(callback, wrappedCallback);</div><div class="line">        &#125;</div><div class="line">        mLauncherApps.registerCallback(wrappedCallback);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>最后一切就都串起来了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg"
              alt="HuYounger" />
          
            <p class="site-author-name" itemprop="name">HuYounger</p>
            <p class="site-description motion-element" itemprop="description">Less is more</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Rkhcy" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 &mdash; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HuYounger</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("rcy0CA7vKecGb0eQxcnHdO3i-gzGzoHsz", "N9PBf4dqgEeMJL7klXsAli0a");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
