<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2" />






<meta name="description" content="Less is more">
<meta property="og:type" content="website">
<meta property="og:title" content="HuYounger&#39;s Note">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="HuYounger&#39;s Note">
<meta property="og:description" content="Less is more">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HuYounger&#39;s Note">
<meta name="twitter:description" content="Less is more">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>HuYounger's Note</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HuYounger's Note</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/12/ViewStub学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/12/ViewStub学习/" itemprop="url">ViewStub学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-12T00:00:00+08:00">
                2017-09-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/09/12/ViewStub学习/" class="leancloud_visitors" data-flag-title="ViewStub学习">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>一提到ViewStub，可能很多人就会想到布局性能优化，那么它具体是怎么实现的呢？先看下<a href="https://developer.android.com/reference/android/view/ViewStub.html" target="_blank" rel="external">官方</a>的介绍</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewStub.png"></p>
<blockquote>
<p>A ViewStub is an invisible, zero-sized View that can be used to lazily inflate layout resources at runtime. When a ViewStub is made visible, or when inflate() is invoked, the layout resource is inflated. The ViewStub then replaces itself in its parent with the inflated View or Views. Therefore, the ViewStub exists in the view hierarchy until setVisibility(int) or inflate() is invoked. The inflated View is added to the ViewStub’s parent with the ViewStub’s layout parameters. Similarly, you can define/override the inflate View’s id by using the ViewStub’s inflatedId property</p>
</blockquote>
<p>翻译如下：</p>
<ul>
<li>ViewStub是个不可见的、大小为0的View，用于在运行过程中延迟加载布局。</li>
<li>当ViewStub被设置为可见或者inflate()方法被调用，该布局才会被加载，之后ViewStub自身会被所加载的布局替换掉，ViewStub就不再存在于视图层级中。</li>
<li>被加载布局会使用ViewStub的布局参数，我们可以定义或者重写被加载的布局id通过ViewStub的inflatedId属性。</li>
</ul>
<p>还是比较好理解的，官方比较推崇的用于获取加载的布局的写法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ViewStub stub = findViewById(R.id.stub);</div><div class="line">View inflated = stub.inflate();</div></pre></td></tr></table></figure>
<p>下面通过一个例子来验证上面这些概念。</p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>MainActivity.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends Activity &#123;</div><div class="line"></div><div class="line">    Button button;</div><div class="line">    ViewStub viewStub;</div><div class="line">    View inflateView;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        button = (Button) findViewById(R.id.button);</div><div class="line">        viewStub = (ViewStub) findViewById(R.id.stub);</div><div class="line">        button.setOnClickListener(new View.OnClickListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void onClick(View view) &#123;</div><div class="line">                inflateView = viewStub.inflate();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>view_stub.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:orientation=&quot;vertical&quot; android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;&gt;</div><div class="line"></div><div class="line">    &lt;ImageView</div><div class="line">        android:id=&quot;@+id/imageView&quot;</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:background=&quot;@mipmap/ic_launcher&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/button2&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;Button1&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/button3&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;Button2&quot; /&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<p>activity_main.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;</div><div class="line">    tools:context=&quot;com.example.huchengyang.viewstub.MainActivity&quot;&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/button&quot;</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;button1&quot; /&gt;</div><div class="line">    &lt;ViewStub</div><div class="line">        android:id=&quot;@+id/stub&quot;</div><div class="line">        android:inflatedId=&quot;@+id/subTree&quot;</div><div class="line">        android:layout=&quot;@layout/view_stub&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot; /&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<p>代码很简单，运行效果如下：</p>
<p> <img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewStub1.png" style="zoom:25%"></p>
<p>通过Hierarchy View查看此时的布局层级如下：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewStub2.png" style="zoom:50%"></p>
<p>点击Button1后：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewStub3.png" style="zoom:25%"></p>
<p>Hierarchy View查看布局层级如下:</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewStub4.png" style="zoom:50%"></p>
<p>根据布局层级的显示确实符合官网的描述，当调用inflate()方法后，在布局层级中ViewStub就被代替了。在接触ViewStub之前我一直有个疑问，要想控制布局显示与否，通过设置Visibility属性不就好了么？我们改下activity_main的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;</div><div class="line">    tools:context=&quot;com.example.huchengyang.viewstub.MainActivity&quot;&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/button&quot;</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;button1&quot; /&gt;</div><div class="line">&lt;!--    &lt;ViewStub</div><div class="line">        android:id=&quot;@+id/stub&quot;</div><div class="line">        android:inflatedId=&quot;@+id/subTree&quot;</div><div class="line">        android:layout=&quot;@layout/view_stub&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot; /&gt;--&gt;</div><div class="line">    &lt;LinearLayout</div><div class="line">        android:id=&quot;@+id/linear&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot;</div><div class="line">        android:orientation=&quot;vertical&quot;</div><div class="line">        android:visibility=&quot;gone&quot;&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/imageView&quot;</div><div class="line">            android:layout_width=&quot;wrap_content&quot;</div><div class="line">            android:layout_height=&quot;wrap_content&quot;</div><div class="line">            android:background=&quot;@mipmap/ic_launcher&quot; /&gt;</div><div class="line"></div><div class="line">        &lt;Button</div><div class="line">            android:id=&quot;@+id/button2&quot;</div><div class="line">            android:layout_width=&quot;match_parent&quot;</div><div class="line">            android:layout_height=&quot;wrap_content&quot;</div><div class="line">            android:text=&quot;Button1&quot; /&gt;</div><div class="line"></div><div class="line">        &lt;Button</div><div class="line">            android:id=&quot;@+id/button3&quot;</div><div class="line">            android:layout_width=&quot;match_parent&quot;</div><div class="line">            android:layout_height=&quot;wrap_content&quot;</div><div class="line">            android:text=&quot;Button2&quot; /&gt;</div><div class="line">    &lt;/LinearLayout&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<p>运行如下：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewStub1.png" style="zoom:25%"></p>
<p>再看下布局层级：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewStub5.png" style="zoom:50%"></p>
<p>View的visibility属性设置成gone虽然在界面上看不到，但是布局却已经被加载进去了，如果该布局内容很复杂，那么整体的布局性能就会下降，而使用ViewStub就能延迟加载，提高布局性能。</p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p><a href="https://developer.android.com/training/improving-layouts/loading-ondemand.html#ViewStub" target="_blank" rel="external">官网</a>的提醒：</p>
<blockquote>
<p><strong>Note:</strong> One drawback of <code>ViewStub</code> is that it doesn’t currently support the <code>&lt;merge&gt;</code> tag in the layouts to be inflated.</p>
</blockquote>
<p>指出当前ViewStub不支持<merge>标签。修改下view_stub.xml</merge></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;merge&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:orientation=&quot;vertical&quot; android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;&gt;</div><div class="line"></div><div class="line">    &lt;ImageView</div><div class="line">        android:id=&quot;@+id/imageView&quot;</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:background=&quot;@mipmap/ic_launcher&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/button2&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;Button1&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/button3&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;Button2&quot; /&gt;</div><div class="line">&lt;/LinearLayout&gt;</div><div class="line">&lt;/merge&gt;</div></pre></td></tr></table></figure>
<p>点击button1后得到如下崩溃：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">FATAL EXCEPTION: main</div><div class="line">                    Process: com.example.huchengyang.viewstub, PID: 6174</div><div class="line">                    android.view.InflateException: Binary XML file line #2: &lt;merge /&gt; can be used only with a valid ViewGroup root and attachToRoot=true</div><div class="line">                    at android.view.LayoutInflater.inflate(LayoutInflater.java:539)</div><div class="line">                    at android.view.LayoutInflater.inflate(LayoutInflater.java:423)</div><div class="line">                    at android.view.ViewStub.inflate(ViewStub.java:259)</div><div class="line">                    at com.example.huchengyang.viewstub.MainActivity$1.onClick(MainActivity.java:23)</div><div class="line">                    at android.view.View.performClick(View.java:5198)</div><div class="line">                    at android.view.View$PerformClick.run(View.java:21147)</div><div class="line">                    at android.os.Handler.handleCallback(Handler.java:739)</div><div class="line">                    at android.os.Handler.dispatchMessage(Handler.java:95)</div><div class="line">                    at android.os.Looper.loop(Looper.java:148)</div><div class="line">                    at android.app.ActivityThread.main(ActivityThread.java:5417)</div><div class="line">                    at java.lang.reflect.Method.invoke(Native Method)</div><div class="line">                    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:726)</div><div class="line">                    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:616)</div></pre></td></tr></table></figure>
<p>可见，ViewStub确实不支持merge标签。</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>前面说过通过setVisibility()和inflate()方法可以实现延迟加载，那么它具体是怎么实现的呢，有必要看下源码（以下代码分析基于android-25）。不看不知道，一看吓一跳！整个ViewStub的源码一共才321行，而且绿油油的注释就占了一半，所以我们完全可以自己撸一个XXXViewStub！</p>
<p>首先看下ViewStub的构造函数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public ViewStub(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes) &#123;</div><div class="line">        super(context);</div><div class="line"></div><div class="line">        final TypedArray a = context.obtainStyledAttributes(attrs,</div><div class="line">                R.styleable.ViewStub, defStyleAttr, defStyleRes);</div><div class="line">        mInflatedId = a.getResourceId(R.styleable.ViewStub_inflatedId, NO_ID);</div><div class="line">        mLayoutResource = a.getResourceId(R.styleable.ViewStub_layout, 0);</div><div class="line">        mID = a.getResourceId(R.styleable.ViewStub_id, NO_ID);</div><div class="line">        a.recycle();</div><div class="line">        setVisibility(GONE);</div><div class="line">        setWillNotDraw(true);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看到初始化的时候执行了setVisibility(GONE)，ViewStub重写了该方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> * When visibility is set to &#123;@link #VISIBLE&#125; or &#123;@link #INVISIBLE&#125;,</div><div class="line"> * &#123;@link #inflate()&#125; is invoked and this StubbedView is replaced in its parent</div><div class="line"> * by the inflated layout resource. After that calls to this function are passed</div><div class="line"> * through to the inflated view.</div><div class="line"> *</div><div class="line"> * @param visibility One of &#123;@link #VISIBLE&#125;, &#123;@link #INVISIBLE&#125;, or &#123;@link #GONE&#125;.</div><div class="line"> *</div><div class="line"> * @see #inflate() </div><div class="line"> */</div><div class="line">@Override</div><div class="line">@android.view.RemotableViewMethod</div><div class="line">public void setVisibility(int visibility) &#123;</div><div class="line">    if (mInflatedViewRef != null) &#123;</div><div class="line">        View view = mInflatedViewRef.get();</div><div class="line">        if (view != null) &#123;</div><div class="line">            view.setVisibility(visibility);</div><div class="line">        &#125; else &#123;</div><div class="line">            throw new IllegalStateException(&quot;setVisibility called on un-referenced view&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        super.setVisibility(visibility);</div><div class="line">        if (visibility == VISIBLE || visibility == INVISIBLE) &#123;</div><div class="line">            inflate();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的mInflatedViewRef是个弱引用的View，它的初始化在inflate()中，所以当visibility为GONE时，调用View的setVisibility就结束了；当我们设置该属性为VISIBLE时，执行inflate()，看下该方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> * Inflates the layout resource identified by &#123;@link #getLayoutResource()&#125;</div><div class="line"> * and replaces this StubbedView in its parent by the inflated layout resource.</div><div class="line"> *</div><div class="line"> * @return The inflated layout resource.</div><div class="line"> *</div><div class="line"> */</div><div class="line">public View inflate() &#123;</div><div class="line">    final ViewParent viewParent = getParent();</div><div class="line"></div><div class="line">    if (viewParent != null &amp;&amp; viewParent instanceof ViewGroup) &#123;</div><div class="line">        if (mLayoutResource != 0) &#123;</div><div class="line">            final ViewGroup parent = (ViewGroup) viewParent;</div><div class="line">            final LayoutInflater factory;</div><div class="line">            if (mInflater != null) &#123;</div><div class="line">                factory = mInflater;</div><div class="line">            &#125; else &#123;</div><div class="line">                factory = LayoutInflater.from(mContext);</div><div class="line">            &#125;</div><div class="line">            final View view = factory.inflate(mLayoutResource, parent,</div><div class="line">                    false);</div><div class="line"></div><div class="line">            if (mInflatedId != NO_ID) &#123;</div><div class="line">                view.setId(mInflatedId);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            final int index = parent.indexOfChild(this);</div><div class="line">            parent.removeViewInLayout(this);</div><div class="line"></div><div class="line">            final ViewGroup.LayoutParams layoutParams = getLayoutParams();</div><div class="line">            if (layoutParams != null) &#123;</div><div class="line">                parent.addView(view, index, layoutParams);</div><div class="line">            &#125; else &#123;</div><div class="line">                parent.addView(view, index);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mInflatedViewRef = new WeakReference&lt;View&gt;(view);</div><div class="line"></div><div class="line">            if (mInflateListener != null) &#123;</div><div class="line">                mInflateListener.onInflate(this, view);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            return view;</div><div class="line">        &#125; else &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;ViewStub must have a valid layoutResource&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        throw new IllegalStateException(&quot;ViewStub must have a non-null ViewGroup viewParent&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码也很好懂，首先获取ViewStub所在的父布局，父布局必须不为空且所要加载的布局是个ViewGroup类型才往下走，mLayoutResource就是我们在xml里指定的android:layout，如果没配置也会报错，这些都满足后就会通过LayoutInflater去加载布局，设置布局id，也就是我们在xml里指定的android:inflatedId，然后找到ViewStub，并把它从布局里删掉，再根据ViewStub的布局参数，将所以加载的布局加到父布局中，并且对弱引用初始化。因此，如果重复调用ViewStub的inflate()会报错，但是重复调用setVisibility()不会。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/23/Java适配器模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/23/Java适配器模式/" itemprop="url">Java适配器模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-23T00:00:00+08:00">
                2017-08-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/08/23/Java适配器模式/" class="leancloud_visitors" data-flag-title="Java适配器模式">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>维基百科上的描述：</p>
<blockquote>
<p>In software engineering, the adapter pattern is a software design pattern that allows the interface of an existing class to be used as another interface. It is often used to make existing classes work with others without modifying their source code.</p>
</blockquote>
<p>简单理解就是适配器模式可以将一个对象进行包装，使得该对象与其他类兼容。</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>比如现实生活中如果想将存储卡上的一些资料传输到电脑中，需要用到和电脑端口兼容的适配器，读卡器就是适配器；再比如电源适配器，三角插头不能连接两脚插头，需要使用电源适配器，使其与两个插脚插座兼容。</p>
<h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><p>有一个快艇接口<code>SpeedBoat</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by Robert on 2017/8/23.</div><div class="line"> * 快艇</div><div class="line"> */</div><div class="line"></div><div class="line">public interface SpeedBoat &#123;</div><div class="line">    void speed();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有个船长，他只会开快艇</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by Robert on 2017/8/23.</div><div class="line"> * 船长</div><div class="line"> */</div><div class="line"></div><div class="line">public class Captain implements SpeedBoat &#123;</div><div class="line">    SpeedBoat speedBoat;</div><div class="line"></div><div class="line">    public Captain(SpeedBoat speedBoat) &#123;</div><div class="line">        this.speedBoat = speedBoat;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void speed() &#123;</div><div class="line">        speedBoat.speed();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有一天船长惹事被人追着砍，准备跑路，刚好看到一艘国产快艇</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by Robert on 2017/8/23.</div><div class="line"> * 国产快艇</div><div class="line"> */</div><div class="line"></div><div class="line">public class ChinaSpeedBoat implements SpeedBoat &#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void speed() &#123;</div><div class="line">        System.out.println(&quot;船长开中国快艇&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>于是一顿操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class Main &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Captain captain1 = new Captain(new ChinaSpeedBoat());</div><div class="line">        captain1.speed();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">打印：船长开中国快艇</div></pre></td></tr></table></figure>
<p>跑路成功没毛病，这天船长又惹事被人追着砍，准备跑路，结果附近只有一艘渔船</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by Robert on 2017/8/23.</div><div class="line"> * 渔船</div><div class="line"> */</div><div class="line"></div><div class="line">public class FishingBoat &#123;</div><div class="line">    public void fishing() &#123;</div><div class="line">        System.out.print(&quot;船长开渔船&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了不被砍，船长可以管渔船叫爹(extends FishingBoat)，这样他就有开渔船的功能了，但是显然这很不符合逻辑，况且下次如果被砍的时候遇到的是冲锋艇或者航母，还是不能解决问题，因此需要创建一个适配器，让船长用开快艇的技能来开渔船</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by Robert on 2017/8/23.</div><div class="line"> */</div><div class="line"></div><div class="line">public class FinishingBoatAdapter implements SpeedBoat &#123;</div><div class="line">    private FishingBoat boat;</div><div class="line"></div><div class="line">    public FinishingBoatAdapter() &#123;</div><div class="line">        boat = new FishingBoat();</div><div class="line">    &#125;</div><div class="line">    @Override</div><div class="line">    public void speed() &#123;</div><div class="line">        boat.fishing();</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一顿操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class Main &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Captain captain2 = new Captain(new FinishingBoatAdapter());</div><div class="line">        captain2.speed();</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">打印：船长开渔船</div></pre></td></tr></table></figure>
<p>不管下次遇到什么船，用适配器的方法都能跑路成功。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/07/PhysicsBasedAnimation学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/07/PhysicsBasedAnimation学习/" itemprop="url">PhysicsBasedAnimation学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-07T00:00:00+08:00">
                2017-07-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/07/07/PhysicsBasedAnimation学习/" class="leancloud_visitors" data-flag-title="PhysicsBasedAnimation学习">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Google I/O ‘17推出了许多新的特性，在动画这一块又有新的API供开发者使用，具体视频请见<a href="https://www.youtube.com/watch?v=BNcODK-Ju0g" target="_blank" rel="external">Android Animations Spring to Life (Google I/O ‘17)</a>，主要介绍了Physics-based Animations，在动画API中引入了<code>DynamicAnimation</code>，并介绍了它的两个子类<code>FlingAnimation</code>和<code>SpringAnimation</code>的使用，开发者可以使用新的API创建更加动态化的动画。</p>
<h2 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h2><p>Physics-based Animations，翻译过来就是基于物理的动画，<a href="https://developer.android.com/topic/libraries/support-library/preview/physics-based-animation.html" target="_blank" rel="external">官网</a>上有很详细的介绍，在日常生活中当一个事物发生变化的时候，物理性的过渡或者说符合自然性的过渡，更容易让我们感知察觉，同样，更自然、不间断、有良好发展趋势的动画会给我们带来更好的用户体验。Physics-based Animations是根据物理学的基本原理构建的动画，动画由力产生，当力趋于平衡时动画处于静止。让我们重新捡起高中半吊子水平的物理知识，比如给物体在某个方向上施加一个力，物体有了速度，会在该方向上运动，如果停止施力，最后物体会由于摩擦力的影响，速度逐渐减小，运动一段时间后处于静止状态。Physics-based Animations概括起来就是下面几点：</p>
<ul>
<li>动画由力驱动</li>
<li>力决定了动画的加速和减速</li>
<li>在每一帧中动画值和速度都会更新</li>
<li>当受力达到平衡时动画停止</li>
</ul>
<h2 id="好处"><a href="#好处" class="headerlink" title="好处"></a>好处</h2><p>使用Physics-based Animations api创建的动画可以追踪速度，在运动过程中动态地改变动画的目标值，正确规划路线，使动画看起来更加自然。看下两组动画</p>
<p>​    <img src="http://7xjvg5.com1.z0.glb.clouddn.com/targetchange_oa.gif" style="zoom:50%"></p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/targetchange_pba.gif" style="zoom:50%"></p>
<p>对比了两组动画的差别，图1动画无法追踪速度，在进行下一帧的时候它的速度几乎还是从0开始的，速度值突然的变化给用户不连贯的视觉体验。图2动画可以追踪速度，在第二阶段力的方向改变，导致原先的速度发生变化，图片看起来很自然地移动到新的位置</p>
<p><a href="http://7xjvg5.com1.z0.glb.clouddn.com/oa_chart.png" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/oa_chart.png" alt="动画1的速度曲线图">动画1的速度曲线图</a><br><a href="http://7xjvg5.com1.z0.glb.clouddn.com/pba_chart.png" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/pba_chart.png" alt="动画2的速度曲线图">动画2的速度曲线图</a></p>
<h2 id="怎么用"><a href="#怎么用" class="headerlink" title="怎么用"></a>怎么用</h2><ul>
<li>Android Studio 3.0 Canary 4</li>
<li>在Android Studio的build.gradle中添加依赖</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    ...</div><div class="line">    implementation &apos;com.android.support:support-dynamic-animation:26.0.0-beta2&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Fling-Animation"><a href="#Fling-Animation" class="headerlink" title="Fling Animation"></a>Fling Animation</h2><p>看下怎样创建FlingAnimation:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ImageView img = root.findViewById(R.id.img_simple_fling);</div><div class="line">FlingAnimation flingAnimation = new FlingAnimation(img, DynamicAnimation.X);</div><div class="line">flingAnimation.setStartVelocity(500f);</div><div class="line">flingAnimation.setFriction(0.5f);</div><div class="line">flingAnimation.start();</div></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/fling.gif" style="zoom:50%"></p>
<p>解释下上面的代码:<br>创建一个FlingAnimation实例，默认情况下该实例的初速度是0pixels/s，因此我们需要调用<code>setStartVelocity()</code>方法给它赋予一个大于0的初速度，否则它是不会动的；另外这里介绍下<code>Friction</code>，翻译过来就是摩擦力的意思，在现实生活中如果一个物体保持一个速度在无摩擦力的情况下会一直运动下去，这里也是(比如这里设置Fraction为0.01f，发现小球滚到屏幕外了)，我们需要给该实例设置一个摩擦系数，设置的值越大，说明摩擦力越大，动画越快停下来，默认该值为1；最后调用start()方法开始动画。</p>
<h2 id="Spring-Animation"><a href="#Spring-Animation" class="headerlink" title="Spring Animation"></a>Spring Animation</h2><p>看下怎样创建SpringAnimation:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ImageView img = root.findViewById(R.id.img_simple_spring);</div><div class="line">SpringAnimation springAnimation = new SpringAnimation(img, DynamicAnimation.X);</div><div class="line">springAnimation.setStartVelocity(2000);</div><div class="line"></div><div class="line">SpringForce springForce = new SpringForce();   </div><div class="line">springForce.setDampingRatio(SpringForce.DAMPING_RATIO_HIGH_BOUNCY);</div><div class="line">springForce.setStiffness(SpringForce.STIFFNESS_LOW);</div><div class="line">springForce.setFinalPosition(img.getX());</div><div class="line"></div><div class="line">springAnimation.setSpring(springForce);</div><div class="line">springAnimation.start();</div></pre></td></tr></table></figure>
<p>效果如下:</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/spring.gif" style="zoom:50%"></p>
<p>解释下上面的代码:<br>和FlingAnimation一样，创建完SpringAnimation后我们需要设置初速度，接着创建了一个<br><code>SpringForce</code>实例，并设置了<code>DampingRatio</code>(弹性阻尼)和<code>Stiffness</code>(生硬度)，<br><code>DampingRatio</code>可以理解成反弹次数，系统中有以下几个可选，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public static final float DAMPING_RATIO_HIGH_BOUNCY = 0.2F;</div><div class="line">public static final float DAMPING_RATIO_MEDIUM_BOUNCY = 0.5F;</div><div class="line">public static final float DAMPING_RATIO_LOW_BOUNCY = 0.75F;</div><div class="line">public static final float DAMPING_RATIO_NO_BOUNCY = 1.0F;</div></pre></td></tr></table></figure>
<p>默认设置为<code>DAMPING_RATIO_MEDIUM_BOUNCY</code>，在<a href="https://developer.android.com/topic/libraries/support-library/preview/spring-animation.html" target="_blank" rel="external">官网</a>上贴了四张很Q弹的图片，分别对应不同值的效果，该值越大，反弹次数越少，值为1时不反弹。<br><code>Stiffness</code>可以理解成要恢复成未拉伸状态所需的时间，系统中有以下几个可选，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public static final float STIFFNESS_HIGH = 10000.0F;</div><div class="line">public static final float STIFFNESS_MEDIUM = 1500.0F;</div><div class="line">public static final float STIFFNESS_LOW = 200.0F;</div><div class="line">public static final float STIFFNESS_VERY_LOW = 50.0F;</div></pre></td></tr></table></figure>
<p>默认设置为<code>STIFFNESS_MEDIUM</code>，在<a href="https://developer.android.com/topic/libraries/support-library/preview/spring-animation.html" target="_blank" rel="external">官网</a>同样贴了四张对应不同值得对比图，该值越大，恢复到之前状态的时间就越短。可以修改<code>DampingRatio</code>或<code>Stiffness</code>查看效果</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/physics2.gif" style="zoom:50%"></p>
<p>setFinalPosition()方法指定最后静止时的位置。</p>
<h2 id="创建自定义的动画属性"><a href="#创建自定义的动画属性" class="headerlink" title="创建自定义的动画属性"></a>创建自定义的动画属性</h2><p>SpringAniamtion和FlingAnimation的构造函数只能接收一个可动画属性参数，如<code>ALPHA</code>、<code>ROTATION</code>、<code>SCALE</code>等，如果要同时为多个属性生成动画，一种方法是创建多个对应类的实例，然后传入要改变的动画值，这种做法比较麻烦，我们可以创建一个新的属性，该属性封装了我们想改变的其他动画属性值，做法如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">FloatPropertyCompat&lt;View&gt; scale = </div><div class="line">        new FloatPropertyCompat&lt;View&gt;(&quot;scale&quot;) &#123;</div><div class="line">            @Override</div><div class="line">            public float getValue(View view) &#123;</div><div class="line">                // return the value of any one property</div><div class="line">                return view.getScaleX();</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            @Override</div><div class="line">            public void setValue(View view, float value) &#123;</div><div class="line">                // Apply the same value to two properties</div><div class="line">                view.setScaleX(value);</div><div class="line">                view.setScaleY(value);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div></pre></td></tr></table></figure>
<p>创建<code>FloatPropertyCompat</code>实例，在<code>setValue()</code>方法中更新要修改的动画属性，在<code>getValue()</code>方法中返回当前属性值，示例代码统一改变了<code>SCALE_X</code>和<code>SCALE_Y</code>属性，自定义属性创建好之后可以像其他动画属性一样使用它，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SpringAnimation stretchAnimation =</div><div class="line">            new SpringAnimation(emoji, scale);</div></pre></td></tr></table></figure>
<p>在创建使用自定义属性的动画时，最好也调用<code>setMinimumVisibleChange()</code>方法并传递一个有意义的值，以确保动画不会消耗太多的CPU性能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">stretchAnimation.setMinimumVisibleChange(</div><div class="line">                DynamicAnimation.MIN_VISIBLE_CHANGE_SCALE);</div></pre></td></tr></table></figure>
<p>效果如下:</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/stretch.gif" style="zoom:50%"></p>
<h2 id="动画监听"><a href="#动画监听" class="headerlink" title="动画监听"></a>动画监听</h2><p><code>DynamicAnimation</code>提供了两个动画监听器<code>OnAnimationUpdateListener</code>和 <code>OnAnimationEndListener</code>，从名字也可以猜到前者监听动画值改变，后者监听动画结束状态。添加动画变化监听需要调用<code>addUpdateListener()</code>方法，重写<code>onAnimationUpdate()</code>方法执行具体操作；添加动画结束监听需要调用<code>addEndListener()</code>方法，重写<code>onAnimationEnd()</code>方法执行具体操作；若要移除动画监听，则需要调用<code>removeUpdateListener()</code>和<code>removeEndListener()</code>。监听动画结束的使用场景:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">// Change icon before animation starts</div><div class="line">emoji.setImageResource(</div><div class="line">        R.drawable.ic_sentiment_very_satisfied_black_56dp);</div><div class="line"> </div><div class="line">// Start animation</div><div class="line">springAnimation.start();</div><div class="line"> </div><div class="line">springAnimation.addEndListener(</div><div class="line">    new DynamicAnimation.OnAnimationEndListener() &#123;</div><div class="line">        @Override</div><div class="line">        public void onAnimationEnd(DynamicAnimation animation, </div><div class="line">                                boolean canceled,</div><div class="line">                                float value, float velocity) &#123;</div><div class="line">            // Change icon after animation ends</div><div class="line">            emoji.setImageResource(</div><div class="line">                    R.drawable.ic_sentiment_neutral_black_56dp);</div><div class="line">        &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>当动画结束时变换表情，效果如下:</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/bounce.gif" style="zoom:50%"></p>
<p>监听动画变化的使用场景:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">// Creating two views to demonstrate the registration of the update listener.</div><div class="line">final View view1 = findViewById(R.id.view1);</div><div class="line">final View view2 = findViewById(R.id.view2);</div><div class="line"></div><div class="line">// Setting up a spring animation to animate the view1 and view2 translationX and translationY properties</div><div class="line">final SpringAnimation anim1X = new SpringAnimation(view1,</div><div class="line">        DynamicAnimation.TRANSLATION_X);</div><div class="line">final SpringAnimation anim1Y = new SpringAnimation(view1,</div><div class="line">    DynamicAnimation.TRANSLATION_Y);</div><div class="line">final SpringAnimation anim2X = new SpringAnimation(view2,</div><div class="line">        DynamicAnimation.TRANSLATION_X);</div><div class="line">final SpringAnimation anim2Y = new SpringAnimation(view2,</div><div class="line">        DynamicAnimation.TRANSLATION_Y);</div><div class="line"></div><div class="line">// Registering the update listener</div><div class="line">anim1X.addUpdateListener(new DynamicAnimation.OnAnimationUpdateListener() &#123;</div><div class="line"></div><div class="line">// Overriding the method to notify view2 about the change in the view1’s property.</div><div class="line">    @Override</div><div class="line">    public void onAnimationUpdate(DynamicAnimation dynamicAnimation, float value,</div><div class="line">                                  float velocity) &#123;</div><div class="line">        anim2X.animateToFinalPosition(value);</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">anim1Y.addUpdateListener(new DynamicAnimation.OnAnimationUpdateListener() &#123;</div><div class="line"></div><div class="line">  @Override</div><div class="line">    public void onAnimationUpdate(DynamicAnimation dynamicAnimation, float value,</div><div class="line">                                  float velocity) &#123;</div><div class="line">        anim2Y.animateToFinalPosition(value);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我们可以结合<code>animateToFinalPosition()</code>方法实现链式弹力动画效果，即一个View的动画依赖于另一个，效果如下:</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/spring_chain.gif" style="zoom:50%"></p>
<h2 id="Thanks-to"><a href="#Thanks-to" class="headerlink" title="Thanks to"></a>Thanks to</h2><ul>
<li><a href="https://code.tutsplus.com/tutorials/adding-physics-based-animations-to-android-apps--cms-29053" target="_blank" rel="external">Adding Physics-Based Animations to Android Apps</a></li>
<li><a href="https://developer.android.com/topic/libraries/support-library/preview/physics-based-animation.html" target="_blank" rel="external">Physics-based Animations</a></li>
<li><a href="https://developer.android.com/topic/libraries/support-library/preview/spring-animation.html" target="_blank" rel="external">Spring Animation</a></li>
<li><a href="https://developer.android.com/topic/libraries/support-library/preview/fling-animation.html" target="_blank" rel="external">Fling Animation</a></li>
<li><a href="https://github.com/android/platform_frameworks_support/tree/master/samples/SupportAnimationDemos" target="_blank" rel="external">官方Demo</a></li>
</ul>
<p><a href="https://github.com/Rkhcy/PhysicsBasedAnimation/tree/master" target="_blank" rel="external">GitHub Demo传送门</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/31/Android View绘制源码分析--Draw/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/31/Android View绘制源码分析--Draw/" itemprop="url">Android View绘制源码分析--Draw</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-31T00:00:00+08:00">
                2017-05-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/31/Android View绘制源码分析--Draw/" class="leancloud_visitors" data-flag-title="Android View绘制源码分析--Draw">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>上篇文章分析DecorView的绘制的layout流程，这篇文章继续分析DecorView绘制的第三个阶段，draw流程。</p>
<h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p>先看ViewRootImpl的performDraw方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewRootImpl.java</div><div class="line">    private void performDraw() &#123;</div><div class="line">        if (mAttachInfo.mDisplayState == Display.STATE_OFF &amp;&amp; !mReportNextDraw) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        final boolean fullRedrawNeeded = mFullRedrawNeeded;</div><div class="line">        mFullRedrawNeeded = false;</div><div class="line"></div><div class="line">        mIsDrawing = true;</div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;draw&quot;);</div><div class="line">        try &#123;</div><div class="line">            draw(fullRedrawNeeded);</div><div class="line">        &#125; finally &#123;</div><div class="line">            mIsDrawing = false;</div><div class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // For whatever reason we didn&apos;t create a HardwareRenderer, end any</div><div class="line">        // hardware animations that are now dangling</div><div class="line">        if (mAttachInfo.mPendingAnimatingRenderNodes != null) &#123;</div><div class="line">            final int count = mAttachInfo.mPendingAnimatingRenderNodes.size();</div><div class="line">            for (int i = 0; i &lt; count; i++) &#123;</div><div class="line">                mAttachInfo.mPendingAnimatingRenderNodes.get(i).endAllAnimators();</div><div class="line">            &#125;</div><div class="line">            mAttachInfo.mPendingAnimatingRenderNodes.clear();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (mReportNextDraw) &#123;</div><div class="line">            mReportNextDraw = false;</div><div class="line"></div><div class="line">            // if we&apos;re using multi-thread renderer, wait for the window frame draws</div><div class="line">            if (mWindowDrawCountDown != null) &#123;</div><div class="line">                try &#123;</div><div class="line">                    mWindowDrawCountDown.await();</div><div class="line">                &#125; catch (InterruptedException e) &#123;</div><div class="line">                    Log.e(mTag, &quot;Window redraw count down interruped!&quot;);</div><div class="line">                &#125;</div><div class="line">                mWindowDrawCountDown = null;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (mAttachInfo.mHardwareRenderer != null) &#123;</div><div class="line">                mAttachInfo.mHardwareRenderer.fence();</div><div class="line">                mAttachInfo.mHardwareRenderer.setStopped(mStopped);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (mSurfaceHolder != null &amp;&amp; mSurface.isValid()) &#123;</div><div class="line">                mSurfaceHolderCallback.surfaceRedrawNeeded(mSurfaceHolder);</div><div class="line">                SurfaceHolder.Callback callbacks[] = mSurfaceHolder.getCallbacks();</div><div class="line">                if (callbacks != null) &#123;</div><div class="line">                    for (SurfaceHolder.Callback c : callbacks) &#123;</div><div class="line">                        if (c instanceof SurfaceHolder.Callback2) &#123;</div><div class="line">                            ((SurfaceHolder.Callback2)c).surfaceRedrawNeeded(mSurfaceHolder);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            try &#123;</div><div class="line">                mWindowSession.finishDrawing(mWindow);</div><div class="line">            &#125; catch (RemoteException e) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在13行执行了draw方法，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewRootImpl.java</div><div class="line">    private void draw(boolean fullRedrawNeeded) &#123;</div><div class="line">        Surface surface = mSurface;</div><div class="line">        if (!surface.isValid()) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (!sFirstDrawComplete) &#123;</div><div class="line">            synchronized (sFirstDrawHandlers) &#123;</div><div class="line">                sFirstDrawComplete = true;</div><div class="line">                final int count = sFirstDrawHandlers.size();</div><div class="line">                for (int i = 0; i&lt; count; i++) &#123;</div><div class="line">                    mHandler.post(sFirstDrawHandlers.get(i));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        scrollToRectOrFocus(null, false);</div><div class="line"></div><div class="line">        if (mAttachInfo.mViewScrollChanged) &#123;</div><div class="line">            mAttachInfo.mViewScrollChanged = false;</div><div class="line">            mAttachInfo.mTreeObserver.dispatchOnScrollChanged();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        boolean animating = mScroller != null &amp;&amp; mScroller.computeScrollOffset();</div><div class="line">        final int curScrollY;</div><div class="line">        if (animating) &#123;</div><div class="line">            curScrollY = mScroller.getCurrY();</div><div class="line">        &#125; else &#123;</div><div class="line">            curScrollY = mScrollY;</div><div class="line">        &#125;</div><div class="line">        if (mCurScrollY != curScrollY) &#123;</div><div class="line">            mCurScrollY = curScrollY;</div><div class="line">            fullRedrawNeeded = true;</div><div class="line">            if (mView instanceof RootViewSurfaceTaker) &#123;</div><div class="line">                ((RootViewSurfaceTaker) mView).onRootViewScrollYChanged(mCurScrollY);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        final float appScale = mAttachInfo.mApplicationScale;</div><div class="line">        final boolean scalingRequired = mAttachInfo.mScalingRequired;</div><div class="line"></div><div class="line">        int resizeAlpha = 0;</div><div class="line"></div><div class="line">        final Rect dirty = mDirty;</div><div class="line">        if (mSurfaceHolder != null) &#123;</div><div class="line">            // The app owns the surface, we won&apos;t draw.</div><div class="line">            dirty.setEmpty();</div><div class="line">            if (animating &amp;&amp; mScroller != null) &#123;</div><div class="line">                mScroller.abortAnimation();</div><div class="line">            &#125;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (fullRedrawNeeded) &#123;</div><div class="line">            mAttachInfo.mIgnoreDirtyState = true;</div><div class="line">            dirty.set(0, 0, (int) (mWidth * appScale + 0.5f), (int) (mHeight * appScale + 0.5f));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mAttachInfo.mTreeObserver.dispatchOnDraw();</div><div class="line"></div><div class="line">        int xOffset = -mCanvasOffsetX;</div><div class="line">        int yOffset = -mCanvasOffsetY + curScrollY;</div><div class="line">        final WindowManager.LayoutParams params = mWindowAttributes;</div><div class="line">        final Rect surfaceInsets = params != null ? params.surfaceInsets : null;</div><div class="line">        if (surfaceInsets != null) &#123;</div><div class="line">            xOffset -= surfaceInsets.left;</div><div class="line">            yOffset -= surfaceInsets.top;</div><div class="line"></div><div class="line">            // Offset dirty rect for surface insets.</div><div class="line">            dirty.offset(surfaceInsets.left, surfaceInsets.right);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        boolean accessibilityFocusDirty = false;</div><div class="line">        final Drawable drawable = mAttachInfo.mAccessibilityFocusDrawable;</div><div class="line">        if (drawable != null) &#123;</div><div class="line">            final Rect bounds = mAttachInfo.mTmpInvalRect;</div><div class="line">            final boolean hasFocus = getAccessibilityFocusedRect(bounds);</div><div class="line">            if (!hasFocus) &#123;</div><div class="line">                bounds.setEmpty();</div><div class="line">            &#125;</div><div class="line">            if (!bounds.equals(drawable.getBounds())) &#123;</div><div class="line">                accessibilityFocusDirty = true;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mAttachInfo.mDrawingTime =</div><div class="line">                mChoreographer.getFrameTimeNanos() / TimeUtils.NANOS_PER_MS;</div><div class="line"></div><div class="line">        if (!dirty.isEmpty() || mIsAnimating || accessibilityFocusDirty) &#123;</div><div class="line">            if (mAttachInfo.mHardwareRenderer != null &amp;&amp; mAttachInfo.mHardwareRenderer.isEnabled()) &#123;</div><div class="line">                // If accessibility focus moved, always invalidate the root.</div><div class="line">                boolean invalidateRoot = accessibilityFocusDirty || mInvalidateRootRequested;</div><div class="line">                mInvalidateRootRequested = false;</div><div class="line"></div><div class="line">                // Draw with hardware renderer.</div><div class="line">                mIsAnimating = false;</div><div class="line"></div><div class="line">                if (mHardwareYOffset != yOffset || mHardwareXOffset != xOffset) &#123;</div><div class="line">                    mHardwareYOffset = yOffset;</div><div class="line">                    mHardwareXOffset = xOffset;</div><div class="line">                    invalidateRoot = true;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                if (invalidateRoot) &#123;</div><div class="line">                    mAttachInfo.mHardwareRenderer.invalidateRoot();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                dirty.setEmpty();</div><div class="line"></div><div class="line">                // Stage the content drawn size now. It will be transferred to the renderer</div><div class="line">                // shortly before the draw commands get send to the renderer.</div><div class="line">                final boolean updated = updateContentDrawBounds();</div><div class="line"></div><div class="line">                if (mReportNextDraw) &#123;</div><div class="line">                    // report next draw overrides setStopped()</div><div class="line">                    // This value is re-sync&apos;d to the value of mStopped</div><div class="line">                    // in the handling of mReportNextDraw post-draw.</div><div class="line">                    mAttachInfo.mHardwareRenderer.setStopped(false);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                if (updated) &#123;</div><div class="line">                    requestDrawWindow();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                mAttachInfo.mHardwareRenderer.draw(mView, mAttachInfo, this);</div><div class="line">            &#125; else &#123;</div><div class="line">                // If we get here with a disabled &amp; requested hardware renderer, something went</div><div class="line">                // wrong (an invalidate posted right before we destroyed the hardware surface</div><div class="line">                // for instance) so we should just bail out. Locking the surface with software</div><div class="line">                // rendering at this point would lock it forever and prevent hardware renderer</div><div class="line">                // from doing its job when it comes back.</div><div class="line">                // Before we request a new frame we must however attempt to reinitiliaze the</div><div class="line">                // hardware renderer if it&apos;s in requested state. This would happen after an</div><div class="line">                // eglTerminate() for instance.</div><div class="line">                if (mAttachInfo.mHardwareRenderer != null &amp;&amp;</div><div class="line">                        !mAttachInfo.mHardwareRenderer.isEnabled() &amp;&amp;</div><div class="line">                        mAttachInfo.mHardwareRenderer.isRequested()) &#123;</div><div class="line"></div><div class="line">                    try &#123;</div><div class="line">                        mAttachInfo.mHardwareRenderer.initializeIfNeeded(</div><div class="line">                                mWidth, mHeight, mAttachInfo, mSurface, surfaceInsets);</div><div class="line">                    &#125; catch (OutOfResourcesException e) &#123;</div><div class="line">                        handleOutOfResourcesException(e);</div><div class="line">                        return;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    mFullRedrawNeeded = true;</div><div class="line">                    scheduleTraversals();</div><div class="line">                    return;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                if (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) &#123;</div><div class="line">                    return;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (animating) &#123;</div><div class="line">            mFullRedrawNeeded = true;</div><div class="line">            scheduleTraversals();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在153行执行了drawSoftware方法，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewRootImpl.java</div><div class="line">    /**</div><div class="line">     * @return true if drawing was successful, false if an error occurred</div><div class="line">     */</div><div class="line">    private boolean drawSoftware(Surface surface, AttachInfo attachInfo, int xoff, int yoff,</div><div class="line">            boolean scalingRequired, Rect dirty) &#123;</div><div class="line"></div><div class="line">        // Draw with software renderer.</div><div class="line">        final Canvas canvas;</div><div class="line">        try &#123;</div><div class="line">            final int left = dirty.left;</div><div class="line">            final int top = dirty.top;</div><div class="line">            final int right = dirty.right;</div><div class="line">            final int bottom = dirty.bottom;</div><div class="line">            //获取canvas</div><div class="line">            canvas = mSurface.lockCanvas(dirty);</div><div class="line"></div><div class="line">            // The dirty rectangle can be modified by Surface.lockCanvas()</div><div class="line">            //noinspection ConstantConditions</div><div class="line">            if (left != dirty.left || top != dirty.top || right != dirty.right</div><div class="line">                    || bottom != dirty.bottom) &#123;</div><div class="line">                attachInfo.mIgnoreDirtyState = true;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // TODO: Do this in native</div><div class="line">            canvas.setDensity(mDensity);</div><div class="line">        &#125; catch (Surface.OutOfResourcesException e) &#123;</div><div class="line">            handleOutOfResourcesException(e);</div><div class="line">            return false;</div><div class="line">        &#125; catch (IllegalArgumentException e) &#123;</div><div class="line">            // Don&apos;t assume this is due to out of memory, it could be</div><div class="line">            // something else, and if it is something else then we could</div><div class="line">            // kill stuff (or ourself) for no reason.</div><div class="line">            mLayoutRequested = true;    // ask wm for a new surface next time.</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            // If this bitmap&apos;s format includes an alpha channel, we</div><div class="line">            // need to clear it before drawing so that the child will</div><div class="line">            // properly re-composite its drawing on a transparent</div><div class="line">            // background. This automatically respects the clip/dirty region</div><div class="line">            // or</div><div class="line">            // If we are applying an offset, we need to clear the area</div><div class="line">            // where the offset doesn&apos;t appear to avoid having garbage</div><div class="line">            // left in the blank areas.</div><div class="line">            if (!canvas.isOpaque() || yoff != 0 || xoff != 0) &#123;</div><div class="line">                canvas.drawColor(0, PorterDuff.Mode.CLEAR);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            dirty.setEmpty();</div><div class="line">            mIsAnimating = false;</div><div class="line">            mView.mPrivateFlags |= View.PFLAG_DRAWN;</div><div class="line"></div><div class="line">            try &#123;</div><div class="line">                canvas.translate(-xoff, -yoff);</div><div class="line">                if (mTranslator != null) &#123;</div><div class="line">                    mTranslator.translateCanvas(canvas);</div><div class="line">                &#125;</div><div class="line">                canvas.setScreenDensity(scalingRequired ? mNoncompatDensity : 0);</div><div class="line">                attachInfo.mSetIgnoreDirtyState = false;</div><div class="line">                //传入canvas,调用指定View的draw方法开始绘制</div><div class="line">                mView.draw(canvas);</div><div class="line"></div><div class="line">                drawAccessibilityFocusedDrawableIfNeeded(canvas);</div><div class="line">            &#125; finally &#123;</div><div class="line">                if (!attachInfo.mSetIgnoreDirtyState) &#123;</div><div class="line">                    // Only clear the flag if it was not set during the mView.draw() call</div><div class="line">                    attachInfo.mIgnoreDirtyState = false;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; finally &#123;</div><div class="line">            try &#123;</div><div class="line">                surface.unlockCanvasAndPost(canvas);</div><div class="line">            &#125; catch (IllegalArgumentException e) &#123;</div><div class="line">                mLayoutRequested = true;    // ask wm for a new surface next time.</div><div class="line">                //noinspection ReturnInsideFinallyBlock</div><div class="line">                return false;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return true;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在16行获取了canvas，在63行将canvas作为参数传递给View的draw方法，从前几篇分析可知，这里的mView是根节点DecorView，因此看下DecorView中的draw方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">源码路径：/SDK/sources/android-24/com/android/internal/policy/DecorView.java</div><div class="line">    public void draw(Canvas canvas) &#123;</div><div class="line">        super.draw(canvas);</div><div class="line"></div><div class="line">        if (mMenuBackground != null) &#123;</div><div class="line">            mMenuBackground.draw(canvas);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>回调了父类的draw方法，在父类FrameLayout和ViewGroup中均未复写draw，因此看下View中的draw方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">     * Manually render this view (and all of its children) to the given Canvas.</div><div class="line">     * The view must have already done a full layout before this function is</div><div class="line">     * called.  When implementing a view, implement</div><div class="line">     * &#123;@link #onDraw(android.graphics.Canvas)&#125; instead of overriding this method.</div><div class="line">     * If you do need to override this method, call the superclass version.</div><div class="line">     *</div><div class="line">     * @param canvas The Canvas to which the View is rendered.</div><div class="line">     */</div><div class="line">    @CallSuper</div><div class="line">    public void draw(Canvas canvas) &#123;</div><div class="line">        final int privateFlags = mPrivateFlags;</div><div class="line">        final boolean dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;</div><div class="line">                (mAttachInfo == null || !mAttachInfo.mIgnoreDirtyState);</div><div class="line">        mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</div><div class="line"></div><div class="line">        /*</div><div class="line">         * Draw traversal performs several drawing steps which must be executed</div><div class="line">         * in the appropriate order:</div><div class="line">         *</div><div class="line">         *      1. Draw the background</div><div class="line">         *      2. If necessary, save the canvas&apos; layers to prepare for fading</div><div class="line">         *      3. Draw view&apos;s content</div><div class="line">         *      4. Draw children</div><div class="line">         *      5. If necessary, draw the fading edges and restore layers</div><div class="line">         *      6. Draw decorations (scrollbars for instance)</div><div class="line">         */</div><div class="line"></div><div class="line">        // Step 1, draw the background, if needed</div><div class="line">        int saveCount;</div><div class="line"></div><div class="line">        if (!dirtyOpaque) &#123;</div><div class="line">            drawBackground(canvas);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // skip step 2 &amp; 5 if possible (common case)</div><div class="line">        final int viewFlags = mViewFlags;</div><div class="line">        boolean horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != 0;</div><div class="line">        boolean verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != 0;</div><div class="line">        if (!verticalEdges &amp;&amp; !horizontalEdges) &#123;</div><div class="line">            // Step 3, draw the content</div><div class="line">            if (!dirtyOpaque) onDraw(canvas);</div><div class="line"></div><div class="line">            // Step 4, draw the children</div><div class="line">            dispatchDraw(canvas);</div><div class="line"></div><div class="line">            // Overlay is part of the content and draws beneath Foreground</div><div class="line">            if (mOverlay != null &amp;&amp; !mOverlay.isEmpty()) &#123;</div><div class="line">                mOverlay.getOverlayView().dispatchDraw(canvas);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // Step 6, draw decorations (foreground, scrollbars)</div><div class="line">            onDrawForeground(canvas);</div><div class="line"></div><div class="line">            // we&apos;re done...</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        /*</div><div class="line">         * Here we do the full fledged routine...</div><div class="line">         * (this is an uncommon case where speed matters less,</div><div class="line">         * this is why we repeat some of the tests that have been</div><div class="line">         * done above)</div><div class="line">         */</div><div class="line"></div><div class="line">        boolean drawTop = false;</div><div class="line">        boolean drawBottom = false;</div><div class="line">        boolean drawLeft = false;</div><div class="line">        boolean drawRight = false;</div><div class="line"></div><div class="line">        float topFadeStrength = 0.0f;</div><div class="line">        float bottomFadeStrength = 0.0f;</div><div class="line">        float leftFadeStrength = 0.0f;</div><div class="line">        float rightFadeStrength = 0.0f;</div><div class="line"></div><div class="line">        // Step 2, save the canvas&apos; layers</div><div class="line">        int paddingLeft = mPaddingLeft;</div><div class="line"></div><div class="line">        final boolean offsetRequired = isPaddingOffsetRequired();</div><div class="line">        if (offsetRequired) &#123;</div><div class="line">            paddingLeft += getLeftPaddingOffset();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        int left = mScrollX + paddingLeft;</div><div class="line">        int right = left + mRight - mLeft - mPaddingRight - paddingLeft;</div><div class="line">        int top = mScrollY + getFadeTop(offsetRequired);</div><div class="line">        int bottom = top + getFadeHeight(offsetRequired);</div><div class="line"></div><div class="line">        if (offsetRequired) &#123;</div><div class="line">            right += getRightPaddingOffset();</div><div class="line">            bottom += getBottomPaddingOffset();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        final ScrollabilityCache scrollabilityCache = mScrollCache;</div><div class="line">        final float fadeHeight = scrollabilityCache.fadingEdgeLength;</div><div class="line">        int length = (int) fadeHeight;</div><div class="line"></div><div class="line">        // clip the fade length if top and bottom fades overlap</div><div class="line">        // overlapping fades produce odd-looking artifacts</div><div class="line">        if (verticalEdges &amp;&amp; (top + length &gt; bottom - length)) &#123;</div><div class="line">            length = (bottom - top) / 2;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // also clip horizontal fades if necessary</div><div class="line">        if (horizontalEdges &amp;&amp; (left + length &gt; right - length)) &#123;</div><div class="line">            length = (right - left) / 2;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (verticalEdges) &#123;</div><div class="line">            topFadeStrength = Math.max(0.0f, Math.min(1.0f, getTopFadingEdgeStrength()));</div><div class="line">            drawTop = topFadeStrength * fadeHeight &gt; 1.0f;</div><div class="line">            bottomFadeStrength = Math.max(0.0f, Math.min(1.0f, getBottomFadingEdgeStrength()));</div><div class="line">            drawBottom = bottomFadeStrength * fadeHeight &gt; 1.0f;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (horizontalEdges) &#123;</div><div class="line">            leftFadeStrength = Math.max(0.0f, Math.min(1.0f, getLeftFadingEdgeStrength()));</div><div class="line">            drawLeft = leftFadeStrength * fadeHeight &gt; 1.0f;</div><div class="line">            rightFadeStrength = Math.max(0.0f, Math.min(1.0f, getRightFadingEdgeStrength()));</div><div class="line">            drawRight = rightFadeStrength * fadeHeight &gt; 1.0f;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        saveCount = canvas.getSaveCount();</div><div class="line"></div><div class="line">        int solidColor = getSolidColor();</div><div class="line">        if (solidColor == 0) &#123;</div><div class="line">            final int flags = Canvas.HAS_ALPHA_LAYER_SAVE_FLAG;</div><div class="line"></div><div class="line">            if (drawTop) &#123;</div><div class="line">                canvas.saveLayer(left, top, right, top + length, null, flags);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (drawBottom) &#123;</div><div class="line">                canvas.saveLayer(left, bottom - length, right, bottom, null, flags);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (drawLeft) &#123;</div><div class="line">                canvas.saveLayer(left, top, left + length, bottom, null, flags);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (drawRight) &#123;</div><div class="line">                canvas.saveLayer(right - length, top, right, bottom, null, flags);</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            scrollabilityCache.setFadeColor(solidColor);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Step 3, draw the content</div><div class="line">        if (!dirtyOpaque) onDraw(canvas);</div><div class="line"></div><div class="line">        // Step 4, draw the children</div><div class="line">        dispatchDraw(canvas);</div><div class="line"></div><div class="line">        // Step 5, draw the fade effect and restore layers</div><div class="line">        final Paint p = scrollabilityCache.paint;</div><div class="line">        final Matrix matrix = scrollabilityCache.matrix;</div><div class="line">        final Shader fade = scrollabilityCache.shader;</div><div class="line"></div><div class="line">        if (drawTop) &#123;</div><div class="line">            matrix.setScale(1, fadeHeight * topFadeStrength);</div><div class="line">            matrix.postTranslate(left, top);</div><div class="line">            fade.setLocalMatrix(matrix);</div><div class="line">            p.setShader(fade);</div><div class="line">            canvas.drawRect(left, top, right, top + length, p);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (drawBottom) &#123;</div><div class="line">            matrix.setScale(1, fadeHeight * bottomFadeStrength);</div><div class="line">            matrix.postRotate(180);</div><div class="line">            matrix.postTranslate(left, bottom);</div><div class="line">            fade.setLocalMatrix(matrix);</div><div class="line">            p.setShader(fade);</div><div class="line">            canvas.drawRect(left, bottom - length, right, bottom, p);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (drawLeft) &#123;</div><div class="line">            matrix.setScale(1, fadeHeight * leftFadeStrength);</div><div class="line">            matrix.postRotate(-90);</div><div class="line">            matrix.postTranslate(left, top);</div><div class="line">            fade.setLocalMatrix(matrix);</div><div class="line">            p.setShader(fade);</div><div class="line">            canvas.drawRect(left, top, left + length, bottom, p);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (drawRight) &#123;</div><div class="line">            matrix.setScale(1, fadeHeight * rightFadeStrength);</div><div class="line">            matrix.postRotate(90);</div><div class="line">            matrix.postTranslate(right, top);</div><div class="line">            fade.setLocalMatrix(matrix);</div><div class="line">            p.setShader(fade);</div><div class="line">            canvas.drawRect(right - length, top, right, bottom, p);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        canvas.restoreToCount(saveCount);</div><div class="line"></div><div class="line">        // Overlay is part of the content and draws beneath Foreground</div><div class="line">        if (mOverlay != null &amp;&amp; !mOverlay.isEmpty()) &#123;</div><div class="line">            mOverlay.getOverlayView().dispatchDraw(canvas);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Step 6, draw decorations (foreground, scrollbars)</div><div class="line">        onDrawForeground(canvas);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>通过该方法的注释可知，当自定义View需要绘制时，应该重写onDraw方法而不是draw方法，如果要重写draw方法，需要先调用父类的draw方法。另外根据18-28行的注释代码可知，draw的流程分为以下6步：</p>
<p>1.背景绘制<br>2.保存画布图层，为渐变效果做准备(可跳过)<br>3.绘制视图内容<br>4.绘制子视图<br>5.绘制渐变效果(可跳过)<br>6.绘制其他装饰物(前景和滚动条)</p>
<p>逐步分析以上流程，先看背景绘制</p>
<h2 id="Step1背景绘制"><a href="#Step1背景绘制" class="headerlink" title="Step1背景绘制"></a>Step1背景绘制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">     * Draws the background onto the specified canvas.</div><div class="line">     *</div><div class="line">     * @param canvas Canvas on which to draw the background</div><div class="line">     */</div><div class="line">    private void drawBackground(Canvas canvas) &#123;</div><div class="line">        final Drawable background = mBackground;</div><div class="line">        if (background == null) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setBackgroundBounds();</div><div class="line"></div><div class="line">        // Attempt to use a display list if requested.</div><div class="line">        if (canvas.isHardwareAccelerated() &amp;&amp; mAttachInfo != null</div><div class="line">                &amp;&amp; mAttachInfo.mHardwareRenderer != null) &#123;</div><div class="line">            mBackgroundRenderNode = getDrawableRenderNode(background, mBackgroundRenderNode);</div><div class="line"></div><div class="line">            final RenderNode renderNode = mBackgroundRenderNode;</div><div class="line">            if (renderNode != null &amp;&amp; renderNode.isValid()) &#123;</div><div class="line">                setBackgroundRenderNodeProperties(renderNode);</div><div class="line">                ((DisplayListCanvas) canvas).drawRenderNode(renderNode);</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        final int scrollX = mScrollX;</div><div class="line">        final int scrollY = mScrollY;</div><div class="line">        if ((scrollX | scrollY) == 0) &#123;</div><div class="line">            background.draw(canvas);</div><div class="line">        &#125; else &#123;</div><div class="line">            canvas.translate(scrollX, scrollY);</div><div class="line">            background.draw(canvas);</div><div class="line">            canvas.translate(-scrollX, -scrollY);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在第8行首先获取background，这里的background是xml中android:background属性或者在代码中调用setBackground()、setBackgroundResource()赋值的Drawable，如果background为null就返回，接着执行setBackgroundBounds确定背景的范围，最后调用Drawable的draw方法完成背景的绘制。</p>
<h2 id="Step2保存画布图层"><a href="#Step2保存画布图层" class="headerlink" title="Step2保存画布图层"></a>Step2保存画布图层</h2><p>在View中的draw方法的37-58行判断在水平和垂直方向是否需要渐变效果，若不需要则跳过2、5步骤，只执行3、4、6步，如果需要，77-147行调用canvas的saveLayer保存画布图层。</p>
<h2 id="Step3绘制视图内容"><a href="#Step3绘制视图内容" class="headerlink" title="Step3绘制视图内容"></a>Step3绘制视图内容</h2><p>第三步会执行onDraw，查看View中的onDraw</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">     * Implement this to do your drawing.</div><div class="line">     *</div><div class="line">     * @param canvas the canvas on which the background will be drawn</div><div class="line">     */</div><div class="line">    protected void onDraw(Canvas canvas) &#123;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>View中的onDraw是个空方法，说明具体实现在子类中，那么查看下DecorView的onDraw方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">源码路径：/SDK/sources/android-24/com/android/internal/policy/DecorView.java</div><div class="line">    public void onDraw(Canvas c) &#123;</div><div class="line">        super.onDraw(c);</div><div class="line">        mBackgroundFallback.draw(mContentRoot, c, mWindow.mContentParent);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看到这里有调用了父类的onDraw，但是在父类FrameLayout和ViewGroup中都没有重写onDraw，View中又是个空方法，所以只能是在mBackgroundFallback的draw方法，这里的mBackgroundFallback是个BackgroundFallback实例，draw方法具体如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/com/android/internal/widget/BackgroundFallback.java</div><div class="line">    private Drawable mBackgroundFallback;</div><div class="line">    public void draw(ViewGroup root, Canvas c, View content) &#123;</div><div class="line">        if (!hasFallback()) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Draw the fallback in the padding.</div><div class="line">        final int width = root.getWidth();</div><div class="line">        final int height = root.getHeight();</div><div class="line">        int left = width;</div><div class="line">        int top = height;</div><div class="line">        int right = 0;</div><div class="line">        int bottom = 0;</div><div class="line"></div><div class="line">        final int childCount = root.getChildCount();</div><div class="line">        for (int i = 0; i &lt; childCount; i++) &#123;</div><div class="line">            final View child = root.getChildAt(i);</div><div class="line">            final Drawable childBg = child.getBackground();</div><div class="line">            if (child == content) &#123;</div><div class="line">                // We always count the content view container unless it has no background</div><div class="line">                // and no children.</div><div class="line">                if (childBg == null &amp;&amp; child instanceof ViewGroup &amp;&amp;</div><div class="line">                        ((ViewGroup) child).getChildCount() == 0) &#123;</div><div class="line">                    continue;</div><div class="line">                &#125;</div><div class="line">            &#125; else if (child.getVisibility() != View.VISIBLE || childBg == null ||</div><div class="line">                    childBg.getOpacity() != PixelFormat.OPAQUE) &#123;</div><div class="line">                // Potentially translucent or invisible children don&apos;t count, and we assume</div><div class="line">                // the content view will cover the whole area if we&apos;re in a background</div><div class="line">                // fallback situation.</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            left = Math.min(left, child.getLeft());</div><div class="line">            top = Math.min(top, child.getTop());</div><div class="line">            right = Math.max(right, child.getRight());</div><div class="line">            bottom = Math.max(bottom, child.getBottom());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (left &gt;= right || top &gt;= bottom) &#123;</div><div class="line">            // No valid area to draw in.</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (top &gt; 0) &#123;</div><div class="line">            mBackgroundFallback.setBounds(0, 0, width, top);</div><div class="line">            mBackgroundFallback.draw(c);</div><div class="line">        &#125;</div><div class="line">        if (left &gt; 0) &#123;</div><div class="line">            mBackgroundFallback.setBounds(0, top, left, height);</div><div class="line">            mBackgroundFallback.draw(c);</div><div class="line">        &#125;</div><div class="line">        if (right &lt; width) &#123;</div><div class="line">            mBackgroundFallback.setBounds(right, top, width, height);</div><div class="line">            mBackgroundFallback.draw(c);</div><div class="line">        &#125;</div><div class="line">        if (bottom &lt; height) &#123;</div><div class="line">            mBackgroundFallback.setBounds(left, bottom, right, height);</div><div class="line">            mBackgroundFallback.draw(c);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>最后是通过Drawable的draw方法绘制。</p>
<h2 id="Step4绘制子视图"><a href="#Step4绘制子视图" class="headerlink" title="Step4绘制子视图"></a>Step4绘制子视图</h2><p>第四步绘制子视图会调用View的dispatchDraw方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Called by draw to draw the child views. This may be overridden</div><div class="line"> * by derived classes to gain control just before its children are drawn</div><div class="line"> * (but after its own view has been drawn).</div><div class="line"> * @param canvas the canvas on which to draw the view</div><div class="line"> */</div><div class="line">protected void dispatchDraw(Canvas canvas) &#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>View中的dispatchDraw也是个空方法，说明实现在子类，在DecorView和FrameLayout中都没有复写该方法，ViewGroup中该方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewGroup.java</div><div class="line">    protected void dispatchDraw(Canvas canvas) &#123;</div><div class="line">        boolean usingRenderNodeProperties = canvas.isRecordingFor(mRenderNode);</div><div class="line">        final int childrenCount = mChildrenCount;</div><div class="line">        final View[] children = mChildren;</div><div class="line">        int flags = mGroupFlags;</div><div class="line">        //该ViewGroup是否设置布局动画</div><div class="line">        if ((flags &amp; FLAG_RUN_ANIMATION) != 0 &amp;&amp; canAnimate()) &#123;</div><div class="line">            final boolean buildCache = !isHardwareAccelerated();</div><div class="line">            for (int i = 0; i &lt; childrenCount; i++) &#123;</div><div class="line">                final View child = children[i];</div><div class="line">                if ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE) &#123;</div><div class="line">                    //如果子View可见,设置动画</div><div class="line">                    final LayoutParams params = child.getLayoutParams();</div><div class="line">                    attachLayoutAnimationParameters(child, params, i, childrenCount);</div><div class="line">                    bindLayoutAnimation(child);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            //获取动画控制器</div><div class="line">            final LayoutAnimationController controller = mLayoutAnimationController;</div><div class="line">            if (controller.willOverlap()) &#123;</div><div class="line">                mGroupFlags |= FLAG_OPTIMIZE_INVALIDATE;</div><div class="line">            &#125;</div><div class="line">            //开始布局动画</div><div class="line">            controller.start();</div><div class="line"></div><div class="line">            mGroupFlags &amp;= ~FLAG_RUN_ANIMATION;</div><div class="line">            mGroupFlags &amp;= ~FLAG_ANIMATION_DONE;</div><div class="line"></div><div class="line">            if (mAnimationListener != null) &#123;</div><div class="line">                mAnimationListener.onAnimationStart(controller.getAnimation());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        int clipSaveCount = 0;</div><div class="line">        //是否需要剪裁边距</div><div class="line">        final boolean clipToPadding = (flags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK;</div><div class="line">        if (clipToPadding) &#123;</div><div class="line">            clipSaveCount = canvas.save();</div><div class="line">            //裁剪边距</div><div class="line">            canvas.clipRect(mScrollX + mPaddingLeft, mScrollY + mPaddingTop,</div><div class="line">                    mScrollX + mRight - mLeft - mPaddingRight,</div><div class="line">                    mScrollY + mBottom - mTop - mPaddingBottom);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // We will draw our child&apos;s animation, let&apos;s reset the flag</div><div class="line">        mPrivateFlags &amp;= ~PFLAG_DRAW_ANIMATION;</div><div class="line">        mGroupFlags &amp;= ~FLAG_INVALIDATE_REQUIRED;</div><div class="line"></div><div class="line">        boolean more = false;</div><div class="line">        final long drawingTime = getDrawingTime();</div><div class="line"></div><div class="line">        if (usingRenderNodeProperties) canvas.insertReorderBarrier();</div><div class="line">        final int transientCount = mTransientIndices == null ? 0 : mTransientIndices.size();</div><div class="line">        int transientIndex = transientCount != 0 ? 0 : -1;</div><div class="line">        // Only use the preordered list if not HW accelerated, since the HW pipeline will do the</div><div class="line">        // draw reordering internally</div><div class="line">        final ArrayList&lt;View&gt; preorderedList = usingRenderNodeProperties</div><div class="line">                ? null : buildOrderedChildList();</div><div class="line">        final boolean customOrder = preorderedList == null</div><div class="line">                &amp;&amp; isChildrenDrawingOrderEnabled();</div><div class="line">        for (int i = 0; i &lt; childrenCount; i++) &#123;</div><div class="line">            while (transientIndex &gt;= 0 &amp;&amp; mTransientIndices.get(transientIndex) == i) &#123;</div><div class="line">                final View transientChild = mTransientViews.get(transientIndex);</div><div class="line">                if ((transientChild.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE ||</div><div class="line">                        transientChild.getAnimation() != null) &#123;</div><div class="line">                        //调用drawChild绘制子视图</div><div class="line">                    more |= drawChild(canvas, transientChild, drawingTime);</div><div class="line">                &#125;</div><div class="line">                transientIndex++;</div><div class="line">                if (transientIndex &gt;= transientCount) &#123;</div><div class="line">                    transientIndex = -1;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            final int childIndex = getAndVerifyPreorderedIndex(childrenCount, i, customOrder);</div><div class="line">            final View child = getAndVerifyPreorderedView(preorderedList, children, childIndex);</div><div class="line">            if ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != null) &#123;</div><div class="line">                more |= drawChild(canvas, child, drawingTime);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        while (transientIndex &gt;= 0) &#123;</div><div class="line">            // there may be additional transient views after the normal views</div><div class="line">            final View transientChild = mTransientViews.get(transientIndex);</div><div class="line">            if ((transientChild.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE ||</div><div class="line">                    transientChild.getAnimation() != null) &#123;</div><div class="line">                more |= drawChild(canvas, transientChild, drawingTime);</div><div class="line">            &#125;</div><div class="line">            transientIndex++;</div><div class="line">            if (transientIndex &gt;= transientCount) &#123;</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (preorderedList != null) preorderedList.clear();</div><div class="line"></div><div class="line">        // Draw any disappearing views that have animations</div><div class="line">        //绘制设置了消失动画的子视图</div><div class="line">        if (mDisappearingChildren != null) &#123;</div><div class="line">            final ArrayList&lt;View&gt; disappearingChildren = mDisappearingChildren;</div><div class="line">            final int disappearingCount = disappearingChildren.size() - 1;</div><div class="line">            // Go backwards -- we may delete as animations finish</div><div class="line">            for (int i = disappearingCount; i &gt;= 0; i--) &#123;</div><div class="line">                final View child = disappearingChildren.get(i);</div><div class="line">                more |= drawChild(canvas, child, drawingTime);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (usingRenderNodeProperties) canvas.insertInorderBarrier();</div><div class="line"></div><div class="line">        if (debugDraw()) &#123;</div><div class="line">            onDebugDraw(canvas);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (clipToPadding) &#123;</div><div class="line">            canvas.restoreToCount(clipSaveCount);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // mGroupFlags might have been updated by drawChild()</div><div class="line">        flags = mGroupFlags;</div><div class="line"></div><div class="line">        if ((flags &amp; FLAG_INVALIDATE_REQUIRED) == FLAG_INVALIDATE_REQUIRED) &#123;</div><div class="line">            invalidate(true);</div><div class="line">        &#125;</div><div class="line">        //更新布局动画的监听事件</div><div class="line">        if ((flags &amp; FLAG_ANIMATION_DONE) == 0 &amp;&amp; (flags &amp; FLAG_NOTIFY_ANIMATION_LISTENER) == 0 &amp;&amp;</div><div class="line">                mLayoutAnimationController.isDone() &amp;&amp; !more) &#123;</div><div class="line">            // We want to erase the drawing cache and notify the listener after the</div><div class="line">            // next frame is drawn because one extra invalidate() is caused by</div><div class="line">            // drawChild() after the animation is over</div><div class="line">            mGroupFlags |= FLAG_NOTIFY_ANIMATION_LISTENER;</div><div class="line">            final Runnable end = new Runnable() &#123;</div><div class="line">               @Override</div><div class="line">               public void run() &#123;</div><div class="line">                   notifyAnimationListener();</div><div class="line">               &#125;</div><div class="line">            &#125;;</div><div class="line">            post(end);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>分析上面的代码，7-33行，如果该ViewGroup的xml属性设置android:animateLayoutChanges=“true”，则满足该部分条件，在子View出现的时候会有默认的动画效果；该方法会遍历ViewGroup下的子View，调用drawChild方法完成子View的绘制，drawChild方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewGroup.java</div><div class="line">    /**</div><div class="line">     * Draw one child of this View Group. This method is responsible for getting</div><div class="line">     * the canvas in the right state. This includes clipping, translating so</div><div class="line">     * that the child&apos;s scrolled origin is at 0, 0, and applying any animation</div><div class="line">     * transformations.</div><div class="line">     *</div><div class="line">     * @param canvas The canvas on which to draw the child</div><div class="line">     * @param child Who to draw</div><div class="line">     * @param drawingTime The time at which draw is occurring</div><div class="line">     * @return True if an invalidate() was issued</div><div class="line">     */</div><div class="line">    protected boolean drawChild(Canvas canvas, View child, long drawingTime) &#123;</div><div class="line">        return child.draw(canvas, this, drawingTime);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里又调用了View的draw方法，直到具体的子View被绘制为止。</p>
<h2 id="Step5绘制渐变效果"><a href="#Step5绘制渐变效果" class="headerlink" title="Step5绘制渐变效果"></a>Step5绘制渐变效果</h2><p>在View的draw方法155-200行完成ViewGroup渐变效果的绘制</p>
<h2 id="Step6绘制其他装饰物"><a href="#Step6绘制其他装饰物" class="headerlink" title="Step6绘制其他装饰物"></a>Step6绘制其他装饰物</h2><p>在View的draw方法203行负责绘制其他装饰，包括前景、滚动条，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Draw any foreground content for this view.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Foreground content may consist of scroll bars, a &#123;@link #setForeground foreground&#125;</div><div class="line"> * drawable or other view-specific decorations. The foreground is drawn on top of the</div><div class="line"> * primary view content.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * @param canvas canvas to draw into</div><div class="line"> */</div><div class="line">public void onDrawForeground(Canvas canvas) &#123;</div><div class="line">    onDrawScrollIndicators(canvas);</div><div class="line">    onDrawScrollBars(canvas);</div><div class="line"></div><div class="line">    final Drawable foreground = mForegroundInfo != null ? mForegroundInfo.mDrawable : null;</div><div class="line">    if (foreground != null) &#123;</div><div class="line">        if (mForegroundInfo.mBoundsChanged) &#123;</div><div class="line">            mForegroundInfo.mBoundsChanged = false;</div><div class="line">            final Rect selfBounds = mForegroundInfo.mSelfBounds;</div><div class="line">            final Rect overlayBounds = mForegroundInfo.mOverlayBounds;</div><div class="line"></div><div class="line">            if (mForegroundInfo.mInsidePadding) &#123;</div><div class="line">                selfBounds.set(0, 0, getWidth(), getHeight());</div><div class="line">            &#125; else &#123;</div><div class="line">                selfBounds.set(getPaddingLeft(), getPaddingTop(),</div><div class="line">                        getWidth() - getPaddingRight(), getHeight() - getPaddingBottom());</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            final int ld = getLayoutDirection();</div><div class="line">            Gravity.apply(mForegroundInfo.mGravity, foreground.getIntrinsicWidth(),</div><div class="line">                    foreground.getIntrinsicHeight(), selfBounds, overlayBounds, ld);</div><div class="line">            foreground.setBounds(overlayBounds);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        foreground.draw(canvas);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码用户绘制滚动条和前景，如果当前布局设置了foreground，则调用foreground的draw方法进行绘制，看下绘制滚动条的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * &lt;p&gt;Request the drawing of the horizontal and the vertical scrollbar. The</div><div class="line"> * scrollbars are painted only if they have been awakened first.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * @param canvas the canvas on which to draw the scrollbars</div><div class="line"> *</div><div class="line"> * @see #awakenScrollBars(int)</div><div class="line"> */</div><div class="line">protected final void onDrawScrollBars(Canvas canvas) &#123;</div><div class="line">    // scrollbars are drawn only when the animation is running</div><div class="line">    final ScrollabilityCache cache = mScrollCache;</div><div class="line">    if (cache != null) &#123;</div><div class="line"></div><div class="line">        int state = cache.state;</div><div class="line"></div><div class="line">        if (state == ScrollabilityCache.OFF) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        boolean invalidate = false;</div><div class="line"></div><div class="line">        if (state == ScrollabilityCache.FADING) &#123;</div><div class="line">            // We&apos;re fading -- get our fade interpolation</div><div class="line">            if (cache.interpolatorValues == null) &#123;</div><div class="line">                cache.interpolatorValues = new float[1];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            float[] values = cache.interpolatorValues;</div><div class="line"></div><div class="line">            // Stops the animation if we&apos;re done</div><div class="line">            if (cache.scrollBarInterpolator.timeToValues(values) ==</div><div class="line">                    Interpolator.Result.FREEZE_END) &#123;</div><div class="line">                cache.state = ScrollabilityCache.OFF;</div><div class="line">            &#125; else &#123;</div><div class="line">                cache.scrollBar.mutate().setAlpha(Math.round(values[0]));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // This will make the scroll bars inval themselves after</div><div class="line">            // drawing. We only want this when we&apos;re fading so that</div><div class="line">            // we prevent excessive redraws</div><div class="line">            invalidate = true;</div><div class="line">        &#125; else &#123;</div><div class="line">            // We&apos;re just on -- but we may have been fading before so</div><div class="line">            // reset alpha</div><div class="line">            cache.scrollBar.mutate().setAlpha(255);</div><div class="line">        &#125;</div><div class="line">        //是否绘制水平和竖直方向上的滚动条，默认为false</div><div class="line">        final boolean drawHorizontalScrollBar = isHorizontalScrollBarEnabled();</div><div class="line">        final boolean drawVerticalScrollBar = isVerticalScrollBarEnabled()</div><div class="line">                &amp;&amp; !isVerticalScrollBarHidden();</div><div class="line"></div><div class="line">        if (drawVerticalScrollBar || drawHorizontalScrollBar) &#123;</div><div class="line">            final ScrollBarDrawable scrollBar = cache.scrollBar;</div><div class="line">            //绘制水平方向上的滚动条</div><div class="line">            if (drawHorizontalScrollBar) &#123;</div><div class="line">                scrollBar.setParameters(computeHorizontalScrollRange(),</div><div class="line">                                        computeHorizontalScrollOffset(),</div><div class="line">                                        computeHorizontalScrollExtent(), false);</div><div class="line">                final Rect bounds = cache.mScrollBarBounds;</div><div class="line">                getHorizontalScrollBarBounds(bounds);</div><div class="line">                onDrawHorizontalScrollBar(canvas, scrollBar, bounds.left, bounds.top,</div><div class="line">                        bounds.right, bounds.bottom);</div><div class="line">                if (invalidate) &#123;</div><div class="line">                    invalidate(bounds);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            //绘制垂直方向上的滚动条</div><div class="line">            if (drawVerticalScrollBar) &#123;</div><div class="line">                scrollBar.setParameters(computeVerticalScrollRange(),</div><div class="line">                                        computeVerticalScrollOffset(),</div><div class="line">                                        computeVerticalScrollExtent(), true);</div><div class="line">                final Rect bounds = cache.mScrollBarBounds;</div><div class="line">                getVerticalScrollBarBounds(bounds);</div><div class="line">                onDrawVerticalScrollBar(canvas, scrollBar, bounds.left, bounds.top,</div><div class="line">                        bounds.right, bounds.bottom);</div><div class="line">                if (invalidate) &#123;</div><div class="line">                    invalidate(bounds);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>16行，判断是否需要绘制滚动条，如果当前布局设置了android:scrollbars=“none”属性，不绘制滚动条；<br>22行，判断滚动条是否可消失，如果当前布局设置了android:fadeScrollbars=“true”属性，当滑动时，滚动条显示，不滑动时，滚动条消失，这里是通过setAlpha来改变Alpha值完成；<br>45行，如果当前布局设置了android:fadeScrollbars=“false”属性，则不管滑动与否，滚动条一直显示。<br>从上面的代码也可以看出所有的View都会绘制滚动条，只是有些没有显示出来。</p>
<h2 id="draw总结"><a href="#draw总结" class="headerlink" title="draw总结"></a>draw总结</h2><p><a href="http://7xjvg5.com1.z0.glb.clouddn.com/draw.png" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/draw.png" alt="img"></a></p>
<p>View的具体绘制在子View中实现，父View主要绘制背景以及渐变效果，自定义View时重写onDraw方法实现具体绘制，所有的View都会绘制滚动条，该操作在父View中完成。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/26/Android View绘制源码分析--Layout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/26/Android View绘制源码分析--Layout/" itemprop="url">Android View绘制源码分析--Layout</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-26T00:00:00+08:00">
                2017-05-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/26/Android View绘制源码分析--Layout/" class="leancloud_visitors" data-flag-title="Android View绘制源码分析--Layout">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>上篇文章分析DecorView的绘制的measure流程，这篇文章继续分析DecorView绘制的第二个阶段，layout流程。</p>
<h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p>先看ViewRootImpl的performLayout方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewRootImpl.java</div><div class="line">    private void performLayout(WindowManager.LayoutParams lp, int desiredWindowWidth,</div><div class="line">            int desiredWindowHeight) &#123;</div><div class="line">        mLayoutRequested = false;</div><div class="line">        mScrollMayChange = true;</div><div class="line">        //布局开始</div><div class="line">        mInLayout = true;</div><div class="line">        //host就是DecorView</div><div class="line">        final View host = mView;</div><div class="line"></div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;layout&quot;);</div><div class="line">        try &#123;</div><div class="line">            //DecorView开始布局,以左上角为原点</div><div class="line">            host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line">            //布局结束</div><div class="line">            mInLayout = false;</div><div class="line">            //这里mLayoutRequesters的size值在requestLayoutDuringLayout方法中会改变，requestLayoutDuringLayout会在View的requestLayout中被调用</div><div class="line">            int numViewsRequestingLayout = mLayoutRequesters.size();</div><div class="line">            if (numViewsRequestingLayout &gt; 0) &#123;</div><div class="line">                // requestLayout() was called during layout.</div><div class="line">                // If no layout-request flags are set on the requesting views, there is no problem.</div><div class="line">                // If some requests are still pending, then we need to clear those flags and do</div><div class="line">                // a full request/measure/layout pass to handle this situation.</div><div class="line">                ArrayList&lt;View&gt; validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters,</div><div class="line">                        false);</div><div class="line">                if (validLayoutRequesters != null) &#123;</div><div class="line">                    // Set this flag to indicate that any further requests are happening during</div><div class="line">                    // the second pass, which may result in posting those requests to the next</div><div class="line">                    // frame instead</div><div class="line">                    mHandlingLayoutInLayoutRequest = true;</div><div class="line"></div><div class="line">                    // Process fresh layout requests, then measure and layout</div><div class="line">                    int numValidRequests = validLayoutRequesters.size();</div><div class="line">                    for (int i = 0; i &lt; numValidRequests; ++i) &#123;</div><div class="line">                        final View view = validLayoutRequesters.get(i);</div><div class="line">                        Log.w(&quot;View&quot;, &quot;requestLayout() improperly called by &quot; + view +</div><div class="line">                                &quot; during layout: running second layout pass&quot;);</div><div class="line">                        view.requestLayout();</div><div class="line">                    &#125;</div><div class="line">                    measureHierarchy(host, lp, mView.getContext().getResources(),</div><div class="line">                            desiredWindowWidth, desiredWindowHeight);</div><div class="line">                    mInLayout = true;</div><div class="line">                    host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line"></div><div class="line">                    mHandlingLayoutInLayoutRequest = false;</div><div class="line"></div><div class="line">                    // Check the valid requests again, this time without checking/clearing the</div><div class="line">                    // layout flags, since requests happening during the second pass get noop&apos;d</div><div class="line">                    validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, true);</div><div class="line">                    if (validLayoutRequesters != null) &#123;</div><div class="line">                        final ArrayList&lt;View&gt; finalRequesters = validLayoutRequesters;</div><div class="line">                        // Post second-pass requests to the next frame</div><div class="line">                        getRunQueue().post(new Runnable() &#123;</div><div class="line">                            @Override</div><div class="line">                            public void run() &#123;</div><div class="line">                                int numValidRequests = finalRequesters.size();</div><div class="line">                                for (int i = 0; i &lt; numValidRequests; ++i) &#123;</div><div class="line">                                    final View view = finalRequesters.get(i);</div><div class="line">                                    Log.w(&quot;View&quot;, &quot;requestLayout() improperly called by &quot; + view +</div><div class="line">                                            &quot; during second layout pass: posting in next frame&quot;);</div><div class="line">                                    view.requestLayout();</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125; finally &#123;</div><div class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">        &#125;</div><div class="line">        mInLayout = false;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在13行调用DecorView的layout方法，传入的位置参数左0，上0，右为设备的宽度，下为设备的高度；在DecorView和FrameLayout中都没找到layout方法，继续往上查看ViewGroup，layout方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewGroup.java</div><div class="line">    public final void layout(int l, int t, int r, int b) &#123;</div><div class="line">        if (!mSuppressLayout &amp;&amp; (mTransition == null || !mTransition.isChangingLayout())) &#123;</div><div class="line">            if (mTransition != null) &#123;</div><div class="line">                mTransition.layoutChange(this);</div><div class="line">            &#125;</div><div class="line">            super.layout(l, t, r, b);</div><div class="line">        &#125; else &#123;</div><div class="line">            // record the fact that we noop&apos;d it; request layout when transition finishes</div><div class="line">            mLayoutCalledWhileSuppressed = true;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>注意到这里的layout的修饰是final，说明ViewGroup的子类无法复写该方法，该方法又回调了父类的layout方法，所以看下View中的layout:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">     * Assign a size and position to a view and all of its</div><div class="line">     * descendants</div><div class="line">     *</div><div class="line">     * &lt;p&gt;This is the second phase of the layout mechanism.</div><div class="line">     * (The first is measuring). In this phase, each parent calls</div><div class="line">     * layout on all of its children to position them.</div><div class="line">     * This is typically done using the child measurements</div><div class="line">     * that were stored in the measure pass().&lt;/p&gt;</div><div class="line">     *</div><div class="line">     * &lt;p&gt;Derived classes should not override this method.</div><div class="line">     * Derived classes with children should override</div><div class="line">     * onLayout. In that method, they should</div><div class="line">     * call layout on each of their children.&lt;/p&gt;</div><div class="line">     *</div><div class="line">     * @param l Left position, relative to parent</div><div class="line">     * @param t Top position, relative to parent</div><div class="line">     * @param r Right position, relative to parent</div><div class="line">     * @param b Bottom position, relative to parent</div><div class="line">     */</div><div class="line">    @SuppressWarnings(&#123;&quot;unchecked&quot;&#125;)</div><div class="line">    public void layout(int l, int t, int r, int b) &#123;</div><div class="line">        //是否需要重新测量</div><div class="line">        if ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != 0) &#123;</div><div class="line">            onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);</div><div class="line">            mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">        &#125;</div><div class="line">        //保存之前View的位置</div><div class="line">        int oldL = mLeft;</div><div class="line">        int oldT = mTop;</div><div class="line">        int oldB = mBottom;</div><div class="line">        int oldR = mRight;</div><div class="line">        //与之前相比位置是否发生改变，通过setFrame方法设置最新的位置</div><div class="line">        boolean changed = isLayoutModeOptical(mParent) ?</div><div class="line">                setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</div><div class="line"></div><div class="line">        if (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</div><div class="line">            //若发生了改变，具体的布局实现</div><div class="line">            onLayout(changed, l, t, r, b);</div><div class="line">            mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;</div><div class="line"></div><div class="line">            ListenerInfo li = mListenerInfo;</div><div class="line">            if (li != null &amp;&amp; li.mOnLayoutChangeListeners != null) &#123;</div><div class="line">                ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =</div><div class="line">                        (ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();</div><div class="line">                int numListeners = listenersCopy.size();</div><div class="line">                for (int i = 0; i &lt; numListeners; ++i) &#123;</div><div class="line">                    //若设置了布局变化的监听事件，当布局发生变化时触发</div><div class="line">                    listenersCopy.get(i).onLayoutChange(this, l, t, r, b, oldL, oldT, oldR, oldB);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</div><div class="line">        mPrivateFlags3 |= PFLAG3_IS_LAID_OUT;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>通过注释我们了解到，这是绘制机制的第二部分，在这部分父布局会调用layout方法确定子布局的位置，并且子类不应该复写layout而应该复写onLayout。查看这里的setFrame方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Assign a size and position to this view.</div><div class="line"> *</div><div class="line"> * This is called from layout.</div><div class="line"> *</div><div class="line"> * @param left Left position, relative to parent</div><div class="line"> * @param top Top position, relative to parent</div><div class="line"> * @param right Right position, relative to parent</div><div class="line"> * @param bottom Bottom position, relative to parent</div><div class="line"> * @return true if the new size and position are different than the</div><div class="line"> *         previous ones</div><div class="line"> * &#123;@hide&#125;</div><div class="line"> */</div><div class="line">protected boolean setFrame(int left, int top, int right, int bottom) &#123;</div><div class="line">    boolean changed = false;</div><div class="line"></div><div class="line">    if (mLeft != left || mRight != right || mTop != top || mBottom != bottom) &#123;</div><div class="line">        //与之前相比上下左右只要有一个改变就为true</div><div class="line">        changed = true;</div><div class="line"></div><div class="line">        // Remember our drawn bit</div><div class="line">        int drawn = mPrivateFlags &amp; PFLAG_DRAWN;</div><div class="line">        //之前的宽度</div><div class="line">        int oldWidth = mRight - mLeft;</div><div class="line">        //之前的高度</div><div class="line">        int oldHeight = mBottom - mTop;</div><div class="line">        //新的宽度</div><div class="line">        int newWidth = right - left;</div><div class="line">        //新的高度</div><div class="line">        int newHeight = bottom - top;</div><div class="line">        //大小是否改变</div><div class="line">        boolean sizeChanged = (newWidth != oldWidth) || (newHeight != oldHeight);</div><div class="line"></div><div class="line">        // Invalidate our old position</div><div class="line">        //清除之前的位置</div><div class="line">        invalidate(sizeChanged);</div><div class="line">        //最新的位置赋值，View的位置就确定了</div><div class="line">        mLeft = left;</div><div class="line">        mTop = top;</div><div class="line">        mRight = right;</div><div class="line">        mBottom = bottom;</div><div class="line">        mRenderNode.setLeftTopRightBottom(mLeft, mTop, mRight, mBottom);</div><div class="line"></div><div class="line">        mPrivateFlags |= PFLAG_HAS_BOUNDS;</div><div class="line"></div><div class="line"></div><div class="line">        if (sizeChanged) &#123;</div><div class="line">            sizeChange(newWidth, newHeight, oldWidth, oldHeight);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if ((mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || mGhostView != null) &#123;</div><div class="line">            // If we are visible, force the DRAWN bit to on so that</div><div class="line">            // this invalidate will go through (at least to our parent).</div><div class="line">            // This is because someone may have invalidated this view</div><div class="line">            // before this call to setFrame came in, thereby clearing</div><div class="line">            // the DRAWN bit.</div><div class="line">            mPrivateFlags |= PFLAG_DRAWN;</div><div class="line">            invalidate(sizeChanged);</div><div class="line">            // parent display list may need to be recreated based on a change in the bounds</div><div class="line">            // of any child</div><div class="line">            invalidateParentCaches();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Reset drawn bit to original value (invalidate turns it off)</div><div class="line">        mPrivateFlags |= drawn;</div><div class="line"></div><div class="line">        mBackgroundSizeChanged = true;</div><div class="line">        if (mForegroundInfo != null) &#123;</div><div class="line">            mForegroundInfo.mBoundsChanged = true;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        notifySubtreeAccessibilityStateChangedIfNeeded();</div><div class="line">    &#125;</div><div class="line">    return changed;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从该方法可以知道，如果位置发生了变化，则会保存最新的位置值，而这里也是四个位置值初始化的地方，我们平时调用getWidth/getHeight如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Return the width of the your view.</div><div class="line"> *</div><div class="line"> * @return The width of your view, in pixels.</div><div class="line"> */</div><div class="line">@ViewDebug.ExportedProperty(category = &quot;layout&quot;)</div><div class="line">public final int getWidth() &#123;</div><div class="line">    return mRight - mLeft;</div><div class="line">&#125;</div><div class="line">/**</div><div class="line"> * Return the height of your view.</div><div class="line"> *</div><div class="line"> * @return The height of your view, in pixels.</div><div class="line"> */</div><div class="line">@ViewDebug.ExportedProperty(category = &quot;layout&quot;)</div><div class="line">public final int getHeight() &#123;</div><div class="line">    return mBottom - mTop;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因此，必须在layout方法执行后调用getWidth、getHeight才有效。回到View的layout方法，既然在setFrame中已经确定了布局的位置，那么onLayout方法又是用来干嘛的呢？DecorView中复写了onLayout</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">    protected void onLayout(boolean changed, int left, int top, int right, int bottom) &#123;</div><div class="line">        super.onLayout(changed, left, top, right, bottom);</div><div class="line">        getOutsets(mOutsets);</div><div class="line">        if (mOutsets.left &gt; 0) &#123;</div><div class="line">            offsetLeftAndRight(-mOutsets.left);</div><div class="line">        &#125;</div><div class="line">        if (mOutsets.top &gt; 0) &#123;</div><div class="line">            offsetTopAndBottom(-mOutsets.top);</div><div class="line">        &#125;</div><div class="line">        if (mApplyFloatingVerticalInsets) &#123;</div><div class="line">            offsetTopAndBottom(mFloatingInsets.top);</div><div class="line">        &#125;</div><div class="line">        if (mApplyFloatingHorizontalInsets) &#123;</div><div class="line">            offsetLeftAndRight(mFloatingInsets.left);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // If the application changed its SystemUI metrics, we might also have to adapt</div><div class="line">        // our shadow elevation.</div><div class="line">        updateElevation();</div><div class="line">        mAllowUpdateElevation = true;</div><div class="line"></div><div class="line">        if (changed &amp;&amp; mResizeMode == RESIZE_MODE_DOCKED_DIVIDER) &#123;</div><div class="line">            getViewRootImpl().requestInvalidateRootRenderNode();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里又调用了父类的onLayout，看下FrameLayout的onLayout</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">源码路径：SDK/sources/android-24/android/widget/FrameLayout.java</div><div class="line">    protected void onLayout(boolean changed, int left, int top, int right, int bottom) &#123;</div><div class="line">        layoutChildren(left, top, right, bottom, false /* no force left gravity */);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    void layoutChildren(int left, int top, int right, int bottom, boolean forceLeftGravity) &#123;</div><div class="line">        final int count = getChildCount();</div><div class="line">        //获取父布局的位置</div><div class="line">        final int parentLeft = getPaddingLeftWithForeground();</div><div class="line">        final int parentRight = right - left - getPaddingRightWithForeground();</div><div class="line"></div><div class="line">        final int parentTop = getPaddingTopWithForeground();</div><div class="line">        final int parentBottom = bottom - top - getPaddingBottomWithForeground();</div><div class="line">        //遍历子布局</div><div class="line">        for (int i = 0; i &lt; count; i++) &#123;</div><div class="line">            final View child = getChildAt(i);</div><div class="line">            //如果子布局的Visibility属性不为GONE</div><div class="line">            if (child.getVisibility() != GONE) &#123;</div><div class="line">                final LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">                //获取子布局的宽高</div><div class="line">                final int width = child.getMeasuredWidth();</div><div class="line">                final int height = child.getMeasuredHeight();</div><div class="line">                //子布局左、上位置</div><div class="line">                int childLeft;</div><div class="line">                int childTop;</div><div class="line"></div><div class="line">                int gravity = lp.gravity;</div><div class="line">                if (gravity == -1) &#123;</div><div class="line">                    gravity = DEFAULT_CHILD_GRAVITY;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                final int layoutDirection = getLayoutDirection();</div><div class="line">                final int absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);</div><div class="line">                final int verticalGravity = gravity &amp; Gravity.VERTICAL_GRAVITY_MASK;</div><div class="line">                //计算子布局的左位置</div><div class="line">                switch (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) &#123;</div><div class="line">                    case Gravity.CENTER_HORIZONTAL:</div><div class="line">                        childLeft = parentLeft + (parentRight - parentLeft - width) / 2 +</div><div class="line">                        lp.leftMargin - lp.rightMargin;</div><div class="line">                        break;</div><div class="line">                    case Gravity.RIGHT:</div><div class="line">                        if (!forceLeftGravity) &#123;</div><div class="line">                            childLeft = parentRight - width - lp.rightMargin;</div><div class="line">                            break;</div><div class="line">                        &#125;</div><div class="line">                    case Gravity.LEFT:</div><div class="line">                    default:</div><div class="line">                        childLeft = parentLeft + lp.leftMargin;</div><div class="line">                &#125;</div><div class="line">                //计算子布局的上位置</div><div class="line">                switch (verticalGravity) &#123;</div><div class="line">                    case Gravity.TOP:</div><div class="line">                        childTop = parentTop + lp.topMargin;</div><div class="line">                        break;</div><div class="line">                    case Gravity.CENTER_VERTICAL:</div><div class="line">                        childTop = parentTop + (parentBottom - parentTop - height) / 2 +</div><div class="line">                        lp.topMargin - lp.bottomMargin;</div><div class="line">                        break;</div><div class="line">                    case Gravity.BOTTOM:</div><div class="line">                        childTop = parentBottom - height - lp.bottomMargin;</div><div class="line">                        break;</div><div class="line">                    default:</div><div class="line">                        childTop = parentTop + lp.topMargin;</div><div class="line">                &#125;</div><div class="line">                //子布局根据位置调用layout自身布局</div><div class="line">                child.layout(childLeft, childTop, childLeft + width, childTop + height);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>FrameLayout中的onLayout又调用了自身的layoutChildren方法，从名字可以大致判断该方法是为子View确定位置的，layoutChildren中遍历FrameLayout下的所有子View，如果子View的Visibility属性不为GONE，根据父布局的位置计算子View的位置，主要和子View的gravity有关，最后再调用子View的layout方法确定位置，因此这里就解答了上面的疑惑，FrameLayout的位置是在父类View中就确定了的，不像measure流程大小是由子View的大小确定。另外FrameLayout extends ViewGroup extends View，分别再看下ViewGroup 和View中onLayout方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewGroup.java</div><div class="line">    protected abstract void onLayout(boolean changed,</div><div class="line">            int l, int t, int r, int b);</div><div class="line"></div><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">     * Called from layout when this view should</div><div class="line">     * assign a size and position to each of its children.</div><div class="line">     *</div><div class="line">     * Derived classes with children should override</div><div class="line">     * this method and call layout on each of</div><div class="line">     * their children.</div><div class="line">     * @param changed This is a new size or position for this view</div><div class="line">     * @param left Left position, relative to parent</div><div class="line">     * @param top Top position, relative to parent</div><div class="line">     * @param right Right position, relative to parent</div><div class="line">     * @param bottom Bottom position, relative to parent</div><div class="line">     */</div><div class="line">    protected void onLayout(boolean changed, int left, int top, int right, int bottom) &#123;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ViewGroup中的onLayout是个抽象方法，所以ViewGroup的子类必须实现onLayout，View中的onLayout是个空方法，所以具体的实现在子类中完成。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><a href="http://7xjvg5.com1.z0.glb.clouddn.com/layout.png" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/layout.png" alt="img"></a></p>
<ul>
<li>FrameLayout的位置是在父类View中就确定了的，不像measure流程大小是由子View的大小确定</li>
<li>自定义ViewGroup必须实现onLayout方法，因为在ViewGroup中该方法是个抽象方法</li>
<li>在layout执行完成后调用View的getWidth、getHeight方法才能返回有效值，因此位置是在layout步骤的setFrame方法中初始化的。</li>
<li>如果布局中的View的Visibility属性设置为GONE，则不对该View进行布局，该View不占据屏幕空间</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/25/Android View绘制源码分析--Measure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/25/Android View绘制源码分析--Measure/" itemprop="url">Android View绘制源码分析--Measure</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-25T00:00:00+08:00">
                2017-05-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/25/Android View绘制源码分析--Measure/" class="leancloud_visitors" data-flag-title="Android View绘制源码分析--Measure">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在Android中所有布局或者控件都直接或间接继承至View，因此它们拥有相同的绘制机制。以前的学习经验知道View在绘制过程中会经过measure、layout、draw三个流程，measure负责测量View的宽高，layout负责确定View在父容器中的位置，draw负责将View绘制到屏幕上。上篇文章分析到DecorView的绘制从ViewRootImpl类中的performTraversals开始，这篇主要分析View绘制流程中的measure部分。</p>
<h2 id="ViewRootImpl-performTraversals"><a href="#ViewRootImpl-performTraversals" class="headerlink" title="ViewRootImpl performTraversals()"></a>ViewRootImpl performTraversals()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewRootImpl.java</div><div class="line">    private void performTraversals() &#123;</div><div class="line">        // cache mView since it is used so much below...</div><div class="line">        final View host = mView;</div><div class="line">        ......</div><div class="line">        WindowManager.LayoutParams lp = mWindowAttributes;</div><div class="line">        ......</div><div class="line">        int childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width);</div><div class="line">        int childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height);</div><div class="line">        // Ask host how big it wants to be</div><div class="line">        performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">        ......</div><div class="line">        performLayout(lp, mWidth, mHeight);</div><div class="line">        ......</div><div class="line">        performDraw();</div><div class="line">        ......</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>查看这里的getRootMeasureSpec方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewRootImpl .java</div><div class="line">    /**</div><div class="line">     * Figures out the measure spec for the root view in a window based on it&apos;s</div><div class="line">     * layout params.</div><div class="line">     *</div><div class="line">     * @param windowSize</div><div class="line">     *            The available width or height of the window</div><div class="line">     *</div><div class="line">     * @param rootDimension</div><div class="line">     *            The layout params for one dimension (width or height) of the</div><div class="line">     *            window.</div><div class="line">     *</div><div class="line">     * @return The measure spec to use to measure the root view.</div><div class="line">     */</div><div class="line">    private static int getRootMeasureSpec(int windowSize, int rootDimension) &#123;</div><div class="line">        int measureSpec;</div><div class="line">        switch (rootDimension) &#123;</div><div class="line"></div><div class="line">        case ViewGroup.LayoutParams.MATCH_PARENT:</div><div class="line">            // Window can&apos;t resize. Force root view to be windowSize.</div><div class="line">            measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);</div><div class="line">            break;</div><div class="line">        case ViewGroup.LayoutParams.WRAP_CONTENT:</div><div class="line">            // Window can resize. Set max size for root view.</div><div class="line">            measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.AT_MOST);</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            // Window wants to be an exact size. Force root view to be that size.</div><div class="line">            measureSpec = MeasureSpec.makeMeasureSpec(rootDimension, MeasureSpec.EXACTLY);</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">        return measureSpec;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>根据注释可知，该方法作用是根据根视图的布局参数推算出的其测量规格，这里的第二个参数传的是DecorView的LayoutParam对应的宽高，由之前的文章分析可知DecorView在生成布局时指定的宽高均为MATCH_PARENT，满足第一个分支，通过MeasureSpec的makeMeasureSpec方法生成测量规格并返回，查看该方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">        /**</div><div class="line">         * Creates a measure specification based on the supplied size and mode.</div><div class="line">         *</div><div class="line">         * The mode must always be one of the following:</div><div class="line">         * &lt;ul&gt;</div><div class="line">         *  &lt;li&gt;&#123;@link android.view.View.MeasureSpec#UNSPECIFIED&#125;&lt;/li&gt;</div><div class="line">         *  &lt;li&gt;&#123;@link android.view.View.MeasureSpec#EXACTLY&#125;&lt;/li&gt;</div><div class="line">         *  &lt;li&gt;&#123;@link android.view.View.MeasureSpec#AT_MOST&#125;&lt;/li&gt;</div><div class="line">         * &lt;/ul&gt;</div><div class="line">         *</div><div class="line">         * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; On API level 17 and lower, makeMeasureSpec&apos;s</div><div class="line">         * implementation was such that the order of arguments did not matter</div><div class="line">         * and overflow in either value could impact the resulting MeasureSpec.</div><div class="line">         * &#123;@link android.widget.RelativeLayout&#125; was affected by this bug.</div><div class="line">         * Apps targeting API levels greater than 17 will get the fixed, more strict</div><div class="line">         * behavior.&lt;/p&gt;</div><div class="line">         *</div><div class="line">         * @param size the size of the measure specification</div><div class="line">         * @param mode the mode of the measure specification</div><div class="line">         * @return the measure specification based on size and mode</div><div class="line">         */</div><div class="line">        public static int makeMeasureSpec(@IntRange(from = 0, to = (1 &lt;&lt; MeasureSpec.MODE_SHIFT) - 1) int size,</div><div class="line">                                          @MeasureSpecMode int mode) &#123;</div><div class="line">            if (sUseBrokenMakeMeasureSpec) &#123;</div><div class="line">                return size + mode;</div><div class="line">            &#125; else &#123;</div><div class="line">                return (size &amp; ~MODE_MASK) | (mode &amp; MODE_MASK);</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>根据注释可知，该方法将传入的大小和模式生成对应的测量规格，这里多说一点MeasureSpec，它是一个由模式和大小组合的32位int整型值，高二位代表mode，低30位代表size，计算中使用了位运算来提高并优化效率，MeasureSpec有三种模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Measure specification mode: The parent has not imposed any constraint</div><div class="line"> * on the child. It can be whatever size it wants.</div><div class="line"> */</div><div class="line">//不确定模式：父布局对子布局没有限制，子布局想要多大就多大，0左移30位</div><div class="line">public static final int UNSPECIFIED = 0 &lt;&lt; MODE_SHIFT;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Measure specification mode: The parent has determined an exact size</div><div class="line"> * for the child. The child is going to be given those bounds regardless</div><div class="line"> * of how big it wants to be.</div><div class="line"> */</div><div class="line">//确定模式：父布局为子布局规定了一个准确的区域，不管子布局想要多大都不能超过规定范围，1左移30位</div><div class="line">public static final int EXACTLY     = 1 &lt;&lt; MODE_SHIFT;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Measure specification mode: The child can be as large as it wants up</div><div class="line"> * to the specified size.</div><div class="line"> */</div><div class="line">//最大模式：子布局可以和自己想要的一样大，2左移30位</div><div class="line">public static final int AT_MOST     = 2 &lt;&lt; MODE_SHIFT;</div></pre></td></tr></table></figure>
<p>回到上面，在获取到DecorView宽高的测量规格后，调用performMeasure()方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">private void performMeasure(int childWidthMeasureSpec, int childHeightMeasureSpec) &#123;</div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;measure&quot;);</div><div class="line">    try &#123;</div><div class="line">        mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">    &#125; finally &#123;</div><div class="line">        Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据传入的宽高测量规格调用mView的measure方法，这里的mView就是DecorView，DecorView extends FrameLayout extends ViewGroup extends View，DecorView 、FrameLayout以及ViewGroup都没有重写measure方法，因此在View中查看measure方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">     * &lt;p&gt;</div><div class="line">     * This is called to find out how big a view should be. The parent</div><div class="line">     * supplies constraint information in the width and height parameters.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * &lt;p&gt;</div><div class="line">     * The actual measurement work of a view is performed in</div><div class="line">     * &#123;@link #onMeasure(int, int)&#125;, called by this method. Therefore, only</div><div class="line">     * &#123;@link #onMeasure(int, int)&#125; can and must be overridden by subclasses.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     *</div><div class="line">     * @param widthMeasureSpec Horizontal space requirements as imposed by the</div><div class="line">     *        parent</div><div class="line">     * @param heightMeasureSpec Vertical space requirements as imposed by the</div><div class="line">     *        parent</div><div class="line">     *</div><div class="line">     * @see #onMeasure(int, int)</div><div class="line">     */</div><div class="line">    public final void measure(int widthMeasureSpec, int heightMeasureSpec) &#123;</div><div class="line">        boolean optical = isLayoutModeOptical(this);</div><div class="line">        if (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line">            Insets insets = getOpticalInsets();</div><div class="line">            int oWidth  = insets.left + insets.right;</div><div class="line">            int oHeight = insets.top  + insets.bottom;</div><div class="line">            widthMeasureSpec  = MeasureSpec.adjust(widthMeasureSpec,  optical ? -oWidth  : oWidth);</div><div class="line">            heightMeasureSpec = MeasureSpec.adjust(heightMeasureSpec, optical ? -oHeight : oHeight);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Suppress sign extension for the low bytes</div><div class="line">        long key = (long) widthMeasureSpec &lt;&lt; 32 | (long) heightMeasureSpec &amp; 0xffffffffL;</div><div class="line">        if (mMeasureCache == null) mMeasureCache = new LongSparseLongArray(2);</div><div class="line"></div><div class="line">        final boolean forceLayout = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT;</div><div class="line"></div><div class="line">        // Optimize layout by avoiding an extra EXACTLY pass when the view is</div><div class="line">        // already measured as the correct size. In API 23 and below, this</div><div class="line">        // extra pass is required to make LinearLayout re-distribute weight.</div><div class="line">        //与上次相比测量规格是否改变</div><div class="line">        final boolean specChanged = widthMeasureSpec != mOldWidthMeasureSpec</div><div class="line">                || heightMeasureSpec != mOldHeightMeasureSpec;</div><div class="line">        final boolean isSpecExactly = MeasureSpec.getMode(widthMeasureSpec) == MeasureSpec.EXACTLY</div><div class="line">                &amp;&amp; MeasureSpec.getMode(heightMeasureSpec) == MeasureSpec.EXACTLY;</div><div class="line">        final boolean matchesSpecSize = getMeasuredWidth() == MeasureSpec.getSize(widthMeasureSpec)</div><div class="line">                &amp;&amp; getMeasuredHeight() == MeasureSpec.getSize(heightMeasureSpec);</div><div class="line">        final boolean needsLayout = specChanged</div><div class="line">                &amp;&amp; (sAlwaysRemeasureExactly || !isSpecExactly || !matchesSpecSize);</div><div class="line"></div><div class="line">        if (forceLayout || needsLayout) &#123;</div><div class="line">            // first clears the measured dimension flag</div><div class="line">            mPrivateFlags &amp;= ~PFLAG_MEASURED_DIMENSION_SET;</div><div class="line"></div><div class="line">            resolveRtlPropertiesIfNeeded();</div><div class="line"></div><div class="line">            int cacheIndex = forceLayout ? -1 : mMeasureCache.indexOfKey(key);</div><div class="line">            if (cacheIndex &lt; 0 || sIgnoreMeasureCache) &#123;</div><div class="line">                // measure ourselves, this should set the measured dimension flag back</div><div class="line">                //调用了onMeasure方法测量</div><div class="line">                onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">                mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">            &#125; else &#123;</div><div class="line">                long value = mMeasureCache.valueAt(cacheIndex);</div><div class="line">                // Casting a long to int drops the high 32 bits, no mask needed</div><div class="line">                setMeasuredDimensionRaw((int) (value &gt;&gt; 32), (int) value);</div><div class="line">                mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // flag not set, setMeasuredDimension() was not invoked, we raise</div><div class="line">            // an exception to warn the developer</div><div class="line">            if ((mPrivateFlags &amp; PFLAG_MEASURED_DIMENSION_SET) != PFLAG_MEASURED_DIMENSION_SET) &#123;</div><div class="line">                throw new IllegalStateException(&quot;View with id &quot; + getId() + &quot;: &quot;</div><div class="line">                        + getClass().getName() + &quot;#onMeasure() did not set the&quot;</div><div class="line">                        + &quot; measured dimension by calling&quot;</div><div class="line">                        + &quot; setMeasuredDimension()&quot;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mPrivateFlags |= PFLAG_LAYOUT_REQUIRED;</div><div class="line">        &#125;</div><div class="line">        //保存本次View的测量规格用于下次判断</div><div class="line">        mOldWidthMeasureSpec = widthMeasureSpec;</div><div class="line">        mOldHeightMeasureSpec = heightMeasureSpec;</div><div class="line"></div><div class="line">        mMeasureCache.put(key, ((long) mMeasuredWidth) &lt;&lt; 32 |</div><div class="line">                (long) mMeasuredHeight &amp; 0xffffffffL); // suppress sign extension</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从注释可知，该方法是查明一个View应该有多大，父布局可以在宽高参数中提供约束信息，实际的测量工作是在这个方法的onMeasure中完成的，因此，子类只能重写onMeasure方法。查看View的onMeasure方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * &lt;p&gt;</div><div class="line"> * Measure the view and its content to determine the measured width and the</div><div class="line"> * measured height. This method is invoked by &#123;@link #measure(int, int)&#125; and</div><div class="line"> * should be overridden by subclasses to provide accurate and efficient</div><div class="line"> * measurement of their contents.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * &lt;strong&gt;CONTRACT:&lt;/strong&gt; When overriding this method, you</div><div class="line"> * &lt;em&gt;must&lt;/em&gt; call &#123;@link #setMeasuredDimension(int, int)&#125; to store the</div><div class="line"> * measured width and height of this view. Failure to do so will trigger an</div><div class="line"> * &lt;code&gt;IllegalStateException&lt;/code&gt;, thrown by</div><div class="line"> * &#123;@link #measure(int, int)&#125;. Calling the superclass&apos;</div><div class="line"> * &#123;@link #onMeasure(int, int)&#125; is a valid use.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * The base class implementation of measure defaults to the background size,</div><div class="line"> * unless a larger size is allowed by the MeasureSpec. Subclasses should</div><div class="line"> * override &#123;@link #onMeasure(int, int)&#125; to provide better measurements of</div><div class="line"> * their content.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * If this method is overridden, it is the subclass&apos;s responsibility to make</div><div class="line"> * sure the measured height and width are at least the view&apos;s minimum height</div><div class="line"> * and width (&#123;@link #getSuggestedMinimumHeight()&#125; and</div><div class="line"> * &#123;@link #getSuggestedMinimumWidth()&#125;).</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * @param widthMeasureSpec horizontal space requirements as imposed by the parent.</div><div class="line"> *                         The requirements are encoded with</div><div class="line"> *                         &#123;@link android.view.View.MeasureSpec&#125;.</div><div class="line"> * @param heightMeasureSpec vertical space requirements as imposed by the parent.</div><div class="line"> *                         The requirements are encoded with</div><div class="line"> *                         &#123;@link android.view.View.MeasureSpec&#125;.</div><div class="line"> *</div><div class="line"> * @see #getMeasuredWidth()</div><div class="line"> * @see #getMeasuredHeight()</div><div class="line"> * @see #setMeasuredDimension(int, int)</div><div class="line"> * @see #getSuggestedMinimumHeight()</div><div class="line"> * @see #getSuggestedMinimumWidth()</div><div class="line"> * @see android.view.View.MeasureSpec#getMode(int)</div><div class="line"> * @see android.view.View.MeasureSpec#getSize(int)</div><div class="line"> */</div><div class="line">protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</div><div class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</div><div class="line">            getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注释里有一条很重要的介绍，setMeasuredDimension方法必须在onMeasure方法中调用，不然会抛异常。可以看到View的onMeasure内部只是调用了setMeasuredDimension方法，参数一个套一个，先看下setMeasuredDimension</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * &lt;p&gt;This method must be called by &#123;@link #onMeasure(int, int)&#125; to store the</div><div class="line"> * measured width and measured height. Failing to do so will trigger an</div><div class="line"> * exception at measurement time.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * @param measuredWidth The measured width of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;@link #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;@link #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> * @param measuredHeight The measured height of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;@link #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;@link #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> */</div><div class="line">protected final void setMeasuredDimension(int measuredWidth, int measuredHeight) &#123;</div><div class="line">    boolean optical = isLayoutModeOptical(this);</div><div class="line">    if (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line">        Insets insets = getOpticalInsets();</div><div class="line">        int opticalWidth  = insets.left + insets.right;</div><div class="line">        int opticalHeight = insets.top  + insets.bottom;</div><div class="line"></div><div class="line">        measuredWidth  += optical ? opticalWidth  : -opticalWidth;</div><div class="line">        measuredHeight += optical ? opticalHeight : -opticalHeight;</div><div class="line">    &#125;</div><div class="line">    setMeasuredDimensionRaw(measuredWidth, measuredHeight);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的setMeasuredDimension将传入的宽高值转手又传给了setMeasuredDimensionRaw</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Sets the measured dimension without extra processing for things like optical bounds.</div><div class="line"> * Useful for reapplying consistent values that have already been cooked with adjustments</div><div class="line"> * for optical bounds, etc. such as those from the measurement cache.</div><div class="line"> *</div><div class="line"> * @param measuredWidth The measured width of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;@link #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;@link #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> * @param measuredHeight The measured height of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;@link #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;@link #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> */</div><div class="line">private void setMeasuredDimensionRaw(int measuredWidth, int measuredHeight) &#123;</div><div class="line">    mMeasuredWidth = measuredWidth;</div><div class="line">    mMeasuredHeight = measuredHeight;</div><div class="line"></div><div class="line">    mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这个方法中只是将传入的宽高值对View的系统变量赋值，测量流程就走完了。返回看下之前嵌套的里的getDefaultSize方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Utility to return a default size. Uses the supplied size if the</div><div class="line"> * MeasureSpec imposed no constraints. Will get larger if allowed</div><div class="line"> * by the MeasureSpec.</div><div class="line"> *</div><div class="line"> * @param size Default size for this view</div><div class="line"> * @param measureSpec Constraints imposed by the parent</div><div class="line"> * @return The size this view should be.</div><div class="line"> */</div><div class="line">public static int getDefaultSize(int size, int measureSpec) &#123;</div><div class="line">    int result = size;</div><div class="line">    int specMode = MeasureSpec.getMode(measureSpec);</div><div class="line">    int specSize = MeasureSpec.getSize(measureSpec);</div><div class="line"></div><div class="line">    switch (specMode) &#123;</div><div class="line">    case MeasureSpec.UNSPECIFIED:</div><div class="line">        result = size;</div><div class="line">        break;</div><div class="line">    case MeasureSpec.AT_MOST:</div><div class="line">    case MeasureSpec.EXACTLY:</div><div class="line">        result = specSize;</div><div class="line">        break;</div><div class="line">    &#125;</div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从注释可知，该方法的作用是根据View布局设置的宽高和父布局传递的测量规格计算View的宽高，第二个参数是父布局的测量规格，因此子View最终大小是由自身布局大小和父布局的测量规格共同决定的。从上面的代码中可以看到，默认情况下，如果父布局指定的测量规格是MeasureSpec.AT_MOST或者MeasureSpec.EXACTLY，那么返回的测量大小是一样的，都是specSize；如果父布局指定的测量规格是MeasureSpec.UNSPECIFIED，那么返回的大小为size，即第一个参数值。specSize通过MeasureSpec.getSize获得，大小由父布局指定；size通过getSuggestedMinimumWidth方法获得：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Returns the suggested minimum width that the view should use. This</div><div class="line"> * returns the maximum of the view&apos;s minimum width</div><div class="line"> * and the background&apos;s minimum width</div><div class="line"> *  (&#123;@link android.graphics.drawable.Drawable#getMinimumWidth()&#125;).</div><div class="line"> * &lt;p&gt;</div><div class="line"> * When being used in &#123;@link #onMeasure(int, int)&#125;, the caller should still</div><div class="line"> * ensure the returned width is within the requirements of the parent.</div><div class="line"> *</div><div class="line"> * @return The suggested minimum width of the view.</div><div class="line"> */</div><div class="line">protected int getSuggestedMinimumWidth() &#123;</div><div class="line">    return (mBackground == null) ? mMinWidth : max(mMinWidth, mBackground.getMinimumWidth());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从注释可知，该方法返回View建议的最小宽高，也就是xml中设置的android:minWidth和 android:minHeight的值，建议的最小宽高是由View的Background尺寸与通过设置View的minWidth/minHeigh属性共同决定的，如果该View设置了Background，就返回minXXX与Background最小宽高中最大的那个。</p>
<h2 id="DecorView-onMeasure"><a href="#DecorView-onMeasure" class="headerlink" title="DecorView onMeasure"></a>DecorView onMeasure</h2><p>DecorView 、FrameLayout以及View中都有onMeasure方法，在View的measure方法中执行onMeasure时，会先执行DecorView 中onMeasure方法，具体如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div></pre></td><td class="code"><pre><div class="line">源码路径：/SDK/sources/android-24/com/android/internal/policy/DecorView.java</div><div class="line">    @Override</div><div class="line">    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</div><div class="line">        final DisplayMetrics metrics = getContext().getResources().getDisplayMetrics();</div><div class="line">        //是否竖屏</div><div class="line">        final boolean isPortrait =</div><div class="line">                getResources().getConfiguration().orientation == ORIENTATION_PORTRAIT;</div><div class="line">        //获取宽高Mode,这里获取的widthMode和heightMode都是MeasureSpec.EXACTLY</div><div class="line">        final int widthMode = getMode(widthMeasureSpec);</div><div class="line">        final int heightMode = getMode(heightMeasureSpec);</div><div class="line"></div><div class="line">        boolean fixedWidth = false;</div><div class="line">        mApplyFloatingHorizontalInsets = false;</div><div class="line">        //widthMode是MeasureSpec.EXACTLY所以不走这</div><div class="line">        if (widthMode == AT_MOST) &#123;</div><div class="line">            final TypedValue tvw = isPortrait ? mWindow.mFixedWidthMinor : mWindow.mFixedWidthMajor;</div><div class="line">            if (tvw != null &amp;&amp; tvw.type != TypedValue.TYPE_NULL) &#123;</div><div class="line">                final int w;</div><div class="line">                if (tvw.type == TypedValue.TYPE_DIMENSION) &#123;</div><div class="line">                    w = (int) tvw.getDimension(metrics);</div><div class="line">                &#125; else if (tvw.type == TypedValue.TYPE_FRACTION) &#123;</div><div class="line">                    w = (int) tvw.getFraction(metrics.widthPixels, metrics.widthPixels);</div><div class="line">                &#125; else &#123;</div><div class="line">                    w = 0;</div><div class="line">                &#125;</div><div class="line">                if (DEBUG_MEASURE) Log.d(mLogTag, &quot;Fixed width: &quot; + w);</div><div class="line">                final int widthSize = MeasureSpec.getSize(widthMeasureSpec);</div><div class="line">                if (w &gt; 0) &#123;</div><div class="line">                    widthMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                            Math.min(w, widthSize), EXACTLY);</div><div class="line">                    fixedWidth = true;</div><div class="line">                &#125; else &#123;</div><div class="line">                    widthMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                            widthSize - mFloatingInsets.left - mFloatingInsets.right,</div><div class="line">                            AT_MOST);</div><div class="line">                    mApplyFloatingHorizontalInsets = true;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mApplyFloatingVerticalInsets = false;</div><div class="line">        //heightMode是MeasureSpec.EXACTLY所以不走这</div><div class="line">        if (heightMode == AT_MOST) &#123;</div><div class="line">            final TypedValue tvh = isPortrait ? mWindow.mFixedHeightMajor</div><div class="line">                    : mWindow.mFixedHeightMinor;</div><div class="line">            if (tvh != null &amp;&amp; tvh.type != TypedValue.TYPE_NULL) &#123;</div><div class="line">                final int h;</div><div class="line">                if (tvh.type == TypedValue.TYPE_DIMENSION) &#123;</div><div class="line">                    h = (int) tvh.getDimension(metrics);</div><div class="line">                &#125; else if (tvh.type == TypedValue.TYPE_FRACTION) &#123;</div><div class="line">                    h = (int) tvh.getFraction(metrics.heightPixels, metrics.heightPixels);</div><div class="line">                &#125; else &#123;</div><div class="line">                    h = 0;</div><div class="line">                &#125;</div><div class="line">                if (DEBUG_MEASURE) Log.d(mLogTag, &quot;Fixed height: &quot; + h);</div><div class="line">                final int heightSize = MeasureSpec.getSize(heightMeasureSpec);</div><div class="line">                if (h &gt; 0) &#123;</div><div class="line">                    heightMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                            Math.min(h, heightSize), EXACTLY);</div><div class="line">                &#125; else if ((mWindow.getAttributes().flags &amp; FLAG_LAYOUT_IN_SCREEN) == 0) &#123;</div><div class="line">                    heightMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                            heightSize - mFloatingInsets.top - mFloatingInsets.bottom, AT_MOST);</div><div class="line">                    mApplyFloatingVerticalInsets = true;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        //获取开端</div><div class="line">        getOutsets(mOutsets);</div><div class="line">        if (mOutsets.top &gt; 0 || mOutsets.bottom &gt; 0) &#123;</div><div class="line">            int mode = MeasureSpec.getMode(heightMeasureSpec);</div><div class="line">            if (mode != MeasureSpec.UNSPECIFIED) &#123;</div><div class="line">                int height = MeasureSpec.getSize(heightMeasureSpec);</div><div class="line">                //重新计算高度测量规格</div><div class="line">                heightMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                        height + mOutsets.top + mOutsets.bottom, mode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (mOutsets.left &gt; 0 || mOutsets.right &gt; 0) &#123;</div><div class="line">            int mode = MeasureSpec.getMode(widthMeasureSpec);</div><div class="line">            if (mode != MeasureSpec.UNSPECIFIED) &#123;</div><div class="line">                int width = MeasureSpec.getSize(widthMeasureSpec);</div><div class="line">                //重新计算宽度测量规格</div><div class="line">                widthMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                        width + mOutsets.left + mOutsets.right, mode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        //调用父类的onMeasure方法，也就是FrameLayout的onMeasure</div><div class="line">        super.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line"></div><div class="line">        int width = getMeasuredWidth();</div><div class="line">        boolean measure = false;</div><div class="line"></div><div class="line">        widthMeasureSpec = MeasureSpec.makeMeasureSpec(width, EXACTLY);</div><div class="line">        //widthMode是MeasureSpec.EXACTLY所以不走这</div><div class="line">        if (!fixedWidth &amp;&amp; widthMode == AT_MOST) &#123;</div><div class="line">            final TypedValue tv = isPortrait ? mWindow.mMinWidthMinor : mWindow.mMinWidthMajor;</div><div class="line">            if (tv.type != TypedValue.TYPE_NULL) &#123;</div><div class="line">                final int min;</div><div class="line">                if (tv.type == TypedValue.TYPE_DIMENSION) &#123;</div><div class="line">                    min = (int)tv.getDimension(metrics);</div><div class="line">                &#125; else if (tv.type == TypedValue.TYPE_FRACTION) &#123;</div><div class="line">                    min = (int)tv.getFraction(mAvailableWidth, mAvailableWidth);</div><div class="line">                &#125; else &#123;</div><div class="line">                    min = 0;</div><div class="line">                &#125;</div><div class="line">                if (DEBUG_MEASURE) Log.d(mLogTag, &quot;Adjust for min width: &quot; + min + &quot;, value::&quot;</div><div class="line">                        + tv.coerceToString() + &quot;, mAvailableWidth=&quot; + mAvailableWidth);</div><div class="line"></div><div class="line">                if (width &lt; min) &#123;</div><div class="line">                    widthMeasureSpec = MeasureSpec.makeMeasureSpec(min, EXACTLY);</div><div class="line">                    measure = true;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // TODO: Support height?</div><div class="line">        //measure为false所以不走这</div><div class="line">        if (measure) &#123;</div><div class="line">            super.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看到，由于DecorView的LayoutParams为MATCH_PARENT，所以在getRootMeasureSpec里返回的测量规格是MeasureSpec.EXACTLY，所以这里的onMeasure并没有满足AT_MOST判断逻辑，看一下68行getOutsets方法，其实现是在View.java中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">     * Returns the outsets, which areas of the device that aren&apos;t a surface, but we would like to</div><div class="line">     * treat them as such.</div><div class="line">     * @hide</div><div class="line">     */</div><div class="line">    public void getOutsets(Rect outOutsetRect) &#123;</div><div class="line">        if (mAttachInfo != null) &#123;</div><div class="line">            outOutsetRect.set(mAttachInfo.mOutsets);</div><div class="line">        &#125; else &#123;</div><div class="line">            outOutsetRect.setEmpty();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">源码路径:SDK/sources/android-24/android/graphics/Rect.java</div><div class="line">    /**</div><div class="line">     * Set the rectangle to (0,0,0,0)</div><div class="line">     */</div><div class="line">    public void setEmpty() &#123;</div><div class="line">        left = right = top = bottom = 0;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>因此DecorView的onMeasure中判断如果left 、right 、top、bottom、大于0时，则加上这些值重新计算宽高测量规格，调用父类的onMeasure方法，查看FrameLayout的onMeasure</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</div><div class="line">    //获取子View个数</div><div class="line">    int count = getChildCount();</div><div class="line">    //widthMeasureSpec和heightMeasureSpec都是MeasureSpec.EXACTLY，所以这里为false</div><div class="line">    final boolean measureMatchParentChildren =</div><div class="line">            MeasureSpec.getMode(widthMeasureSpec) != MeasureSpec.EXACTLY ||</div><div class="line">            MeasureSpec.getMode(heightMeasureSpec) != MeasureSpec.EXACTLY;</div><div class="line">    mMatchParentChildren.clear();</div><div class="line"></div><div class="line">    int maxHeight = 0;</div><div class="line">    int maxWidth = 0;</div><div class="line">    int childState = 0;</div><div class="line"></div><div class="line">    for (int i = 0; i &lt; count; i++) &#123;</div><div class="line">        final View child = getChildAt(i);</div><div class="line">        //遍历子View,只要Visibility不为GONE都会参与测量</div><div class="line">        if (mMeasureAllChildren || child.getVisibility() != GONE) &#123;</div><div class="line">            //测量子View的宽高</div><div class="line">            measureChildWithMargins(child, widthMeasureSpec, 0, heightMeasureSpec, 0);</div><div class="line">            //获取子View的布局参数</div><div class="line">            final LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">            //计算子View的宽度，包括自身宽度加上leftMargin和rightMargin</div><div class="line">            maxWidth = Math.max(maxWidth,</div><div class="line">                    child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin);</div><div class="line">            //计算子View的高度，包括自身高度加上topMargin和bottomMargin</div><div class="line">            maxHeight = Math.max(maxHeight,</div><div class="line">                    child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin);</div><div class="line">            //保存测量状态</div><div class="line">            childState = combineMeasuredStates(childState, child.getMeasuredState());</div><div class="line">            //measureMatchParentChildren这里为false</div><div class="line">            if (measureMatchParentChildren) &#123;</div><div class="line">                if (lp.width == LayoutParams.MATCH_PARENT ||</div><div class="line">                        lp.height == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">                    //保存那些布局参数声明为MATCH_PARENT的子View</div><div class="line">                    mMatchParentChildren.add(child);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Account for padding too</div><div class="line">    //如果有设置paddingLeft和paddingRight,则宽度值把这两个都算上</div><div class="line">    maxWidth += getPaddingLeftWithForeground() + getPaddingRightWithForeground();</div><div class="line">    //如果有设置paddingTop和paddingBottom,则高度值把这两个都算上</div><div class="line">    maxHeight += getPaddingTopWithForeground() + getPaddingBottomWithForeground();</div><div class="line"></div><div class="line">    // Check against our minimum height and width</div><div class="line">    //和建议的宽高值中取最大</div><div class="line">    maxHeight = Math.max(maxHeight, getSuggestedMinimumHeight());</div><div class="line">    maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());</div><div class="line"></div><div class="line">    // Check against our foreground&apos;s minimum height and width</div><div class="line">    //如果设置了Foreground,取最大值</div><div class="line">    final Drawable drawable = getForeground();</div><div class="line">    if (drawable != null) &#123;</div><div class="line">        maxHeight = Math.max(maxHeight, drawable.getMinimumHeight());</div><div class="line">        maxWidth = Math.max(maxWidth, drawable.getMinimumWidth());</div><div class="line">    &#125;</div><div class="line">    //所有的子View都测量完后，根据其中最大子View的宽高设置自己的宽高</div><div class="line">    setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),</div><div class="line">            resolveSizeAndState(maxHeight, heightMeasureSpec,</div><div class="line">                    childState &lt;&lt; MEASURED_HEIGHT_STATE_SHIFT));</div><div class="line"></div><div class="line">    count = mMatchParentChildren.size();</div><div class="line">    //这块在DecorView流程中不走因为count=0</div><div class="line">    if (count &gt; 1) &#123;</div><div class="line">        for (int i = 0; i &lt; count; i++) &#123;</div><div class="line">            final View child = mMatchParentChildren.get(i);</div><div class="line">            final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">            final int childWidthMeasureSpec;</div><div class="line">            if (lp.width == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">                final int width = Math.max(0, getMeasuredWidth()</div><div class="line">                        - getPaddingLeftWithForeground() - getPaddingRightWithForeground()</div><div class="line">                        - lp.leftMargin - lp.rightMargin);</div><div class="line">                childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                        width, MeasureSpec.EXACTLY);</div><div class="line">            &#125; else &#123;</div><div class="line">                childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec,</div><div class="line">                        getPaddingLeftWithForeground() + getPaddingRightWithForeground() +</div><div class="line">                        lp.leftMargin + lp.rightMargin,</div><div class="line">                        lp.width);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            final int childHeightMeasureSpec;</div><div class="line">            if (lp.height == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">                final int height = Math.max(0, getMeasuredHeight()</div><div class="line">                        - getPaddingTopWithForeground() - getPaddingBottomWithForeground()</div><div class="line">                        - lp.topMargin - lp.bottomMargin);</div><div class="line">                childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                        height, MeasureSpec.EXACTLY);</div><div class="line">            &#125; else &#123;</div><div class="line">                childHeightMeasureSpec = getChildMeasureSpec(heightMeasureSpec,</div><div class="line">                        getPaddingTopWithForeground() + getPaddingBottomWithForeground() +</div><div class="line">                        lp.topMargin + lp.bottomMargin,</div><div class="line">                        lp.height);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法主要做了这几件事</p>
<ul>
<li>遍历子View，传入自身的测量规格，调用measureChildWithMargins测量除了Visibility属性设为GONE的子View的宽高</li>
<li>获取子View中最大的那个宽高，计算宽高值包括是否设置margin、padding、foreground，以及和建议的最小宽高比较</li>
<li>调用setMeasuredDimension方法，将最大的子View的宽高值作为自己的宽高值<br>看下这里的measureChildWithMargins方法：<code>/** * Ask one of the children of this view to measure itself, taking into * account both the MeasureSpec requirements for this view and its padding * and margins. The child must have MarginLayoutParams The heavy lifting is * done in getChildMeasureSpec. * * @param child The child to measure * @param parentWidthMeasureSpec The width requirements for this view * @param widthUsed Extra space that has been used up by the parent *        horizontally (possibly by other children of the parent) * @param parentHeightMeasureSpec The height requirements for this view * @param heightUsed Extra space that has been used up by the parent *        vertically (possibly by other children of the parent) */protected void measureChildWithMargins(View child,        int parentWidthMeasureSpec, int widthUsed,        int parentHeightMeasureSpec, int heightUsed) {    //获取子View的LayoutParams    final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();    //结合父布局的测量规格和padding，子View的margin和父布局已使用宽度大小widthUsed(前面设置为0)，以及子View自身宽度来获取子View宽度测量规格    final int childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,            mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin                    + widthUsed, lp.width);    //结合父布局的测量规格和padding，子View的margin和父布局已使用高度大小heightUsed(前面设置为0)，以及子View自身高度来获取子View高度测量规格    final int childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,            mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin                    + heightUsed, lp.height);    //调用子View的measure方法，如果子View是ViewGroup则递归往下测量    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);}</code></li>
</ul>
<p>该方法对父视图提供的measureSpec参数结合子View的LayoutParams参数，计算出子View的测量规格，再将测量规格传递给子View，最后由子View的measure方法完成测量，看下getChildMeasureSpec方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Does the hard part of measureChildren: figuring out the MeasureSpec to</div><div class="line"> * pass to a particular child. This method figures out the right MeasureSpec</div><div class="line"> * for one dimension (height or width) of one child view.</div><div class="line"> *</div><div class="line"> * The goal is to combine information from our MeasureSpec with the</div><div class="line"> * LayoutParams of the child to get the best possible results. For example,</div><div class="line"> * if the this view knows its size (because its MeasureSpec has a mode of</div><div class="line"> * EXACTLY), and the child has indicated in its LayoutParams that it wants</div><div class="line"> * to be the same size as the parent, the parent should ask the child to</div><div class="line"> * layout given an exact size.</div><div class="line"> *</div><div class="line"> * @param spec The requirements for this view</div><div class="line"> * @param padding The padding of this view for the current dimension and</div><div class="line"> *        margins, if applicable</div><div class="line"> * @param childDimension How big the child wants to be in the current</div><div class="line"> *        dimension</div><div class="line"> * @return a MeasureSpec integer for the child</div><div class="line"> */</div><div class="line">public static int getChildMeasureSpec(int spec, int padding, int childDimension) &#123;</div><div class="line">    //获取父布局测量规格</div><div class="line">    int specMode = MeasureSpec.getMode(spec);</div><div class="line">     //获取父布局大小</div><div class="line">    int specSize = MeasureSpec.getSize(spec);</div><div class="line">    //父布局的大小-父布局的Padding-子布局的Margin，得到值才是子布局的大小。</div><div class="line">    int size = Math.max(0, specSize - padding);</div><div class="line">    //初始化子布局Mode和Size，最后根据这两个值生成子布局的测量规格</div><div class="line">    int resultSize = 0;</div><div class="line">    int resultMode = 0;</div><div class="line"></div><div class="line">    switch (specMode) &#123;</div><div class="line">    // Parent has imposed an exact size on us</div><div class="line">    case MeasureSpec.EXACTLY:</div><div class="line">        if (childDimension &gt;= 0) &#123;</div><div class="line">            resultSize = childDimension;</div><div class="line">            resultMode = MeasureSpec.EXACTLY;</div><div class="line">        &#125; else if (childDimension == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">            // Child wants to be our size. So be it.</div><div class="line">            resultSize = size;</div><div class="line">            resultMode = MeasureSpec.EXACTLY;</div><div class="line">        &#125; else if (childDimension == LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">            // Child wants to determine its own size. It can&apos;t be</div><div class="line">            // bigger than us.</div><div class="line">            resultSize = size;</div><div class="line">            resultMode = MeasureSpec.AT_MOST;</div><div class="line">        &#125;</div><div class="line">        break;</div><div class="line"></div><div class="line">    // Parent has imposed a maximum size on us</div><div class="line">    case MeasureSpec.AT_MOST:</div><div class="line">        if (childDimension &gt;= 0) &#123;</div><div class="line">            // Child wants a specific size... so be it</div><div class="line">            resultSize = childDimension;</div><div class="line">            resultMode = MeasureSpec.EXACTLY;</div><div class="line">        &#125; else if (childDimension == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">            // Child wants to be our size, but our size is not fixed.</div><div class="line">            // Constrain child to not be bigger than us.</div><div class="line">            resultSize = size;</div><div class="line">            resultMode = MeasureSpec.AT_MOST;</div><div class="line">        &#125; else if (childDimension == LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">            // Child wants to determine its own size. It can&apos;t be</div><div class="line">            // bigger than us.</div><div class="line">            resultSize = size;</div><div class="line">            resultMode = MeasureSpec.AT_MOST;</div><div class="line">        &#125;</div><div class="line">        break;</div><div class="line"></div><div class="line">    // Parent asked to see how big we want to be</div><div class="line">    case MeasureSpec.UNSPECIFIED:</div><div class="line">        if (childDimension &gt;= 0) &#123;</div><div class="line">            // Child wants a specific size... let him have it</div><div class="line">            resultSize = childDimension;</div><div class="line">            resultMode = MeasureSpec.EXACTLY;</div><div class="line">        &#125; else if (childDimension == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">            // Child wants to be our size... find out how big it should</div><div class="line">            // be</div><div class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size;</div><div class="line">            resultMode = MeasureSpec.UNSPECIFIED;</div><div class="line">        &#125; else if (childDimension == LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">            // Child wants to determine its own size.... find out how</div><div class="line">            // big it should be</div><div class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size;</div><div class="line">            resultMode = MeasureSpec.UNSPECIFIED;</div><div class="line">        &#125;</div><div class="line">        break;</div><div class="line">    &#125;</div><div class="line">    //noinspection ResourceType  </div><div class="line">    //生成子布局的测量规格</div><div class="line">    return MeasureSpec.makeMeasureSpec(resultSize, resultMode);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由前面分析DecorView的specMode为MeasureSpec.EXACTLY，因此走第一个分支，这里分三种情况：</p>
<ul>
<li>如果子布局的width或height是一个精确的值，则测量大小就是这个精确值，测量模式为EXACTLY；</li>
<li>如果子布局的width或height是MATCH_PARENT，则测量大小是父布局-父布局的Padding-子布局的Margin，测量模式为EXACTLY</li>
<li>如果子布局的width或height是WRAP_CONTENT，则测量大小是父布局-父布局的Padding-子布局的Margin，测量模式为AT_MOST<br>最后再根据这里的测量大小和测量模式生成子布局的测量规格并返回，子布局根据计算得来的测量规格调用measure方法进行测量，如果子布局是ViewGroup，则递归往下测量，measureChildWithMargins方法执行完后，回到FrameLayout的onMeasure，在61行调用setMeasuredDimension方法，根据布局中最大的子View设置自己的宽高，测量完成。</li>
</ul>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>MainActivity.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends Activity &#123;</div><div class="line">    private InitView initView;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        initView = (InitView) findViewById(R.id.initView);</div><div class="line">        Log.d(&quot;hcy&quot;, &quot;onCreate: width is &quot; + initView.getWidth());</div><div class="line">        Log.d(&quot;hcy&quot;, &quot;onCreate: measuredWidth is &quot; + initView.getMeasuredWidth());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void onResume() &#123;</div><div class="line">        super.onResume();</div><div class="line">        Log.d(&quot;hcy&quot;, &quot;onResume: width is &quot; + initView.getWidth());</div><div class="line">        Log.d(&quot;hcy&quot;, &quot;onResume: measuredWidth is &quot; + initView.getMeasuredWidth());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>自定义View</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">public class InitView extends View &#123;</div><div class="line">    private Paint mPaint;</div><div class="line"></div><div class="line">    public InitView(Context context)&#123;</div><div class="line">        this(context, null);</div><div class="line">    &#125;</div><div class="line">    public InitView(Context context, AttributeSet attrs) &#123;</div><div class="line">        this(context, attrs, 0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public InitView(Context context, AttributeSet attrs, int defStyleAttr) &#123;</div><div class="line">        super(context, attrs, defStyleAttr);</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void init() &#123;</div><div class="line">        mPaint = new Paint();</div><div class="line">        mPaint.setColor(Color.BLACK);</div><div class="line">        mPaint.setAntiAlias(true);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</div><div class="line">        int specMode = MeasureSpec.getMode(widthMeasureSpec);</div><div class="line">        switch (specMode) &#123;</div><div class="line">            case MeasureSpec.UNSPECIFIED:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;onMeasure: UNSPECIFIED&quot;);</div><div class="line">                break;</div><div class="line">            case MeasureSpec.EXACTLY:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;onMeasure: EXACTLY&quot;);</div><div class="line">                break;</div><div class="line">            case MeasureSpec.AT_MOST:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;onMeasure: AT_MOST&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        super.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void onDraw(Canvas canvas) &#123;</div><div class="line">        super.onDraw(canvas);</div><div class="line">        canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, getWidth() / 2f, mPaint);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>activity_main.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;com.hu.hcy.initview.InitView</div><div class="line">    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:id=&quot;@+id/initView&quot;</div><div class="line">    android:layout_width=&quot;wrap_content&quot;</div><div class="line">    android:layout_height=&quot;wrap_content&quot;/&gt;</div></pre></td></tr></table></figure>
<ul>
<li><p>设置该View的布局参数为wrap_content，运行效果：</p>
<p>   <img src="http://7xjvg5.com1.z0.glb.clouddn.com/initView1.png" style="zoom:25%"></p>
</li>
</ul>
<p>打印log如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">05-24 10:45:27.359  7026  7026 D hcy     : onCreate: width is 0</div><div class="line">05-24 10:45:27.359  7026  7026 D hcy     : onCreate: measuredWidth is 0</div><div class="line">05-24 10:45:27.362  7026  7026 D hcy     : onResume: width is 0</div><div class="line">05-24 10:45:27.362  7026  7026 D hcy     : onResume: measuredWidth is 0</div><div class="line">05-24 10:45:27.399  7026  7026 D hcy     : onMeasure: AT_MOST</div></pre></td></tr></table></figure>
<ul>
<li><p>设置该View的布局参数为match_parent，运行效果：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/initView1.png" style="zoom:25%"></p>
<p>打印log如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">05-24 10:57:10.084  8526  8526 D hcy     : onCreate: width is 0</div><div class="line">05-24 10:57:10.084  8526  8526 D hcy     : onCreate: measuredWidth is 0</div><div class="line">05-24 10:57:10.101  8526  8526 D hcy     : onResume: width is 0</div><div class="line">05-24 10:57:10.101  8526  8526 D hcy     : onResume: measuredWidth is 0</div><div class="line">05-24 10:57:10.203  8526  8526 D hcy     : onMeasure: EXACTLY</div></pre></td></tr></table></figure>
</li>
<li><p>设置View的布局参数为精确值(layout_width=”100dp”，layout_height=”100dp”)，运行效果：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/initView2.png" style="zoom:25%"></p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">05-24 11:06:34.124 10903 10903 D hcy     : onCreate: width is 0</div><div class="line">05-24 11:06:34.124 10903 10903 D hcy     : onCreate: measuredWidth is 0</div><div class="line">05-24 11:06:34.126 10903 10903 D hcy     : onResume: width is 0</div><div class="line">05-24 11:06:34.126 10903 10903 D hcy     : onResume: measuredWidth is 0</div><div class="line">05-24 11:06:34.187 10903 10903 D hcy     : onMeasure: EXACTLY</div></pre></td></tr></table></figure>
<p>现象：</p>
<ul>
<li>指定View的布局参数为wrap_content，显示却充满整个屏幕，是因为Activity的父布局是id为content的FrameLayout，具体原因在上面getChildMeasureSpec方法中已经分析</li>
<li>在onCreate和onResume方法中无法获取到View的宽高，因为此时View的测量还没开始。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><a href="http://7xjvg5.com1.z0.glb.clouddn.com/ViewMeasure.png" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewMeasure.png" alt="img"></a></p>
<ul>
<li>View的measure方法由final修饰，子类无法重写，可以通过重写onMeasure方法来完成测量，重写onMeasure后必须调用setMeasuredDimension，当然也可以不重写，Android提供了一个默认测量视图View大小的实现getDefaultSize。</li>
<li>从流程图来看，measure过程是从顶层父布局向子布局递归调用view.measure方法，实际的测量工作是由onMeasure方法完成，在测量中起关键作用的是测量规格MeasureSpec，最顶层的DecorView的测量规格是通过ViewRootImpl的getRootMeasureSpec方法获得，LayoutParams的宽高均为MATCH_PARENT，specMode为EXACTLY，specSize为屏幕大小，子布局的测量规格由父布局的测量规格和自身的LayoutParams决定，待子布局确定好大小后，父布局再确定自身的大小</li>
<li>因为ActivityThread的performResumeActivity开始之后才会陆续调用到performTraversals()方法开始测量，所以在Activity的onCreate和onResume方法中调用View.getWidth()和View.getMeasuredHeight()返回值为0， 测量还未开始。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/24/Screen Overlay Detected介绍与解决/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/24/Screen Overlay Detected介绍与解决/" itemprop="url">Screen Overlay Detected介绍与解决</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-24T00:00:00+08:00">
                2017-05-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/24/Screen Overlay Detected介绍与解决/" class="leancloud_visitors" data-flag-title="Screen Overlay Detected介绍与解决">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>前阵子测试报了一个bug，说是在测试机上安装微信后显示Screen Overlay Detected提示框，然后不知道怎么操作。</p>
<h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p><a href="http://upload-images.jianshu.io/upload_images/989851-8bf178c26e59783f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-8bf178c26e59783f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt="ScreenOverlayDetected.png"></a></p>
<p>如图所示，在第一次安装并打开微信的时候弹出Screen Overlay Detected提示</p>
<h2 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h2><p>在Android M以上引入了一个新功能，叫”Draw over other apps”，该功能允许一些apps覆盖在其他应用上，这就意味着这些apps可以在其他apps的顶部显示一些信息，例如Facebook Messenger使用该功能使它们的聊天覆盖在其他应用上。然而，当具备该功能的应用在前台或后台运行的时候，如果你安装新的应用，此时你的手机会提示”Screen Overlay Detected”，根据提示，你需要前往Settings–&gt;Apps中关闭screen overlay才能正常使用应用。</p>
<p>那么Screen Overlay Detected是什么呢，它有什么用？实际上它是Android一个额外的安全措施，用来防止一些流氓应用利用Android的默认设置，这些流氓应用可能是用户无意间安装的(不是通过play store)，当overlay功能运行的时候，这些流氓应用会做一些你不希望发生的事情，并请求权限，这些是Android所不允许的，所以会弹出”Screen Overlay Detected”的错误提示。也就是说出现这个提示属于正常现象，是Android在M以上的一个安全措施。那么如何解决这个问题呢？</p>
<h2 id="怎么解决"><a href="#怎么解决" class="headerlink" title="怎么解决"></a>怎么解决</h2><p>方法1：<br>首先进入Settings–&gt;Apps，点击右上角设置图标<br><a href="http://upload-images.jianshu.io/upload_images/989851-5a5076d0d6d18064.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-5a5076d0d6d18064.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt="ScreenOverlayDetected2.jpg"></a></p>
<p>点击”Draw over other apps”<br><a href="http://upload-images.jianshu.io/upload_images/989851-2495f8355f1fb2d6.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-2495f8355f1fb2d6.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt="ScreenOverlayDetected4.jpg"></a></p>
<p>可以看到一些允许覆盖在其他apps上<br><a href="http://upload-images.jianshu.io/upload_images/989851-60d9bad172b04a68.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-60d9bad172b04a68.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt="ScreenOverlayDetected5.png"></a></p>
<p>把当前界面中所有apps的”permit drawing over other apps”选项关闭<br><a href="http://upload-images.jianshu.io/upload_images/989851-8a58945b2f0d217a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-8a58945b2f0d217a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt="ScreenOverlayDetected3.jpg"></a><br>在Settings中清除下你要运行的app的数据，再次打开，不出意外的话可以正常运行该app；</p>
<p>方法2：什么，方法1没卵用？！！进入Settings–&gt;Apps，点击你要运行的apps，点击Permissions，</p>
<p><a href="http://upload-images.jianshu.io/upload_images/989851-32ae3a4307790e54.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-32ae3a4307790e54.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt="ScreenOverlayDetected6.jpg"></a></p>
<p>将所有的权限都勾选上，然后重新运行该应用</p>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><p>试了方法1之后发现微信仍然不能打开，接着试方案2，没想到刚刚勾选第一项就吃了闭门羹，还是提示”Screen Overlay Detected”，注意到这里截图的360悬浮窗，原来测试在360的悬浮窗设置中关闭了”仅在桌面显示”，因此这里的360悬浮窗可以覆盖在任何apps的上面，所以当新安装一些apps时，会弹出”Screen Overlay Detected”提示，这里把360悬浮窗关了，在Settings中赋予微信权限，然后微信就能正常运行了。感谢万能的Google，<a href="http://www.gadgetraid.com/2016/10/screen-overlay-detected/" target="_blank" rel="external">链接</a>中对于三星、一加、LG、摩托罗拉、HTC手机出现该提示具体怎么解决给了分析。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/20/Android DecorView绘制源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/20/Android DecorView绘制源码分析/" itemprop="url">Android DecorView绘制源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-20T00:00:00+08:00">
                2017-05-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/20/Android DecorView绘制源码分析/" class="leancloud_visitors" data-flag-title="Android DecorView绘制源码分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>通过前面的分析，在Activity中执行setContentView方法后会执行PhoneWindow的setContentView，在该方法中会生成DecorView 组件作为应用窗口的顶层视图，DecorView 是PhoneWindow的内部类，继承至FrameLayout，DecorView 会添加一个id为content的FrameLayout作为根布局，Activity的xml文件通过LayoutInflater的inflate方法解析成View树添加到id为content的FrameLayout中，那么这里的DecorView是怎么被添加到窗口并显示出来的呢？</p>
<h2 id="ActivityThread-handleResumeActivity"><a href="#ActivityThread-handleResumeActivity" class="headerlink" title="ActivityThread handleResumeActivity()"></a>ActivityThread handleResumeActivity()</h2><p>Activity的启动流程学习作为将来的TODO项目，在ActivityThread中，当activity对象被创建完毕后，会调用handleResumeActivity方法将顶层视图DecorView添加到PhoneWindow窗口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div></pre></td><td class="code"><pre><div class="line">源码路径：SDK/sources/android-24/android/app/ActivityThread.java</div><div class="line">    final void handleResumeActivity(IBinder token,</div><div class="line">            boolean clearHide, boolean isForward, boolean reallyResume, int seq, String reason) &#123;</div><div class="line">        //ActivityClientRecord对象保存了Activity的信息</div><div class="line">        ActivityClientRecord r = mActivities.get(token);</div><div class="line">        if (!checkAndUpdateLifecycleSeq(seq, r, &quot;resumeActivity&quot;)) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // If we are getting ready to gc after going to the background, well</div><div class="line">        // we are back active so skip it.</div><div class="line">        unscheduleGcIdler();</div><div class="line">        mSomeActivitiesChanged = true;</div><div class="line"></div><div class="line">        // TODO Push resumeArgs into the activity for consideration</div><div class="line">        r = performResumeActivity(token, clearHide, reason);</div><div class="line"></div><div class="line">        if (r != null) &#123;</div><div class="line">            //获取Activity对象</div><div class="line">            final Activity a = r.activity;</div><div class="line"></div><div class="line">            final int forwardBit = isForward ?</div><div class="line">                    WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION : 0;</div><div class="line"></div><div class="line">            // If the window hasn&apos;t yet been added to the window manager,</div><div class="line">            // and this guy didn&apos;t finish itself or start another activity,</div><div class="line">            // then go ahead and add the window.</div><div class="line">            boolean willBeVisible = !a.mStartedActivity;</div><div class="line">            if (!willBeVisible) &#123;</div><div class="line">                try &#123;</div><div class="line">                    willBeVisible = ActivityManagerNative.getDefault().willActivityBeVisible(</div><div class="line">                            a.getActivityToken());</div><div class="line">                &#125; catch (RemoteException e) &#123;</div><div class="line">                    throw e.rethrowFromSystemServer();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            if (r.window == null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</div><div class="line">                //获取Activity对应的PhoneWindow对象</div><div class="line">                r.window = r.activity.getWindow();</div><div class="line">                //获取顶层布局DecorView对象</div><div class="line">                View decor = r.window.getDecorView();</div><div class="line">                //设为不可见</div><div class="line">                decor.setVisibility(View.INVISIBLE);</div><div class="line">                //获取WindowManager</div><div class="line">                ViewManager wm = a.getWindowManager();</div><div class="line">                //获取PhoneWindow的LayoutParams</div><div class="line">                WindowManager.LayoutParams l = r.window.getAttributes();</div><div class="line">                a.mDecor = decor;</div><div class="line">                l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</div><div class="line">                l.softInputMode |= forwardBit;</div><div class="line">                if (r.mPreserveWindow) &#123;</div><div class="line">                    a.mWindowAdded = true;</div><div class="line">                    r.mPreserveWindow = false;</div><div class="line">                    // Normally the ViewRoot sets up callbacks with the Activity</div><div class="line">                    // in addView-&gt;ViewRootImpl#setView. If we are instead reusing</div><div class="line">                    // the decor view we have to notify the view root that the</div><div class="line">                    // callbacks may have changed.</div><div class="line">                    ViewRootImpl impl = decor.getViewRootImpl();</div><div class="line">                    if (impl != null) &#123;</div><div class="line">                        impl.notifyChildRebuilt();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                if (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) &#123;</div><div class="line">                    //DecorView已经添加到窗口</div><div class="line">                    a.mWindowAdded = true;</div><div class="line">                    //将顶层布局DecorView添加到窗口中</div><div class="line">                    wm.addView(decor, l);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            // If the window has already been added, but during resume</div><div class="line">            // we started another activity, then don&apos;t yet make the</div><div class="line">            // window visible.</div><div class="line">            &#125; else if (!willBeVisible) &#123;</div><div class="line">                r.hideForNow = true;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // Get rid of anything left hanging around.</div><div class="line">            cleanUpPendingRemoveWindows(r, false /* force */);</div><div class="line"></div><div class="line">            // The window is now visible if it has been added, we are not</div><div class="line">            // simply finishing, and we are not starting another activity.</div><div class="line">            if (!r.activity.mFinished &amp;&amp; willBeVisible</div><div class="line">                    &amp;&amp; r.activity.mDecor != null &amp;&amp; !r.hideForNow) &#123;</div><div class="line">                if (r.newConfig != null) &#123;</div><div class="line">                    performConfigurationChangedForActivity(r, r.newConfig, REPORT_TO_ACTIVITY);</div><div class="line">                    r.newConfig = null;</div><div class="line">                &#125;</div><div class="line">                WindowManager.LayoutParams l = r.window.getAttributes();</div><div class="line">                if ((l.softInputMode</div><div class="line">                        &amp; WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION)</div><div class="line">                        != forwardBit) &#123;</div><div class="line">                    l.softInputMode = (l.softInputMode</div><div class="line">                            &amp; (~WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION))</div><div class="line">                            | forwardBit;</div><div class="line">                    if (r.activity.mVisibleFromClient) &#123;</div><div class="line">                        ViewManager wm = a.getWindowManager();</div><div class="line">                        View decor = r.window.getDecorView();</div><div class="line">                        wm.updateViewLayout(decor, l);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                r.activity.mVisibleFromServer = true;</div><div class="line">                mNumVisibleActivities++;</div><div class="line">                if (r.activity.mVisibleFromClient) &#123;</div><div class="line">                    //设置顶层布局DecorView可见</div><div class="line">                    r.activity.makeVisible();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (!r.onlyLocalRequest) &#123;</div><div class="line">                r.nextIdle = mNewActivities;</div><div class="line">                mNewActivities = r;</div><div class="line">                Looper.myQueue().addIdleHandler(new Idler());</div><div class="line">            &#125;</div><div class="line">            r.onlyLocalRequest = false;</div><div class="line"></div><div class="line">            // Tell the activity manager we have resumed.</div><div class="line">            if (reallyResume) &#123;</div><div class="line">                try &#123;</div><div class="line">                    ActivityManagerNative.getDefault().activityResumed(token);</div><div class="line">                &#125; catch (RemoteException ex) &#123;</div><div class="line">                    throw ex.rethrowFromSystemServer();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125; else &#123;</div><div class="line">            // If an exception was thrown when trying to resume, then</div><div class="line">            // just end this activity.</div><div class="line">            try &#123;</div><div class="line">                ActivityManagerNative.getDefault()</div><div class="line">                    .finishActivity(token, Activity.RESULT_CANCELED, null,</div><div class="line">                            Activity.DONT_FINISH_TASK_WITH_ACTIVITY);</div><div class="line">            &#125; catch (RemoteException ex) &#123;</div><div class="line">                throw ex.rethrowFromSystemServer();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="WindowManagerImpl-addView"><a href="#WindowManagerImpl-addView" class="headerlink" title="WindowManagerImpl addView()"></a>WindowManagerImpl addView()</h2><p>通过wm的addView方法，传入顶层视图DecorView和LayoutParams，将顶层布局DecorView添加到窗口中。这里的vm是ViewManager，具体实现是WindowManagerImpl类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">关系:</div><div class="line">public interface WindowManager extends ViewManager </div><div class="line">public final class WindowManagerImpl implements WindowManager</div><div class="line"></div><div class="line">源码路径: SDK/sources/android-24/android/view/WindowManagerImpl.java</div><div class="line">    public void addView(@NonNull View view, @NonNull ViewGroup.LayoutParams params) &#123;</div><div class="line">        applyDefaultToken(params);</div><div class="line">        mGlobal.addView(view, params, mContext.getDisplay(), mParentWindow);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里直接调用了mGlobal的addView方法，继续跟进去看下</p>
<h2 id="WindowManagerGlobal-addView"><a href="#WindowManagerGlobal-addView" class="headerlink" title="WindowManagerGlobal addView()"></a>WindowManagerGlobal addView()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">源码路径: SDK/sources/android-24/android/view/WindowManagerGlobal.java</div><div class="line"></div><div class="line">    public void addView(View view, ViewGroup.LayoutParams params,</div><div class="line">            Display display, Window parentWindow) &#123;</div><div class="line"></div><div class="line">        final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;</div><div class="line">        if (parentWindow != null) &#123;</div><div class="line">            parentWindow.adjustLayoutParamsForSubWindow(wparams);</div><div class="line">        &#125; else &#123;</div><div class="line">            // If there&apos;s no parent, then hardware acceleration for this view is</div><div class="line">            // set from the application&apos;s hardware acceleration setting.</div><div class="line">            final Context context = view.getContext();</div><div class="line">            if (context != null</div><div class="line">                    &amp;&amp; (context.getApplicationInfo().flags</div><div class="line">                            &amp; ApplicationInfo.FLAG_HARDWARE_ACCELERATED) != 0) &#123;</div><div class="line">                wparams.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ViewRootImpl root;</div><div class="line">        View panelParentView = null;</div><div class="line"></div><div class="line">        synchronized (mLock) &#123;</div><div class="line">            // Start watching for system property changes.</div><div class="line">            if (mSystemPropertyUpdater == null) &#123;</div><div class="line">                mSystemPropertyUpdater = new Runnable() &#123;</div><div class="line">                    @Override public void run() &#123;</div><div class="line">                        synchronized (mLock) &#123;</div><div class="line">                            for (int i = mRoots.size() - 1; i &gt;= 0; --i) &#123;</div><div class="line">                                mRoots.get(i).loadSystemProperties();</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;;</div><div class="line">                SystemProperties.addChangeCallback(mSystemPropertyUpdater);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            int index = findViewLocked(view, false);</div><div class="line">            if (index &gt;= 0) &#123;</div><div class="line">                if (mDyingViews.contains(view)) &#123;</div><div class="line">                    // Don&apos;t wait for MSG_DIE to make it&apos;s way through root&apos;s queue.</div><div class="line">                    mRoots.get(index).doDie();</div><div class="line">                &#125; else &#123;</div><div class="line">                    throw new IllegalStateException(&quot;View &quot; + view</div><div class="line">                            + &quot; has already been added to the window manager.&quot;);</div><div class="line">                &#125;</div><div class="line">                // The previous removeView() had not completed executing. Now it has.</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // If this is a panel window, then find the window it is being</div><div class="line">            // attached to for future reference.</div><div class="line">            if (wparams.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp;</div><div class="line">                    wparams.type &lt;= WindowManager.LayoutParams.LAST_SUB_WINDOW) &#123;</div><div class="line">                final int count = mViews.size();</div><div class="line">                for (int i = 0; i &lt; count; i++) &#123;</div><div class="line">                    if (mRoots.get(i).mWindow.asBinder() == wparams.token) &#123;</div><div class="line">                        panelParentView = mViews.get(i);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            //实例化ViewRootImpl对象</div><div class="line">            root = new ViewRootImpl(view.getContext(), display);</div><div class="line">            //顶层视图DecorView设置LayoutParams</div><div class="line">            view.setLayoutParams(wparams);</div><div class="line"></div><div class="line">            mViews.add(view);</div><div class="line">            mRoots.add(root);</div><div class="line">            mParams.add(wparams);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // do this last because it fires off messages to start doing things</div><div class="line">        try &#123;</div><div class="line">            //将顶层视图DecorView添加到root中</div><div class="line">            root.setView(view, wparams, panelParentView);</div><div class="line">        &#125; catch (RuntimeException e) &#123;</div><div class="line">            // BadTokenException or InvalidDisplayException, clean up.</div><div class="line">            synchronized (mLock) &#123;</div><div class="line">                final int index = findViewLocked(view, false);</div><div class="line">                if (index &gt;= 0) &#123;</div><div class="line">                    removeViewLocked(index, true);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            throw e;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="ViewRootImpl-setView"><a href="#ViewRootImpl-setView" class="headerlink" title="ViewRootImpl setView()"></a>ViewRootImpl setView()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">源码路径: SDK/sources/android-24/android/view/ViewRootImpl.java</div><div class="line">    /**</div><div class="line">     * We have one child</div><div class="line">     */</div><div class="line">        public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) &#123;</div><div class="line">        synchronized (this) &#123;</div><div class="line">            if (mView == null) &#123;</div><div class="line">                mView = view;</div><div class="line">                ......</div><div class="line">                mAdded = true;</div><div class="line">                ......</div><div class="line">                // Schedule the first layout -before- adding to the window</div><div class="line">                // manager, to make sure we do the relayout before receiving</div><div class="line">                // any other events from the system.</div><div class="line">                requestLayout();</div><div class="line">                ......</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>该方法代码有点长，将DecorView赋给这里的View，并标记DecorView已添加到ViewRootImpl，之后调用requestLayout请求布局。</p>
<h2 id="ViewRootImpl-requestLayout"><a href="#ViewRootImpl-requestLayout" class="headerlink" title="ViewRootImpl requestLayout()"></a>ViewRootImpl requestLayout()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public void requestLayout() &#123;</div><div class="line">    if (!mHandlingLayoutInLayoutRequest) &#123;</div><div class="line">        checkThread();</div><div class="line">        mLayoutRequested = true;</div><div class="line">        scheduleTraversals();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ViewRootImpl-scheduleTraversals"><a href="#ViewRootImpl-scheduleTraversals" class="headerlink" title="ViewRootImpl scheduleTraversals()"></a>ViewRootImpl scheduleTraversals()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">void scheduleTraversals() &#123;</div><div class="line">    if (!mTraversalScheduled) &#123;</div><div class="line">        mTraversalScheduled = true;</div><div class="line">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</div><div class="line">        mChoreographer.postCallback(</div><div class="line">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null);</div><div class="line">        if (!mUnbufferedInputDispatch) &#123;</div><div class="line">            scheduleConsumeBatchedInput();</div><div class="line">        &#125;</div><div class="line">        notifyRendererOfFramePending();</div><div class="line">        pokeDrawLockIfNeeded();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在该方法中把mTraversalRunnable post到消息队列中，查看Choreographer的postCallback方法，最终会调用到postCallbackDelayedInternal，实质还是通过Handler来处理，查看下mTraversalRunnable 做了什么</p>
<h2 id="ViewRootImpl-TraversalRunnable"><a href="#ViewRootImpl-TraversalRunnable" class="headerlink" title="ViewRootImpl TraversalRunnable"></a>ViewRootImpl TraversalRunnable</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">final class TraversalRunnable implements Runnable &#123;</div><div class="line">    @Override</div><div class="line">    public void run() &#123;</div><div class="line">        doTraversal();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ViewRootImpl-doTraversal"><a href="#ViewRootImpl-doTraversal" class="headerlink" title="ViewRootImpl doTraversal()"></a>ViewRootImpl doTraversal()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">void doTraversal() &#123;</div><div class="line">    if (mTraversalScheduled) &#123;</div><div class="line">        mTraversalScheduled = false;</div><div class="line">        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</div><div class="line"></div><div class="line">        if (mProfile) &#123;</div><div class="line">            Debug.startMethodTracing(&quot;ViewAncestor&quot;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        performTraversals();</div><div class="line"></div><div class="line">        if (mProfile) &#123;</div><div class="line">            Debug.stopMethodTracing();</div><div class="line">            mProfile = false;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里会调用performTraversals()，performTraversals()负责整个View树的绘制流程，是很关键的一步，之后结合自定义View分析。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过上面的分析，在ActivityThread中，当activity对象创建完毕后，会将DecorView添加到Window中，同时会创建 ViewRootImpl 对象，并将 ViewRootImpl 对象和 DecorView 建立关联，最终由ViewRootImpl负责整个View树的绘制。</p>
<p><a href="http://7xjvg5.com1.z0.glb.clouddn.com/DecorView.png" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/DecorView.png" alt="img"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/17/Android LayoutInflater源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/17/Android LayoutInflater源码分析/" itemprop="url">Android LayoutInflater源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-17T00:00:00+08:00">
                2017-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/17/Android LayoutInflater源码分析/" class="leancloud_visitors" data-flag-title="Android LayoutInflater源码分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在初学Android的时候LayoutInflater是经常用到的一个类，例如在ListView的getView方法，LayoutInflater的作用主要是用来加载布局。上篇在介绍到Activity通过调用setContentView加载布局，通过阅读源码发现其内部还是调用LayoutInflater的inflate方法，继续阅读源码看看内部具体的实现原理。</p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>MainActivity.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends AppCompatActivity &#123;</div><div class="line">    private ListView mListView;</div><div class="line">    private MyAdapter mMyAdapter;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        mListView = (ListView) findViewById(R.id.listview);</div><div class="line">        mMyAdapter = new MyAdapter(this);</div><div class="line">        mListView.setAdapter(mMyAdapter);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MyAdapter.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">public class MyAdapter extends BaseAdapter &#123;</div><div class="line">    private LayoutInflater mLayoutInflater;</div><div class="line">    public MyAdapter(Context context)&#123;</div><div class="line">        mLayoutInflater = LayoutInflater.from(context);</div><div class="line">    &#125;</div><div class="line">    @Override</div><div class="line">    public int getCount() &#123;</div><div class="line">        return 8;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Object getItem(int position) &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public long getItemId(int position) &#123;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public View getView(int position, View convertView, ViewGroup parent) &#123;</div><div class="line">        View v0 = mLayoutInflater.inflate(R.layout.item_listview, null);</div><div class="line">        View v1 = mLayoutInflater.inflate(R.layout.item_listview, null, false);</div><div class="line">        View v2 = mLayoutInflater.inflate(R.layout.item_listview, null, true);</div><div class="line">        //View v3 = mLayoutInflater.inflate(R.layout.item_listview, parent);</div><div class="line">        View v3 = mLayoutInflater.inflate(R.layout.item_listview, parent, false);</div><div class="line">        //View v3 = mLayoutInflater.inflate(R.layout.item_listview, parent, true);</div><div class="line"></div><div class="line">        View v4 = mLayoutInflater.inflate(R.layout.item_listview_parent, null);</div><div class="line">        View v5 = mLayoutInflater.inflate(R.layout.item_listview_parent, null, false);</div><div class="line">        View v6 = mLayoutInflater.inflate(R.layout.item_listview_parent, null, true);</div><div class="line">        //View v7 = mLayoutInflater.inflate(R.layout.item_listview_parent, parent);</div><div class="line">        View v7 = mLayoutInflater.inflate(R.layout.item_listview_parent, parent, false);</div><div class="line">        //View v7 = mLayoutInflater.inflate(R.layout.item_listview_parent, parent, true);</div><div class="line">        View[] viewLists = &#123;v0, v1, v2, v3, v4, v5, v6, v7&#125;;</div><div class="line">        convertView = viewLists[position];</div><div class="line">        ViewGroup.LayoutParams layoutParams = convertView.getLayoutParams();</div><div class="line">        if (layoutParams == null) &#123;</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;position &quot; + position + &quot; layoutParams is null&quot; );</div><div class="line">        &#125; else &#123;</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;position &quot; + position + &quot; layoutParams.width is: &quot; + layoutParams.width + &quot; layoutParams.height is: &quot; + layoutParams.height);</div><div class="line">        &#125;</div><div class="line">        return convertView;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>activity_main.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;android.support.constraint.ConstraintLayout</div><div class="line">    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    tools:context=&quot;com.hcy.layoutinflaterdemo.MainActivity&quot;&gt;</div><div class="line"></div><div class="line">    &lt;ListView</div><div class="line">        android:id=&quot;@+id/listview&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot;</div><div class="line">        /&gt;</div><div class="line"></div><div class="line">&lt;/android.support.constraint.ConstraintLayout&gt;</div></pre></td></tr></table></figure>
<p>item_listview.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;TextView android:id=&quot;@+id/list_item&quot;</div><div class="line">    android:layout_width=&quot;100dp&quot;</div><div class="line">    android:layout_height=&quot;50dp&quot;</div><div class="line">    android:text=&quot;Hello World&quot;</div><div class="line">    android:background=&quot;@android:color/holo_purple&quot;</div><div class="line">    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; /&gt;</div></pre></td></tr></table></figure>
<p>item_listview_parent.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:layout_width=&quot;wrap_content&quot;</div><div class="line">    android:layout_height=&quot;wrap_content&quot;</div><div class="line">    android:background=&quot;@android:color/holo_purple&quot;&gt;</div><div class="line">    &lt;TextView</div><div class="line">        android:id=&quot;@+id/text&quot;</div><div class="line">        android:layout_height=&quot;50dp&quot;</div><div class="line">        android:layout_width=&quot;100dp&quot;</div><div class="line">        android:text=&quot;Hello World&quot;</div><div class="line">        android:background=&quot;@android:color/holo_orange_dark&quot;/&gt;</div><div class="line"></div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<p>该Demo比较简单，写这个Demo的主要目的是要搞清楚inflate方法的参数设置给布局带来的影响，这也是自己一直没记清楚的地方。</p>
<p>运行结果</p>
<p>​    <img src="http://7xjvg5.com1.z0.glb.clouddn.com/LayoutInflater2.png" style="zoom:25%"></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>显示的结果很奇怪，疑问如下：</p>
<ul>
<li>position0-2item我明明指定的width和height分别是100dp和50dp，为什么width显示成match_parent，高度也不对？而且第三个参数有没有好像不影响显示</li>
<li>position4-6item的LinearLayout的width和height分别是wrap_content，为什么宽显示成match_parent</li>
<li>在调试的时候若把MyAdapter中注释的几行打开会报错<code>Caused by: java.lang.UnsupportedOperationException: addView(View, LayoutParams) is not supported in AdapterView</code></li>
</ul>
<p>Why?</p>
<h2 id="LayoutInflater源码分析"><a href="#LayoutInflater源码分析" class="headerlink" title="LayoutInflater源码分析"></a>LayoutInflater源码分析</h2><p>首先看下获取LayoutInflater实例的地方，在MyAdapter中通过<br>LayoutInflater.from(context)获取，那这里的from方法具体又干了什么?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">源码路径：sdk/sources/android-25/android/view/LayoutInflater.java</div><div class="line">    /**</div><div class="line">     * Obtains the LayoutInflater from the given context.</div><div class="line">     */</div><div class="line">    public static LayoutInflater from(Context context) &#123;</div><div class="line">        LayoutInflater LayoutInflater =</div><div class="line">                (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</div><div class="line">        if (LayoutInflater == null) &#123;</div><div class="line">            throw new AssertionError(&quot;LayoutInflater not found.&quot;);</div><div class="line">        &#125;</div><div class="line">        return LayoutInflater;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从这里的源码看到获取LayoutInflater实例的另外一种写法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LayoutInflater LayoutInflater =</div><div class="line">                (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</div></pre></td></tr></table></figure>
<p>获取实例之后调用inflate方法，传入xml布局让它帮忙加载，inflate方法如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public View inflate(@LayoutRes int resource, @Nullable ViewGroup root) &#123;</div><div class="line">    return inflate(resource, root, root != null);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>发现该方法会调用包含3个参数的方法，第三个参数的值取决于第二参数root是否为null</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public View inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot) &#123;</div><div class="line">    final Resources res = getContext().getResources();</div><div class="line">    if (DEBUG) &#123;</div><div class="line">        Log.d(TAG, &quot;INFLATING from resource: \&quot;&quot; + res.getResourceName(resource) + &quot;\&quot; (&quot;</div><div class="line">                + Integer.toHexString(resource) + &quot;)&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    final XmlResourceParser parser = res.getLayout(resource);</div><div class="line">    try &#123;</div><div class="line">        return inflate(parser, root, attachToRoot);</div><div class="line">    &#125; finally &#123;</div><div class="line">        parser.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过Resources获取一个XmlResourceParser(LayoutInflater是使用pull解析方式来解析xml)，接着又把第一个参数由int改成XmlResourceParser，继续调用inflate方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">public View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot) &#123;</div><div class="line">    synchronized (mConstructorArgs) &#123;</div><div class="line"></div><div class="line">        final Context inflaterContext = mContext;</div><div class="line">        final AttributeSet attrs = Xml.asAttributeSet(parser);</div><div class="line">        Context lastContext = (Context) mConstructorArgs[0];</div><div class="line">        mConstructorArgs[0] = inflaterContext;</div><div class="line">        //该方法的返回值，初始化为我们传入的第二个参数root</div><div class="line">        View result = root;</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            // Look for the root node.</div><div class="line">            int type;</div><div class="line">            while ((type = parser.next()) != XmlPullParser.START_TAG &amp;&amp;</div><div class="line">                    type != XmlPullParser.END_DOCUMENT) &#123;</div><div class="line">                // Empty</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (type != XmlPullParser.START_TAG) &#123;</div><div class="line">                throw new InflateException(parser.getPositionDescription()</div><div class="line">                        + &quot;: No start tag found!&quot;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            final String name = parser.getName();</div><div class="line"></div><div class="line">            if (TAG_MERGE.equals(name)) &#123;</div><div class="line">            	//如果标签是merge则root不能为空且attachToRoot必须为true，否则会抛异常(merge标签用于xml性能优化)</div><div class="line">                if (root == null || !attachToRoot) &#123;</div><div class="line">                    throw new InflateException(&quot;&lt;merge /&gt; can be used only with a valid &quot;</div><div class="line">                            + &quot;ViewGroup root and attachToRoot=true&quot;);</div><div class="line">                &#125;</div><div class="line">                //遍历加载子元素view</div><div class="line">                rInflate(parser, root, inflaterContext, attrs, false);</div><div class="line">            &#125; else &#123;</div><div class="line">                // Temp is the root view that was found in the xml</div><div class="line">                //根据tag名称生成xml中的root View对象</div><div class="line">                final View temp = createViewFromTag(root, name, inflaterContext, attrs);</div><div class="line"></div><div class="line">                ViewGroup.LayoutParams params = null;</div><div class="line"></div><div class="line">                if (root != null) &#123;</div><div class="line">                    // Create layout params that match root, if supplied</div><div class="line">                    //生成root的LayoutParams</div><div class="line">                    params = root.generateLayoutParams(attrs);</div><div class="line">                    if (!attachToRoot) &#123;</div><div class="line">                        // Set the layout params for temp if we are not</div><div class="line">                        // attaching. (If we are, we use addView, below)</div><div class="line">                        //第三个参数attachToRoot为false时执行View的setLayoutParams</div><div class="line">                        temp.setLayoutParams(params);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                // Inflate all children under temp against its context.</div><div class="line">                //遍历解析temp下的子View</div><div class="line">                rInflateChildren(parser, temp, attrs, true);</div><div class="line"></div><div class="line">                // We are supposed to attach all the views we found (int temp)</div><div class="line">                // to root. Do that now.</div><div class="line">                if (root != null &amp;&amp; attachToRoot) &#123;</div><div class="line">                //第二个参数root非空且第三个参数attachToRoot为true则把xml解析完成的view添加到root中</div><div class="line">                    root.addView(temp, params);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                // Decide whether to return the root that was passed in or the</div><div class="line">                // top view found in xml.</div><div class="line">                if (root == null || !attachToRoot) &#123;</div><div class="line">                    //第二个参数root为空或第三个参数attachToRoot为false时返回xml中解析的root view</div><div class="line">                    result = temp;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125; catch (XmlPullParserException e) &#123;</div><div class="line">            final InflateException ie = new InflateException(e.getMessage(), e);</div><div class="line">            ie.setStackTrace(EMPTY_STACK_TRACE);</div><div class="line">            throw ie;</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            final InflateException ie = new InflateException(parser.getPositionDescription()</div><div class="line">                    + &quot;: &quot; + e.getMessage(), e);</div><div class="line">            ie.setStackTrace(EMPTY_STACK_TRACE);</div><div class="line">            throw ie;</div><div class="line">        &#125; finally &#123;</div><div class="line">            // Don&apos;t retain static reference on context.</div><div class="line">            mConstructorArgs[0] = lastContext;</div><div class="line">            mConstructorArgs[1] = null;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>删掉一些不影响阅读的DEBUG日志后开始分析该方法，在37行传入节点名称通过createViewFromTag方法生成根布局的实例，createViewFromTag()方法内部又会去调用createView()方法，然后通过反射的方式创建出View的实例并返回。根布局解析完成后，55行调用rInflateChildren方法解析根布局下的子View</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">final void rInflateChildren(XmlPullParser parser, View parent, AttributeSet attrs,</div><div class="line">        boolean finishInflate) throws XmlPullParserException, IOException &#123;</div><div class="line">    rInflate(parser, parent, parent.getContext(), attrs, finishInflate);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void rInflate(XmlPullParser parser, View parent, Context context,</div><div class="line">        AttributeSet attrs, boolean finishInflate) throws XmlPullParserException, IOException &#123;</div><div class="line"></div><div class="line">    final int depth = parser.getDepth();</div><div class="line">    int type;</div><div class="line"></div><div class="line">    while (((type = parser.next()) != XmlPullParser.END_TAG ||</div><div class="line">            parser.getDepth() &gt; depth) &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</div><div class="line"></div><div class="line">        if (type != XmlPullParser.START_TAG) &#123;</div><div class="line">            continue;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        final String name = parser.getName();</div><div class="line">        </div><div class="line">        if (TAG_REQUEST_FOCUS.equals(name)) &#123;</div><div class="line">            parseRequestFocus(parser, parent);</div><div class="line">        &#125; else if (TAG_TAG.equals(name)) &#123;</div><div class="line">            parseViewTag(parser, parent, attrs);</div><div class="line">        &#125; else if (TAG_INCLUDE.equals(name)) &#123;</div><div class="line">            if (parser.getDepth() == 0) &#123;</div><div class="line">                throw new InflateException(&quot;&lt;include /&gt; cannot be the root element&quot;);</div><div class="line">            &#125;</div><div class="line">            parseInclude(parser, context, parent, attrs);</div><div class="line">        &#125; else if (TAG_MERGE.equals(name)) &#123;</div><div class="line">            throw new InflateException(&quot;&lt;merge /&gt; must be the root element&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            final View view = createViewFromTag(parent, name, context, attrs);</div><div class="line">            final ViewGroup viewGroup = (ViewGroup) parent;</div><div class="line">            final ViewGroup.LayoutParams params = viewGroup.generateLayoutParams(attrs);</div><div class="line">            rInflateChildren(parser, view, attrs, true);</div><div class="line">            viewGroup.addView(view, params);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (finishInflate) &#123;</div><div class="line">        parent.onFinishInflate();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据不同的tag做不同的解析，如果不是requestFocus 、tag 、include、merge就调用 createViewFromTag()方法，然后循环rInflateChildren()，直到解析出所有View，最后会把最顶层的根布局返回，至此inflate()完成。</p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>源码也看完了，现在回头来看下我们的例子显示的原因。</p>
<p>分析1：position0-2item的布局是一个TextView，inflate方法的第二个参数为null，根据上面的分析，可以简化成下面的代码流程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">final View temp = createViewFromTag(root, name, inflaterContext, attrs)；</div><div class="line">if (root == null || !attachToRoot) &#123;</div><div class="line">    result = temp;</div><div class="line">&#125;</div><div class="line">return result;</div></pre></td></tr></table></figure>
<p>这里temp的LayoutParams并没有实例化，所以为null，因此不管设置宽高为多少都不能正常显示，那为什么它默认显示宽为match_parent呢？<br>ListView extends AbsListView，AbsListView extends AdapterView，在AbsListView 中有这几个方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Get a view and have it show the data associated with the specified</div><div class="line"> * position. This is called when we have already discovered that the view is</div><div class="line"> * not available for reuse in the recycle bin. The only choices left are</div><div class="line"> * converting an old view or making a new one.</div><div class="line"> *</div><div class="line"> * @param position The position to display</div><div class="line"> * @param isScrap Array of at least 1 boolean, the first entry will become true if</div><div class="line"> *                the returned view was taken from the &quot;temporary detached&quot; scrap heap, false if</div><div class="line"> *                otherwise.</div><div class="line"> *</div><div class="line"> * @return A view displaying the data associated with the specified position</div><div class="line"> */</div><div class="line">View obtainView(int position, boolean[] isScrap) &#123;</div><div class="line">    ......</div><div class="line">    setItemViewLayoutParams(child, position);</div><div class="line">    ......</div><div class="line">    return child;</div><div class="line">&#125;</div><div class="line"></div><div class="line">private void setItemViewLayoutParams(View child, int position) &#123;</div><div class="line">    final ViewGroup.LayoutParams vlp = child.getLayoutParams();</div><div class="line">    LayoutParams lp;</div><div class="line">    if (vlp == null) &#123;</div><div class="line">        lp = (LayoutParams) generateDefaultLayoutParams();</div><div class="line">    &#125; else if (!checkLayoutParams(vlp)) &#123;</div><div class="line">        lp = (LayoutParams) generateLayoutParams(vlp);</div><div class="line">    &#125; else &#123;</div><div class="line">        lp = (LayoutParams) vlp;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (mAdapterHasStableIds) &#123;</div><div class="line">        lp.itemId = mAdapter.getItemId(position);</div><div class="line">    &#125;</div><div class="line">    lp.viewType = mAdapter.getItemViewType(position);</div><div class="line">    lp.isEnabled = mAdapter.isEnabled(position);</div><div class="line">    if (lp != vlp) &#123;</div><div class="line">      child.setLayoutParams(lp);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">protected ViewGroup.LayoutParams generateDefaultLayoutParams() &#123;</div><div class="line">    return new AbsListView.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT,</div><div class="line">            ViewGroup.LayoutParams.WRAP_CONTENT, 0);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过这里的代码发现如果Item的layoutParams属性为null，默认为其设置一个宽度为match_parent，高度为wrap_content的layoutParams属性，因此position0-2item显示成那样就说得通了。</p>
<p>分析2：position3item布局是一个TextView，第二个参数root不为null，第三个参数为false，可以简化成下面的代码流程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">final View temp = createViewFromTag(root, name, inflaterContext, attrs);</div><div class="line">ViewGroup.LayoutParams params = null;</div><div class="line">if (root != null) &#123;</div><div class="line">    // Create layout params that match root, if supplied</div><div class="line">    params = root.generateLayoutParams(attrs);</div><div class="line">    if (!attachToRoot) &#123;</div><div class="line">        // Set the layout params for temp if we are not</div><div class="line">        // attaching. (If we are, we use addView, below)</div><div class="line">        temp.setLayoutParams(params);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的root就是ListView，在它的父类AbsListView中找到generateLayoutParams方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">protected ViewGroup.LayoutParams generateLayoutParams(ViewGroup.LayoutParams p) &#123;</div><div class="line">    return new LayoutParams(p);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其实就是对LayoutParams初始化，后面temp再根据这里的LayoutParams加载布局，因此能够正常显示。</p>
<p>分析3：position4-6item由LinearLayout包裹TextView组成，同样第二个参数root为null，与上面0-2item一样，LayoutParams没有实例化，所以最外层的layout_width、layout_height属性失效，但是它内部的TextView的属性是有效的，从图显示也可以看出TextView大小符合我们设置的大小。<br>分析4：position7item由LinearLayout包裹TextView组成，第二个参数root不为null，第三个参数为false，与上面分析2相同，设置了LayoutParams，宽高取决于TextView的layout_width、layout_height大小<br>分析5：打开注释会报错分析，这种情况是第二个参数不为null，第三个参数为true，可以简化成下面的流程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">final View temp = createViewFromTag(root, name, inflaterContext, attrs);</div><div class="line">ViewGroup.LayoutParams params = root.generateLayoutParams(attrs);</div><div class="line">if (root != null &amp;&amp; attachToRoot) &#123;</div><div class="line">    root.addView(temp, params);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的root就是ListView，在它里面没有找到addView方法，再向上找，在AdapterView中的addView方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public void addView(View child, LayoutParams params) &#123;</div><div class="line">    throw new UnsupportedOperationException(&quot;addView(View, LayoutParams) &quot;</div><div class="line">            + &quot;is not supported in AdapterView&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以会报错</p>
<h2 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h2><p>程序中的日志如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">05-17 00:15:55.504 18458 18458 D hcy     : position 0 layoutParams is null</div><div class="line">05-17 00:15:55.516 18458 18458 D hcy     : position 1 layoutParams is null</div><div class="line">05-17 00:15:55.522 18458 18458 D hcy     : position 2 layoutParams is null</div><div class="line">05-17 00:15:55.525 18458 18458 D hcy     : position 3 layoutParams.width is: 263 layoutParams.height is: 131</div><div class="line">05-17 00:15:55.534 18458 18458 D hcy     : position 4 layoutParams is null</div><div class="line">05-17 00:15:55.538 18458 18458 D hcy     : position 5 layoutParams is null</div><div class="line">05-17 00:15:55.542 18458 18458 D hcy     : position 6 layoutParams is null</div><div class="line">05-17 00:15:55.544 18458 18458 D hcy     : position 7 layoutParams.width is: -2 layoutParams.height is: -2</div></pre></td></tr></table></figure>
<p>这也印证了当第二个参数为null时，layoutParams为null，其次item3的宽高根据不同设备显示值也有所不同，最后item7显示-2是几个意思？在ViewGroup中定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public static final int WRAP_CONTENT = -2;</div></pre></td></tr></table></figure>
<h2 id="随便提一下"><a href="#随便提一下" class="headerlink" title="随便提一下"></a>随便提一下</h2><p>在Activity中指定布局文件的时候，最外层的那个布局是可以指定大小的，layout_width和layout_height都是有作用的，根据上一篇的分析知道Android会自动在布局文件的最外层再嵌套一个FrameLayout，代码其实是这样的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mLayoutInflater.inflate(layoutResID, mContentParent);</div></pre></td></tr></table></figure>
<p>这里的mContentParent是FrameLayout不为null，又回到上面的分析，那它为啥不报错呢？<br>在FrameLayout中没找到addView方法，继续向上查找，在它爹ViewGroup中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public void addView(View child) &#123;</div><div class="line">    addView(child, -1);</div><div class="line">&#125;</div><div class="line"></div><div class="line">public void addView(View child, int index) &#123;</div><div class="line">    if (child == null) &#123;</div><div class="line">        throw new IllegalArgumentException(&quot;Cannot add a null child view to a ViewGroup&quot;);</div><div class="line">    &#125;</div><div class="line">    LayoutParams params = child.getLayoutParams();</div><div class="line">    if (params == null) &#123;</div><div class="line">        params = generateDefaultLayoutParams();</div><div class="line">        if (params == null) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;generateDefaultLayoutParams() cannot return null&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    addView(child, index, params);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以不会报错。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>如果root为null，attachToRoot将失去作用，设置任何值都没有意义，加载的布局文件最外层的所有layout属性会失效，由父布局来默认指定.</li>
<li>如果root不为null，未设置attachToRoot，attachToRoot默认为true</li>
<li>如果root不为null，attachToRoot为true，会调用root的addView方法并返回root；attachToRoot为false，则根据传入的root为根标签temp设置LayoutParams并返回temp；</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/16/Android setContentView源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/16/Android setContentView源码分析/" itemprop="url">Android setContentView源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-16T00:00:00+08:00">
                2017-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/16/Android setContentView源码分析/" class="leancloud_visitors" data-flag-title="Android setContentView源码分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>还记得初学Android的时候啥也不做,点击“Run”就可以看到程序跑起来,不一会界面就显示了”Hello World”。作为初学者只记得通过setContentView把布局文件和MainActivity关联起来,而具体是怎样实现的没有深究,后面在平常开发的时候经常会遇到疑问,例如使用hierarchyviewer工具查看布局层级发现在我们指定的布局外又包裹着其他父布局、经常看到其他地方说到PhoneWindow是个什么结构？带着这些疑问从头再跟下源码。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li>Activity、Window、PhoneWindow、DecorView之间的关系</li>
<li>hierarchyviewer布局分析</li>
<li>setContentView方法分析</li>
<li>installDecor方法分析</li>
<li>generateDecor方法分析</li>
<li>generateLayout方法分析</li>
</ul>
<h2 id="hierarchyviewer"><a href="#hierarchyviewer" class="headerlink" title="hierarchyviewer"></a>hierarchyviewer</h2><p>先看下最常见的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends Activity &#123;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;RelativeLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:id=&quot;@+id/activity_main&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:paddingBottom=&quot;@dimen/activity_vertical_margin&quot;</div><div class="line">    android:paddingLeft=&quot;@dimen/activity_horizontal_margin&quot;</div><div class="line">    android:paddingRight=&quot;@dimen/activity_horizontal_margin&quot;</div><div class="line">    android:paddingTop=&quot;@dimen/activity_vertical_margin&quot;</div><div class="line">    tools:context=&quot;com.example.hcy.handlerdemo.MainActivity&quot;&gt;</div><div class="line"></div><div class="line">    &lt;TextView</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;Hello World!&quot; /&gt;</div><div class="line">&lt;/RelativeLayout&gt;</div></pre></td></tr></table></figure>
<p>运行如下</p>
<p>   <img src="http://7xjvg5.com1.z0.glb.clouddn.com/989851-0157baf37c6fa96a.png" style="zoom:25%"></p>
<p>打开SDK中的hierarchyviewer工具查看层级结构如下</p>
<p><a href="http://7xjvg5.com1.z0.glb.clouddn.com/hierarchyviewer.png" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/hierarchyviewer.png" alt="img"></a></p>
<p>可以看到除了最右边的RelativeLayout,外层还包裹了其他的布局,为啥会出现这种情况呢？</p>
<h2 id="setContentView"><a href="#setContentView" class="headerlink" title="setContentView"></a>setContentView</h2><p>在MainActivity中调用setContentView(R.layout.activity_main)，会走到Activity的setContentView方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">源码路径：android-24/android/app/Activity.java</div><div class="line"></div><div class="line">    public void setContentView(@LayoutRes int layoutResID) &#123;</div><div class="line">        getWindow().setContentView(layoutResID);</div><div class="line">        initWindowDecorActionBar();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setContentView(View view) &#123;</div><div class="line">        getWindow().setContentView(view);</div><div class="line">        initWindowDecorActionBar();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setContentView(View view, ViewGroup.LayoutParams params) &#123;</div><div class="line">        getWindow().setContentView(view, params);</div><div class="line">        initWindowDecorActionBar();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>Activity中三个方法都会执行getWindow()的setContentView方法，这里的getWindow()的返回的是Window实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public Window getWindow() &#123;</div><div class="line">    return mWindow;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在Activity的attach方法中实例化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mWindow = new PhoneWindow(this, window);</div></pre></td></tr></table></figure>
<p>查看PhoneWindow中的setContentView方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">源码路径：android-24/com/android/internal/policy/PhoneWindow.java</div><div class="line"></div><div class="line">    public void setContentView(int layoutResID) &#123;</div><div class="line">        // Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window</div><div class="line">        // decor, when theme attributes and the like are crystalized. Do not check the feature</div><div class="line">        // before this happens.</div><div class="line">        if (mContentParent == null) &#123;</div><div class="line">            //第一次调用时mContentParent为null，通过installDecor实例化。</div><div class="line">            installDecor();</div><div class="line">        &#125; else if (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;  //是否设置了窗口过渡标识，默认为false</div><div class="line">            //移除mContentParent中所有的子View</div><div class="line">            mContentParent.removeAllViews();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</div><div class="line">            //设置了窗口过渡标识的情况</div><div class="line">            final Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,</div><div class="line">                    getContext());</div><div class="line">            //使用TransitionManager进行过渡的处理</div><div class="line">            transitionTo(newScene);</div><div class="line">        &#125; else &#123;</div><div class="line">            //不需要过渡时，通过LayoutInflater的inflate将资源文件转换为View树，并添加至mContentParent中</div><div class="line">            mLayoutInflater.inflate(layoutResID, mContentParent);</div><div class="line">        &#125;</div><div class="line">        //请求设置Window内容的属性值，将其写入一个WindowInsets类中</div><div class="line">        mContentParent.requestApplyInsets();</div><div class="line">        final Callback cb = getCallback();</div><div class="line">        if (cb != null &amp;&amp; !isDestroyed()) &#123;</div><div class="line">            cb.onContentChanged();</div><div class="line">        &#125;</div><div class="line">        //已设置content View</div><div class="line">        mContentParentExplicitlySet = true;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>同样PhoneWindow还有另外两个对应Activity中的setContentView方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void setContentView(View view) &#123;</div><div class="line">    setContentView(view, new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line">public void setContentView(View view, ViewGroup.LayoutParams params) &#123;</div><div class="line">    // Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window</div><div class="line">    // decor, when theme attributes and the like are crystalized. Do not check the feature</div><div class="line">    // before this happens.</div><div class="line">    if (mContentParent == null) &#123;</div><div class="line">        installDecor();</div><div class="line">    &#125; else if (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</div><div class="line">        mContentParent.removeAllViews();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</div><div class="line">        view.setLayoutParams(params);</div><div class="line">        final Scene newScene = new Scene(mContentParent, view);</div><div class="line">        transitionTo(newScene);</div><div class="line">    &#125; else &#123;</div><div class="line">        mContentParent.addView(view, params);</div><div class="line">    &#125;</div><div class="line">    mContentParent.requestApplyInsets();</div><div class="line">    final Callback cb = getCallback();</div><div class="line">    if (cb != null &amp;&amp; !isDestroyed()) &#123;</div><div class="line">        cb.onContentChanged();</div><div class="line">    &#125;</div><div class="line">    mContentParentExplicitlySet = true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，当调用 setContentView(View view)时，其内部会调用setContentView(View view, ViewGroup.LayoutParams params)，只是LayoutParams 值为MATCH_PARENT， 与setContentView(int layoutResID)相比，由使用LayoutInflater的inflate解析换成了mContentParent的addView。</p>
<h3 id="小节"><a href="#小节" class="headerlink" title="小节"></a>小节</h3><ul>
<li>如果第一次调用setContentView，执行installDecor()；</li>
<li>如果不是第一次调用setContentView，且未设置窗口过渡标志，调用removeAllViews将窗口中所有子View移除(所以在程序中若多次调用setContentView方法显示界面不会有影响)</li>
<li>如果设置了窗口过渡标志，使用TransitionManager进行过渡的处理，否则选择合适的方式将View添加到mContentParent中</li>
</ul>
<h2 id="installDecor方法分析"><a href="#installDecor方法分析" class="headerlink" title="installDecor方法分析"></a>installDecor方法分析</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div></pre></td><td class="code"><pre><div class="line">源码路径：android-24/com/android/internal/policy/PhoneWindow.java</div><div class="line">   private void installDecor() &#123;</div><div class="line">        mForceDecorInstall = false;</div><div class="line">        if (mDecor == null) &#123;</div><div class="line">            //如果mDecor为null则通过generateDecor初始化</div><div class="line">            mDecor = generateDecor(-1);</div><div class="line">            //设置mDecor中子View焦点获取关系,FOCUS_AFTER_DESCENDANTS指定只有mDecor中所有子View</div><div class="line">            //都不获取焦点时才让mDecor获得焦点</div><div class="line">            mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</div><div class="line">            //设置mDecor为整个Activity窗口的根节点</div><div class="line">            mDecor.setIsRootNamespace(true);</div><div class="line">            if (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != 0) &#123;</div><div class="line">                //将Runnable跑在用户界面线程</div><div class="line">                mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            //mDecor不为null设置当前窗口上下文为PhoneWindow</div><div class="line">            mDecor.setWindow(this);</div><div class="line">        &#125;</div><div class="line">        if (mContentParent == null) &#123;</div><div class="line">            //如果mContentParent为null则通过generateLayout初始化</div><div class="line">            mContentParent = generateLayout(mDecor);</div><div class="line"></div><div class="line">            // Set up decor part of UI to ignore fitsSystemWindows if appropriate.</div><div class="line">            mDecor.makeOptionalFitsSystemWindows();</div><div class="line">            //DecorContentParent位于com.android.internal.widget中，</div><div class="line">            //是一个接口由应用程序窗口的顶层Decor实现，该类主要为mDecor提供了许多标题/窗口装饰功能</div><div class="line">            final DecorContentParent decorContentParent = (DecorContentParent) mDecor.findViewById(</div><div class="line">                    R.id.decor_content_parent);</div><div class="line"></div><div class="line">            if (decorContentParent != null) &#123;</div><div class="line">                mDecorContentParent = decorContentParent;</div><div class="line">                mDecorContentParent.setWindowCallback(getCallback());</div><div class="line">                if (mDecorContentParent.getTitle() == null) &#123;</div><div class="line">                    //设置窗口标题</div><div class="line">                    mDecorContentParent.setWindowTitle(mTitle);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                final int localFeatures = getLocalFeatures();</div><div class="line">                for (int i = 0; i &lt; FEATURE_MAX; i++) &#123;</div><div class="line">                    if ((localFeatures &amp; (1 &lt;&lt; i)) != 0) &#123;</div><div class="line">                        mDecorContentParent.initFeature(i);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                mDecorContentParent.setUiOptions(mUiOptions);</div><div class="line"></div><div class="line">                //mDecorContentParent设置图标和Logo的判断</div><div class="line">                if ((mResourcesSetFlags &amp; FLAG_RESOURCE_SET_ICON) != 0 ||</div><div class="line">                        (mIconRes != 0 &amp;&amp; !mDecorContentParent.hasIcon())) &#123;</div><div class="line">                    mDecorContentParent.setIcon(mIconRes);</div><div class="line">                &#125; else if ((mResourcesSetFlags &amp; FLAG_RESOURCE_SET_ICON) == 0 &amp;&amp;</div><div class="line">                        mIconRes == 0 &amp;&amp; !mDecorContentParent.hasIcon()) &#123;</div><div class="line">                    mDecorContentParent.setIcon(</div><div class="line">                            getContext().getPackageManager().getDefaultActivityIcon());</div><div class="line">                    mResourcesSetFlags |= FLAG_RESOURCE_SET_ICON_FALLBACK;</div><div class="line">                &#125;</div><div class="line">                if ((mResourcesSetFlags &amp; FLAG_RESOURCE_SET_LOGO) != 0 ||</div><div class="line">                        (mLogoRes != 0 &amp;&amp; !mDecorContentParent.hasLogo())) &#123;</div><div class="line">                    mDecorContentParent.setLogo(mLogoRes);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                // Invalidate if the panel menu hasn&apos;t been created before this.</div><div class="line">                // Panel menu invalidation is deferred avoiding application onCreateOptionsMenu</div><div class="line">                // being called in the middle of onCreate or similar.</div><div class="line">                // A pending invalidation will typically be resolved before the posted message</div><div class="line">                // would run normally in order to satisfy instance state restoration.</div><div class="line">                PanelFeatureState st = getPanelState(FEATURE_OPTIONS_PANEL, false);</div><div class="line">                if (!isDestroyed() &amp;&amp; (st == null || st.menu == null) &amp;&amp; !mIsStartingWindow) &#123;</div><div class="line">                    //使面板菜单失效</div><div class="line">                    invalidatePanelMenu(FEATURE_ACTION_BAR);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                //若decorContentParent为null,根据窗口是否为一个包含Title的窗口决定是否显示title</div><div class="line">                //如果窗口包含特征FEATURE_NO_TITLE，则隐藏窗口的title view 否则设置窗口的title</div><div class="line">                mTitleView = (TextView) findViewById(R.id.title);</div><div class="line">                if (mTitleView != null) &#123;</div><div class="line">                    if ((getLocalFeatures() &amp; (1 &lt;&lt; FEATURE_NO_TITLE)) != 0) &#123;</div><div class="line">                        final View titleContainer = findViewById(R.id.title_container);</div><div class="line">                        if (titleContainer != null) &#123;</div><div class="line">                            titleContainer.setVisibility(View.GONE);</div><div class="line">                        &#125; else &#123;</div><div class="line">                            mTitleView.setVisibility(View.GONE);</div><div class="line">                        &#125;</div><div class="line">                        mContentParent.setForeground(null);</div><div class="line">                    &#125; else &#123;</div><div class="line">                        mTitleView.setText(mTitle);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (mDecor.getBackground() == null &amp;&amp; mBackgroundFallbackResource != 0) &#123;</div><div class="line">                //设置背景</div><div class="line">                mDecor.setBackgroundFallback(mBackgroundFallbackResource);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // Only inflate or create a new TransitionManager if the caller hasn&apos;t</div><div class="line">            // already set a custom one.</div><div class="line">            if (hasFeature(FEATURE_ACTIVITY_TRANSITIONS)) &#123;</div><div class="line">                //设置了窗口过渡标识的情况</div><div class="line">                if (mTransitionManager == null) &#123;</div><div class="line">                    //TransitionManager为空的时先初始化</div><div class="line">                    final int transitionRes = getWindowStyle().getResourceId(</div><div class="line">                            R.styleable.Window_windowContentTransitionManager,</div><div class="line">                            0);</div><div class="line">                    if (transitionRes != 0) &#123;</div><div class="line">                        final TransitionInflater inflater = TransitionInflater.from(getContext());</div><div class="line">                        mTransitionManager = inflater.inflateTransitionManager(transitionRes,</div><div class="line">                                mContentParent);</div><div class="line">                    &#125; else &#123;</div><div class="line">                        mTransitionManager = new TransitionManager();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                //实例化各种过渡动画效果、进入、退出。。。</div><div class="line">                mEnterTransition = getTransition(mEnterTransition, null,</div><div class="line">                        R.styleable.Window_windowEnterTransition);</div><div class="line">                mReturnTransition = getTransition(mReturnTransition, USE_DEFAULT_TRANSITION,</div><div class="line">                        R.styleable.Window_windowReturnTransition);</div><div class="line">                mExitTransition = getTransition(mExitTransition, null,</div><div class="line">                        R.styleable.Window_windowExitTransition);</div><div class="line">                mReenterTransition = getTransition(mReenterTransition, USE_DEFAULT_TRANSITION,</div><div class="line">                        R.styleable.Window_windowReenterTransition);</div><div class="line">                mSharedElementEnterTransition = getTransition(mSharedElementEnterTransition, null,</div><div class="line">                        R.styleable.Window_windowSharedElementEnterTransition);</div><div class="line">                mSharedElementReturnTransition = getTransition(mSharedElementReturnTransition,</div><div class="line">                        USE_DEFAULT_TRANSITION,</div><div class="line">                        R.styleable.Window_windowSharedElementReturnTransition);</div><div class="line">                mSharedElementExitTransition = getTransition(mSharedElementExitTransition, null,</div><div class="line">                        R.styleable.Window_windowSharedElementExitTransition);</div><div class="line">                mSharedElementReenterTransition = getTransition(mSharedElementReenterTransition,</div><div class="line">                        USE_DEFAULT_TRANSITION,</div><div class="line">                        R.styleable.Window_windowSharedElementReenterTransition);</div><div class="line">                if (mAllowEnterTransitionOverlap == null) &#123;</div><div class="line">                    //是否允许进入过渡动画重叠</div><div class="line">                    mAllowEnterTransitionOverlap = getWindowStyle().getBoolean(</div><div class="line">                            R.styleable.Window_windowAllowEnterTransitionOverlap, true);</div><div class="line">                &#125;</div><div class="line">                if (mAllowReturnTransitionOverlap == null) &#123;</div><div class="line">                    //是否允许返回过渡动画重叠</div><div class="line">                    mAllowReturnTransitionOverlap = getWindowStyle().getBoolean(</div><div class="line">                            R.styleable.Window_windowAllowReturnTransitionOverlap, true);</div><div class="line">                &#125;</div><div class="line">                if (mBackgroundFadeDurationMillis &lt; 0) &#123;</div><div class="line">                    //背景消失的持续时间</div><div class="line">                    mBackgroundFadeDurationMillis = getWindowStyle().getInteger(</div><div class="line">                            R.styleable.Window_windowTransitionBackgroundFadeDuration,</div><div class="line">                            DEFAULT_BACKGROUND_FADE_DURATION_MS);</div><div class="line">                &#125;</div><div class="line">                if (mSharedElementsUseOverlay == null) &#123;</div><div class="line">                    //另一种过渡效果</div><div class="line">                    mSharedElementsUseOverlay = getWindowStyle().getBoolean(</div><div class="line">                            R.styleable.Window_windowSharedElementsUseOverlay, true);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="generateDecor方法分析"><a href="#generateDecor方法分析" class="headerlink" title="generateDecor方法分析"></a>generateDecor方法分析</h2><p>在installDecor中如果判断为null则通过generateDecor初始化，方法如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">源码路径：android-24/com/android/internal/policy/PhoneWindow.java</div><div class="line">    protected DecorView generateDecor(int featureId) &#123;</div><div class="line">        // System process doesn&apos;t have application context and in that case we need to directly use</div><div class="line">        // the context we have. Otherwise we want the application context, so we don&apos;t cling to the</div><div class="line">        // activity.</div><div class="line">        Context context;</div><div class="line">        if (mUseDecorContext) &#123;</div><div class="line">            Context applicationContext = getContext().getApplicationContext();</div><div class="line">            if (applicationContext == null) &#123;</div><div class="line">                context = getContext();</div><div class="line">            &#125; else &#123;</div><div class="line">                context = new DecorContext(applicationContext, getContext().getResources());</div><div class="line">                if (mTheme != -1) &#123;</div><div class="line">                    context.setTheme(mTheme);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            context = getContext();</div><div class="line">        &#125;</div><div class="line">        return new DecorView(context, featureId, this, getAttributes());</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里根据上下文生成一个DecorView对象，DecorView是PhoneWindow类的内部类，继承自FrameLayout</p>
<h2 id="generateLayout方法分析"><a href="#generateLayout方法分析" class="headerlink" title="generateLayout方法分析"></a>generateLayout方法分析</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div></pre></td><td class="code"><pre><div class="line">protected ViewGroup generateLayout(DecorView decor) &#123;</div><div class="line">    // Apply data from current theme.</div><div class="line">    //从当前Window的Theme中获取一组属性值，赋给a</div><div class="line">    TypedArray a = getWindowStyle();</div><div class="line">    //窗口是否浮动</div><div class="line">    mIsFloating = a.getBoolean(R.styleable.Window_windowIsFloating, false);</div><div class="line">    int flagsToUpdate = (FLAG_LAYOUT_IN_SCREEN|FLAG_LAYOUT_INSET_DECOR)</div><div class="line">            &amp; (~getForcedWindowFlags());</div><div class="line">    if (mIsFloating) &#123;</div><div class="line">        setLayout(WRAP_CONTENT, WRAP_CONTENT);</div><div class="line">        setFlags(0, flagsToUpdate);</div><div class="line">    &#125; else &#123;</div><div class="line">        setFlags(FLAG_LAYOUT_IN_SCREEN|FLAG_LAYOUT_INSET_DECOR, flagsToUpdate);</div><div class="line">    &#125;</div><div class="line">    //窗口是否支持标题栏，隐藏显示标题栏操作在此处。</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowNoTitle, false)) &#123;</div><div class="line">        requestFeature(FEATURE_NO_TITLE);</div><div class="line">    &#125; else if (a.getBoolean(R.styleable.Window_windowActionBar, false)) &#123;</div><div class="line">        // Don&apos;t allow an action bar if there is no title.</div><div class="line">        requestFeature(FEATURE_ACTION_BAR);</div><div class="line">    &#125;</div><div class="line">    //ActionBar导航栏是否不占布局空间叠加显示在当前窗口之上。</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowActionBarOverlay, false)) &#123;</div><div class="line">        requestFeature(FEATURE_ACTION_BAR_OVERLAY);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (a.getBoolean(R.styleable.Window_windowActionModeOverlay, false)) &#123;</div><div class="line">        requestFeature(FEATURE_ACTION_MODE_OVERLAY);</div><div class="line">    &#125;</div><div class="line">    //是否设置从左边滑动消失</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowSwipeToDismiss, false)) &#123;</div><div class="line">        requestFeature(FEATURE_SWIPE_TO_DISMISS);</div><div class="line">    &#125;</div><div class="line">    //当前Activity是否支持全屏</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowFullscreen, false)) &#123;</div><div class="line">        setFlags(FLAG_FULLSCREEN, FLAG_FULLSCREEN &amp; (~getForcedWindowFlags()));</div><div class="line">    &#125;</div><div class="line">    //透明状态栏标志位设置</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowTranslucentStatus,</div><div class="line">            false)) &#123;</div><div class="line">        setFlags(FLAG_TRANSLUCENT_STATUS, FLAG_TRANSLUCENT_STATUS</div><div class="line">                &amp; (~getForcedWindowFlags()));</div><div class="line">    &#125;</div><div class="line">    //透明导航栏标志位设置</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowTranslucentNavigation,</div><div class="line">            false)) &#123;</div><div class="line">        setFlags(FLAG_TRANSLUCENT_NAVIGATION, FLAG_TRANSLUCENT_NAVIGATION</div><div class="line">                &amp; (~getForcedWindowFlags()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (a.getBoolean(R.styleable.Window_windowOverscan, false)) &#123;</div><div class="line">        setFlags(FLAG_LAYOUT_IN_OVERSCAN, FLAG_LAYOUT_IN_OVERSCAN&amp;(~getForcedWindowFlags()));</div><div class="line">    &#125;</div><div class="line">    //是否允许系统壁纸显示在窗口后面</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowShowWallpaper, false)) &#123;</div><div class="line">        setFlags(FLAG_SHOW_WALLPAPER, FLAG_SHOW_WALLPAPER&amp;(~getForcedWindowFlags()));</div><div class="line">    &#125;</div><div class="line">    //窗口触摸事件标志位</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowEnableSplitTouch,</div><div class="line">            getContext().getApplicationInfo().targetSdkVersion</div><div class="line">                    &gt;= android.os.Build.VERSION_CODES.HONEYCOMB)) &#123;</div><div class="line">        setFlags(FLAG_SPLIT_TOUCH, FLAG_SPLIT_TOUCH&amp;(~getForcedWindowFlags()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    a.getValue(R.styleable.Window_windowMinWidthMajor, mMinWidthMajor);</div><div class="line">    a.getValue(R.styleable.Window_windowMinWidthMinor, mMinWidthMinor);</div><div class="line"></div><div class="line">    if (a.hasValue(R.styleable.Window_windowFixedWidthMajor)) &#123;</div><div class="line">        if (mFixedWidthMajor == null) mFixedWidthMajor = new TypedValue();</div><div class="line">        a.getValue(R.styleable.Window_windowFixedWidthMajor,</div><div class="line">                mFixedWidthMajor);</div><div class="line">    &#125;</div><div class="line">    if (a.hasValue(R.styleable.Window_windowFixedWidthMinor)) &#123;</div><div class="line">        if (mFixedWidthMinor == null) mFixedWidthMinor = new TypedValue();</div><div class="line">        a.getValue(R.styleable.Window_windowFixedWidthMinor,</div><div class="line">                mFixedWidthMinor);</div><div class="line">    &#125;</div><div class="line">    if (a.hasValue(R.styleable.Window_windowFixedHeightMajor)) &#123;</div><div class="line">        if (mFixedHeightMajor == null) mFixedHeightMajor = new TypedValue();</div><div class="line">        a.getValue(R.styleable.Window_windowFixedHeightMajor,</div><div class="line">                mFixedHeightMajor);</div><div class="line">    &#125;</div><div class="line">    if (a.hasValue(R.styleable.Window_windowFixedHeightMinor)) &#123;</div><div class="line">        if (mFixedHeightMinor == null) mFixedHeightMinor = new TypedValue();</div><div class="line">        a.getValue(R.styleable.Window_windowFixedHeightMinor,</div><div class="line">                mFixedHeightMinor);</div><div class="line">    &#125;</div><div class="line">    //是否使用窗口过渡动画，使用TransitionManager</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowContentTransitions, false)) &#123;</div><div class="line">        requestFeature(FEATURE_CONTENT_TRANSITIONS);</div><div class="line">    &#125;</div><div class="line">    //是否运行Activity过渡动画</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowActivityTransitions, false)) &#123;</div><div class="line">        requestFeature(FEATURE_ACTIVITY_TRANSITIONS);</div><div class="line">    &#125;</div><div class="line">    //窗口是否透明</div><div class="line">    mIsTranslucent = a.getBoolean(R.styleable.Window_windowIsTranslucent, false);</div><div class="line"></div><div class="line">    final Context context = getContext();</div><div class="line">    //获取当前应用的目标sdk版本号</div><div class="line">    final int targetSdk = context.getApplicationInfo().targetSdkVersion;</div><div class="line">    //当前目标sdk版本号是否小于11</div><div class="line">    final boolean targetPreHoneycomb = targetSdk &lt; android.os.Build.VERSION_CODES.HONEYCOMB;</div><div class="line">    //当前目标sdk版本号是否小于14</div><div class="line">    final boolean targetPreIcs = targetSdk &lt; android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH;</div><div class="line">    //当前目标sdk版本号是否小于21</div><div class="line">    final boolean targetPreL = targetSdk &lt; android.os.Build.VERSION_CODES.LOLLIPOP;</div><div class="line">    //是否需要菜单选项</div><div class="line">    final boolean targetHcNeedsOptions = context.getResources().getBoolean(</div><div class="line">            R.bool.target_honeycomb_needs_options_menu);</div><div class="line">    //是否有ActionBar</div><div class="line">    final boolean noActionBar = !hasFeature(FEATURE_ACTION_BAR) || hasFeature(FEATURE_NO_TITLE);</div><div class="line"></div><div class="line">    if (targetPreHoneycomb || (targetPreIcs &amp;&amp; targetHcNeedsOptions &amp;&amp; noActionBar)) &#123;</div><div class="line">        //目标版本号小于11或者满足小于14且需要菜单选项且无ActionBar，则设置需要菜单选项</div><div class="line">        setNeedsMenuKey(WindowManager.LayoutParams.NEEDS_MENU_SET_TRUE);</div><div class="line">    &#125; else &#123;</div><div class="line">        //设置不需要菜单选项</div><div class="line">        setNeedsMenuKey(WindowManager.LayoutParams.NEEDS_MENU_SET_FALSE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (!mForcedStatusBarColor) &#123;</div><div class="line">        //设置状态栏颜色</div><div class="line">        mStatusBarColor = a.getColor(R.styleable.Window_statusBarColor, 0xFF000000);</div><div class="line">    &#125;</div><div class="line">    if (!mForcedNavigationBarColor) &#123;</div><div class="line">        //设置导航栏颜色</div><div class="line">        mNavigationBarColor = a.getColor(R.styleable.Window_navigationBarColor, 0xFF000000);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    WindowManager.LayoutParams params = getAttributes();</div><div class="line"></div><div class="line">    // Non-floating windows on high end devices must put up decor beneath the system bars and</div><div class="line">    // therefore must know about visibility changes of those.</div><div class="line">    if (!mIsFloating &amp;&amp; ActivityManager.isHighEndGfx()) &#123;</div><div class="line">        if (!targetPreL &amp;&amp; a.getBoolean(</div><div class="line">                R.styleable.Window_windowDrawsSystemBarBackgrounds,</div><div class="line">                false)) &#123;</div><div class="line">            //高版本对System bar的处理</div><div class="line">            setFlags(FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS,</div><div class="line">                    FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS &amp; ~getForcedWindowFlags());</div><div class="line">        &#125;</div><div class="line">        if (mDecor.mForceWindowDrawsStatusBarBackground) &#123;</div><div class="line">            params.privateFlags |= PRIVATE_FLAG_FORCE_DRAW_STATUS_BAR_BACKGROUND;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //是否设置状态栏可见</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowLightStatusBar, false)) &#123;</div><div class="line">        decor.setSystemUiVisibility(</div><div class="line">                decor.getSystemUiVisibility() | View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (mAlwaysReadCloseOnTouchAttr || getContext().getApplicationInfo().targetSdkVersion</div><div class="line">            &gt;= android.os.Build.VERSION_CODES.HONEYCOMB) &#123;</div><div class="line">        if (a.getBoolean(</div><div class="line">                R.styleable.Window_windowCloseOnTouchOutside,</div><div class="line">                false)) &#123;</div><div class="line">            setCloseOnTouchOutsideIfNotSet(true);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">     //设置输入法的状态</div><div class="line">    if (!hasSoftInputMode()) &#123;</div><div class="line">        params.softInputMode = a.getInt(</div><div class="line">                R.styleable.Window_windowSoftInputMode,</div><div class="line">                params.softInputMode);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (a.getBoolean(R.styleable.Window_backgroundDimEnabled,</div><div class="line">            mIsFloating)) &#123;</div><div class="line">        /* All dialogs should have the window dimmed */</div><div class="line">        //dialog出现时窗口状态</div><div class="line">        if ((getForcedWindowFlags()&amp;WindowManager.LayoutParams.FLAG_DIM_BEHIND) == 0) &#123;</div><div class="line">            params.flags |= WindowManager.LayoutParams.FLAG_DIM_BEHIND;</div><div class="line">        &#125;</div><div class="line">        if (!haveDimAmount()) &#123;</div><div class="line">            params.dimAmount = a.getFloat(</div><div class="line">                    android.R.styleable.Window_backgroundDimAmount, 0.5f);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //设置当前Activity的出现动画效果</div><div class="line">    if (params.windowAnimations == 0) &#123;</div><div class="line">        params.windowAnimations = a.getResourceId(</div><div class="line">                R.styleable.Window_windowAnimationStyle, 0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // The rest are only done if this window is not embedded; otherwise,</div><div class="line">    // the values are inherited from our container.</div><div class="line">    if (getContainer() == null) &#123;</div><div class="line">        if (mBackgroundDrawable == null) &#123;</div><div class="line">            if (mBackgroundResource == 0) &#123;</div><div class="line">                mBackgroundResource = a.getResourceId(</div><div class="line">                        R.styleable.Window_windowBackground, 0);</div><div class="line">            &#125;</div><div class="line">            if (mFrameResource == 0) &#123;</div><div class="line">                mFrameResource = a.getResourceId(R.styleable.Window_windowFrame, 0);</div><div class="line">            &#125;</div><div class="line">            mBackgroundFallbackResource = a.getResourceId(</div><div class="line">                    R.styleable.Window_windowBackgroundFallback, 0);</div><div class="line">        &#125;</div><div class="line">        if (mLoadElevation) &#123;</div><div class="line">            mElevation = a.getDimension(R.styleable.Window_windowElevation, 0);</div><div class="line">        &#125;</div><div class="line">        mClipToOutline = a.getBoolean(R.styleable.Window_windowClipToOutline, false);</div><div class="line">        mTextColor = a.getColor(R.styleable.Window_textColor, Color.TRANSPARENT);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Inflate the window decor.</div><div class="line"></div><div class="line">    int layoutResource;</div><div class="line">    //返回一个用于描述当前Window特征的整数值</div><div class="line">    int features = getLocalFeatures();</div><div class="line">    // System.out.println(&quot;Features: 0x&quot; + Integer.toHexString(features));</div><div class="line">    //下面一大段判断根据features值选定窗口资源文件id</div><div class="line">    if ((features &amp; (1 &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != 0) &#123;</div><div class="line">        layoutResource = R.layout.screen_swipe_dismiss;</div><div class="line">    &#125; else if ((features &amp; ((1 &lt;&lt; FEATURE_LEFT_ICON) | (1 &lt;&lt; FEATURE_RIGHT_ICON))) != 0) &#123;</div><div class="line">        if (mIsFloating) &#123;</div><div class="line">            TypedValue res = new TypedValue();</div><div class="line">            getContext().getTheme().resolveAttribute(</div><div class="line">                    R.attr.dialogTitleIconsDecorLayout, res, true);</div><div class="line">            layoutResource = res.resourceId;</div><div class="line">        &#125; else &#123;</div><div class="line">            layoutResource = R.layout.screen_title_icons;</div><div class="line">        &#125;</div><div class="line">        // XXX Remove this once action bar supports these features.</div><div class="line">        removeFeature(FEATURE_ACTION_BAR);</div><div class="line">        // System.out.println(&quot;Title Icons!&quot;);</div><div class="line">    &#125; else if ((features &amp; ((1 &lt;&lt; FEATURE_PROGRESS) | (1 &lt;&lt; FEATURE_INDETERMINATE_PROGRESS))) != 0</div><div class="line">            &amp;&amp; (features &amp; (1 &lt;&lt; FEATURE_ACTION_BAR)) == 0) &#123;</div><div class="line">        // Special case for a window with only a progress bar (and title).</div><div class="line">        // XXX Need to have a no-title version of embedded windows.</div><div class="line">        layoutResource = R.layout.screen_progress;</div><div class="line">        // System.out.println(&quot;Progress!&quot;);</div><div class="line">    &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_CUSTOM_TITLE)) != 0) &#123;</div><div class="line">        // Special case for a window with a custom title.</div><div class="line">        // If the window is floating, we need a dialog layout</div><div class="line">        if (mIsFloating) &#123;</div><div class="line">            TypedValue res = new TypedValue();</div><div class="line">            getContext().getTheme().resolveAttribute(</div><div class="line">                    R.attr.dialogCustomTitleDecorLayout, res, true);</div><div class="line">            layoutResource = res.resourceId;</div><div class="line">        &#125; else &#123;</div><div class="line">            layoutResource = R.layout.screen_custom_title;</div><div class="line">        &#125;</div><div class="line">        // XXX Remove this once action bar supports these features.</div><div class="line">        removeFeature(FEATURE_ACTION_BAR);</div><div class="line">    &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_NO_TITLE)) == 0) &#123;</div><div class="line">        // If no other features and not embedded, only need a title.</div><div class="line">        // If the window is floating, we need a dialog layout</div><div class="line">        if (mIsFloating) &#123;</div><div class="line">            TypedValue res = new TypedValue();</div><div class="line">            getContext().getTheme().resolveAttribute(</div><div class="line">                    R.attr.dialogTitleDecorLayout, res, true);</div><div class="line">            layoutResource = res.resourceId;</div><div class="line">        &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_ACTION_BAR)) != 0) &#123;</div><div class="line">            layoutResource = a.getResourceId(</div><div class="line">                    R.styleable.Window_windowActionBarFullscreenDecorLayout,</div><div class="line">                    R.layout.screen_action_bar);</div><div class="line">        &#125; else &#123;</div><div class="line">            //最常用的Activity窗口修饰布局文件，有title</div><div class="line">            layoutResource = R.layout.screen_title;</div><div class="line">        &#125;</div><div class="line">        // System.out.println(&quot;Title!&quot;);</div><div class="line">    &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_ACTION_MODE_OVERLAY)) != 0) &#123;</div><div class="line">        layoutResource = R.layout.screen_simple_overlay_action_mode;</div><div class="line">    &#125; else &#123;</div><div class="line">        // Embedded, so no decoration is needed.</div><div class="line">        //最简单的Activity窗口修饰布局文件，无title</div><div class="line">        layoutResource = R.layout.screen_simple;</div><div class="line">        // System.out.println(&quot;Simple!&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mDecor.startChanging();</div><div class="line">    //该步骤很重要，将layoutResource资源文件包含的View树添加到decor中</div><div class="line">    mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);</div><div class="line">    //寻找com.android.internal.R.id.content节点</div><div class="line">    ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</div><div class="line">    if (contentParent == null) &#123;</div><div class="line">        throw new RuntimeException(&quot;Window couldn&apos;t find content container view&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if ((features &amp; (1 &lt;&lt; FEATURE_INDETERMINATE_PROGRESS)) != 0) &#123;</div><div class="line">        ProgressBar progress = getCircularProgressBar(false);</div><div class="line">        if (progress != null) &#123;</div><div class="line">            //设置进度条模式为indeterminate，</div><div class="line">            //该模式下进度不显示进度，只显示无限动画</div><div class="line">            progress.setIndeterminate(true);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if ((features &amp; (1 &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != 0) &#123;</div><div class="line">        //对于选择R.layout.screen_swipe_dismiss布局注册回调</div><div class="line">        registerSwipeCallbacks();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Remaining setup -- of background and title -- that only applies</div><div class="line">    // to top-level windows.</div><div class="line">    if (getContainer() == null) &#123;</div><div class="line">        final Drawable background;</div><div class="line">        if (mBackgroundResource != 0) &#123;</div><div class="line">            background = getContext().getDrawable(mBackgroundResource);</div><div class="line">        &#125; else &#123;</div><div class="line">            background = mBackgroundDrawable;</div><div class="line">        &#125;</div><div class="line">        //设置背景</div><div class="line">        mDecor.setWindowBackground(background);</div><div class="line"></div><div class="line">        final Drawable frame;</div><div class="line">        if (mFrameResource != 0) &#123;</div><div class="line">            frame = getContext().getDrawable(mFrameResource);</div><div class="line">        &#125; else &#123;</div><div class="line">            frame = null;</div><div class="line">        &#125;</div><div class="line">        mDecor.setWindowFrame(frame);</div><div class="line"></div><div class="line">        mDecor.setElevation(mElevation);</div><div class="line">        mDecor.setClipToOutline(mClipToOutline);</div><div class="line"></div><div class="line">        if (mTitle != null) &#123;</div><div class="line">            //设置标题</div><div class="line">            setTitle(mTitle);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (mTitleColor == 0) &#123;</div><div class="line">            //设置标题颜色</div><div class="line">            mTitleColor = mTextColor;</div><div class="line">        &#125;</div><div class="line">        setTitleColor(mTitleColor);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mDecor.finishChanging();</div><div class="line"></div><div class="line">    return contentParent;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法代码量较多，主要是做了如下操作：</p>
<ul>
<li>Step1：从第4行到第205行，获取窗口style配置，并根据配置里的值判断是否显示标题栏，是否全屏，是否支持ActionBar浮动，动画效果等等</li>
<li>Step2：从209行到271行，获取窗口的features，根据features值给容器DecorView添加id为layoutResource布局的根布局</li>
<li>Step3：从273行到275行，传入LayoutInflater和指定的布局文件，通过inflate方法将布局文件解析成View，并添加到DecorView根布局当中</li>
<li>Step4：277行，从根布局中查找id为com.android.internal.R.id.content的ViewGroup，也就是整个方法的返回值。</li>
<li>Step5：278-333行，后续一系列操作，包括设置背景，标题，标题颜色等。</li>
</ul>
<p>看下Step2中比较重要的一步操作mDecor.onResourcesLoaded(mLayoutInflater, layoutResource)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">void onResourcesLoaded(LayoutInflater inflater, int layoutResource) &#123;</div><div class="line">        mStackId = getStackId();</div><div class="line"></div><div class="line">        if (mBackdropFrameRenderer != null) &#123;</div><div class="line">            loadBackgroundDrawablesIfNeeded();</div><div class="line">            mBackdropFrameRenderer.onResourcesLoaded(</div><div class="line">                    this, mResizingBackgroundDrawable, mCaptionBackgroundDrawable,</div><div class="line">                    mUserCaptionBackgroundDrawable, getCurrentColor(mStatusColorViewState),</div><div class="line">                    getCurrentColor(mNavigationColorViewState));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mDecorCaptionView = createDecorCaptionView(inflater);</div><div class="line">        final View root = inflater.inflate(layoutResource, null);</div><div class="line">        if (mDecorCaptionView != null) &#123;</div><div class="line">            if (mDecorCaptionView.getParent() == null) &#123;</div><div class="line">                addView(mDecorCaptionView,</div><div class="line">                        new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</div><div class="line">            &#125;</div><div class="line">            mDecorCaptionView.addView(root,</div><div class="line">                    new ViewGroup.MarginLayoutParams(MATCH_PARENT, MATCH_PARENT));</div><div class="line">        &#125; else &#123;</div><div class="line"></div><div class="line">            // Put it below the color views.</div><div class="line">            addView(root, 0, new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</div><div class="line">        &#125;</div><div class="line">        mContentRoot = (ViewGroup) root;</div><div class="line">        initializeElevation();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>12行判断是否是浮动的窗口创建一个mDecorCaptionView ，13行将资源文件解析成View，之后指定布局的宽高为MATCH_PARENT，26行再把View赋给mContentRoot 。接下来，看看 id为layoutResource的布局到底实现了什么？以我们的代码为例，无标题，资源文件为R.layout.screen_simple(源码路径:platforms/android-24/data/res/layout/R.layout.screen_simple)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;!--</div><div class="line">/* //device/apps/common/assets/res/layout/screen_simple.xml</div><div class="line">**</div><div class="line">** Copyright 2006, The Android Open Source Project</div><div class="line">**</div><div class="line">** Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); </div><div class="line">** you may not use this file except in compliance with the License. </div><div class="line">** You may obtain a copy of the License at </div><div class="line">**</div><div class="line">**     http://www.apache.org/licenses/LICENSE-2.0 </div><div class="line">**</div><div class="line">** Unless required by applicable law or agreed to in writing, software </div><div class="line">** distributed under the License is distributed on an &quot;AS IS&quot; BASIS, </div><div class="line">** WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. </div><div class="line">** See the License for the specific language governing permissions and </div><div class="line">** limitations under the License.</div><div class="line">*/</div><div class="line"></div><div class="line">This is an optimized layout for a screen, with the minimum set of features</div><div class="line">enabled.</div><div class="line">--&gt;</div><div class="line"></div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:fitsSystemWindows=&quot;true&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;&gt;</div><div class="line">    &lt;ViewStub android:id=&quot;@+id/action_mode_bar_stub&quot;</div><div class="line">              android:inflatedId=&quot;@+id/action_mode_bar&quot;</div><div class="line">              android:layout=&quot;@layout/action_mode_bar&quot;</div><div class="line">              android:layout_width=&quot;match_parent&quot;</div><div class="line">              android:layout_height=&quot;wrap_content&quot;</div><div class="line">              android:theme=&quot;?attr/actionBarTheme&quot; /&gt;</div><div class="line">    &lt;FrameLayout</div><div class="line">         android:id=&quot;@android:id/content&quot;</div><div class="line">         android:layout_width=&quot;match_parent&quot;</div><div class="line">         android:layout_height=&quot;match_parent&quot;</div><div class="line">         android:foregroundInsidePadding=&quot;false&quot;</div><div class="line">         android:foregroundGravity=&quot;fill_horizontal|top&quot;</div><div class="line">         android:foreground=&quot;?android:attr/windowContentOverlay&quot; /&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<p>结合hierarchyviewer图正好可以对应上面的布局</p>
<p><a href="http://7xjvg5.com1.z0.glb.clouddn.com/hierarchyviewer2.jpg" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/hierarchyviewer2.jpg" alt="img"></a></p>
<p>可以看到，我们啥也不干的情况下在我们的布局外面包裹着另外一层布局，一个LinearLayout包含了ViewStub 和FrameLayout，ViewStub 为懒加载默认不显示，id为content的FrameLayout作为我们布局文件的父布局，上面Step4查找该布局，之后作为整个generateLayout方法的返回值，而这里的mContentParent又在PhoneWindow的setContentView方法中作为布局填充的父容器，伪代码记忆如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public void setContentView(int layoutResID) &#123;</div><div class="line">        ......</div><div class="line">        if (mContentParent == null) &#123;</div><div class="line">            installDecor();</div><div class="line">        &#125;</div><div class="line">        ......</div><div class="line">        mLayoutInflater.inflate(layoutResID, mContentParent); </div><div class="line"></div><div class="line">    &#125;</div><div class="line">   private void installDecor() &#123;</div><div class="line">        ......</div><div class="line">        if (mDecor == null) &#123;</div><div class="line">            mDecor = generateDecor(-1);</div><div class="line">        &#125;</div><div class="line">        if (mContentParent == null) &#123;</div><div class="line">            mContentParent = generateLayout(mDecor);</div><div class="line">            ......</div><div class="line">        &#125;</div><div class="line">        ......</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h2><p>在PhoneWindow的setContentView方法最后会执行回调</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public void setContentView(int layoutResID) &#123;</div><div class="line">       ......</div><div class="line">        final Callback cb = getCallback();</div><div class="line">        if (cb != null &amp;&amp; !isDestroyed()) &#123;</div><div class="line">            cb.onContentChanged();</div><div class="line">        &#125;</div><div class="line">        ......</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里的cb位于Windows.java中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">private Callback mCallback;</div><div class="line"></div><div class="line">public final Callback getCallback() &#123;</div><div class="line">    return mCallback;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public void setCallback(Callback callback) &#123;</div><div class="line">    mCallback = callback;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在Activity的attach方法中看到进行了设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">final void attach(Context context, ActivityThread aThread,</div><div class="line">    ......</div><div class="line">    mWindow.setCallback(this);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>说明Activity中实现了该方法，onContentChanged方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">public void onContentChanged() &#123;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>竟然是个空方法，setContentView走完会执行该方法，因此我们可以把Activity的各种View的findViewById()方法等都可以放到该方法中，系统会帮忙回调。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>创建根视图DecorView对象mDecor</li>
<li>根据程序中选择的Activity的Theme/Style等属性值为窗口添加布局属性和相应的修饰文件</li>
<li>通过findViewById方法获取对应的根布局文件添加到mDecor</li>
<li>通过inflate（加载xml文件）或addView（加载View）方法将Activity的布局文件添加到mContentParent区域(id为content的FrameLayout)</li>
<li>回调Activity的onContentChanged方法</li>
</ul>
<h2 id="关系图"><a href="#关系图" class="headerlink" title="关系图"></a>关系图</h2><p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/relationship.jpg" alt="img"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg"
              alt="HuYounger" />
          
            <p class="site-author-name" itemprop="name">HuYounger</p>
            <p class="site-description motion-element" itemprop="description">Less is more</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Rkhcy" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 &mdash; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HuYounger</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("rcy0CA7vKecGb0eQxcnHdO3i-gzGzoHsz", "N9PBf4dqgEeMJL7klXsAli0a");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
